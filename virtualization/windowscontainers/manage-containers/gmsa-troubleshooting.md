---
title: Устранение неполадок Gmsa для контейнеров Windows
description: Устранение неполадок групповых управляемых учетных записей служб (Gmsa) для контейнеров Windows.
keywords: DOCKER, контейнеры, Active Directory, gmsa, групповая управляемая учетная запись службы, групповые управляемые учетные записи служб, устранение неполадок, устранение неполадок
author: rpsqrd
ms.date: 10/03/2019
ms.topic: article
ms.prod: windows-containers
ms.service: windows-containers
ms.assetid: 9e06ad3a-0783-476b-b85c-faff7234809c
ms.openlocfilehash: 89f255e307c2a48fd743d5abd1a49bba7703aaf3
ms.sourcegitcommit: 1ca9d7562a877c47f227f1a8e6583cb024909749
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/04/2019
ms.locfileid: "74910244"
---
# <a name="troubleshoot-gmsas-for-windows-containers"></a>Устранение неполадок Gmsa для контейнеров Windows

## <a name="known-issues"></a>Известные проблемы

### <a name="container-hostname-must-match-the-gmsa-name-for-windows-server-2016-and-windows-10-versions-1709-and-1803"></a>Имя узла контейнера должно соответствовать имени gMSA для Windows Server 2016 и Windows 10, версии 1709 и 1803

Если вы используете Windows Server 2016 версии 1709 или 1803, имя узла контейнера должно совпадать с именем учетной записи gMSA SAM.

Если имя узла не совпадает с именем gMSA, входящие запросы проверки подлинности NTLM и преобразование имени или идентификатора безопасности (используемое многими библиотеками, такими как поставщик роли членства ASP.NET) завершатся ошибкой. Kerberos продолжит работать в обычном режиме, даже если имена узлов и gMSA не совпадают.

Это ограничение было исправлено в Windows Server 2019, где контейнер теперь всегда будет использовать его имя gMSA в сети независимо от назначенного имени узла.

### <a name="using-a-gmsa-with-more-than-one-container-simultaneously-leads-to-intermittent-failures-on-windows-server-2016-and-windows-10-versions-1709-and-1803"></a>Использование gMSA с более чем одним контейнером одновременно приводит к периодическим сбоям в Windows Server 2016 и Windows 10, версии 1709 и 1803

Поскольку все контейнеры должны использовать одно и то же имя узла, вторая проблема затрагивает версии Windows до Windows Server 2019 и Windows 10, версия 1809. Если нескольким контейнерам назначено одно и то же удостоверение и имя узла, может возникнуть состязание, если два контейнера одновременно говорят на одном контроллере домена. Когда другой контейнер взаимодействует с одним и тем же контроллером домена, он будет отменять связь с любыми из предыдущих контейнеров, использующих такое же удостоверение. Это может привести к неустранимым ошибкам проверки подлинности и иногда может наблюдаться в случае сбоя доверия при выполнении `nltest /sc_verify:contoso.com` внутри контейнера.

Мы изменили поведение в Windows Server 2019, чтобы отделить удостоверение контейнера от имени компьютера, позволяя нескольким контейнерам одновременно использовать один и тот же gMSA.

### <a name="you-cant-use-gmsas-with-hyper-v-isolated-containers-on-windows-10-versions-1703-1709-and-1803"></a>Нельзя использовать Gmsa с изолированными контейнерами Hyper-V в Windows 10 версий 1703, 1709 и 1803

При попытке использовать gMSA с изолированным контейнером Hyper-V в Windows 10 и Windows Server версии 1703, 1709 и 1803 Инициализация контейнера зависает или завершается сбоем.

Эта ошибка была исправлена в Windows Server 2019 и Windows 10, версия 1809. Вы также можете запускать изолированные контейнеры Hyper-V с помощью Gmsa в Windows Server 2016 и Windows 10, версия 1607.

## <a name="general-troubleshooting-guidance"></a>Общие рекомендации по устранению неполадок

Если при выполнении контейнера с gMSA возникают ошибки, приведенные ниже инструкции могут помочь определить основную причину.

### <a name="make-sure-the-host-can-use-the-gmsa"></a>Убедитесь, что узел может использовать gMSA

1. Убедитесь, что узел присоединен к домену и может подключиться к контроллеру домена.
2. Установите средства AD PowerShell из RSAT и запустите [Test-адсервицеаккаунт](https://docs.microsoft.com/powershell/module/activedirectory/test-adserviceaccount) , чтобы узнать, есть ли у компьютера доступ для получения gMSA. Если командлет возвращает **значение false**, компьютер не имеет доступа к паролю gMSA.

    ```powershell
    # To install the AD module on Windows Server, run Install-WindowsFeature RSAT-AD-PowerShell
    # To install the AD module on Windows 10 version 1809 or later, run Add-WindowsCapability -Online -Name 'Rsat.ActiveDirectory.DS-LDS.Tools~~~~0.0.1.0'
    # To install the AD module on older versions of Windows 10, see https://aka.ms/rsat

    Test-ADServiceAccount WebApp01
    ```

3. Если командлет **Test-адсервицеаккаунт** возвращает **значение false**, убедитесь, что узел принадлежит к группе безопасности, которая может получить доступ к паролю gMSA.

    ```powershell
    # Get the current computer's group membership
    Get-ADComputer $env:computername | Get-ADPrincipalGroupMembership | Select-Object DistinguishedName

    # Get the groups allowed to retrieve the gMSA password
    # Change "WebApp01" for your own gMSA name
    (Get-ADServiceAccount WebApp01 -Properties PrincipalsAllowedToRetrieveManagedPassword).PrincipalsAllowedToRetrieveManagedPassword
    ```

4. Если узел принадлежит группе безопасности, авторизованной для получения пароля gMSA, но по-прежнему не работает **Test-адсервицеаккаунт**, может потребоваться перезагрузить компьютер, чтобы получить новый билет, отражающий текущие членства в группах.

#### <a name="check-the-credential-spec-file"></a>Проверка файла спецификации учетных данных

1. Выполните команду **Get-кредентиалспек** из [модуля PowerShell кредентиалспек](https://aka.ms/credspec) , чтобы найти все спецификации учетных данных на компьютере. Спецификации учетных данных должны храниться в каталоге "Кредентиалспекс" в корневом каталоге DOCKER. Корневой каталог DOCKER можно найти, запустив **сведения DOCKER-f "{{. Доккеррутдир}} "** .
2. Откройте файл Кредентиалспек и убедитесь, что следующие поля заполнены правильно:
    - **SID**: идентификатор безопасности учетной записи gMSA
    - **Мачинеаккаунтнаме**: имя учетной записи SAM gMSA (не включайте полное доменное имя или знак доллара)
    - **Днстринаме**: полное доменное имя леса Active Directory
    - **DnsName**: полное доменное имя домена, которому принадлежит gMSA
    - **NetBiosName**: NetBIOS-имя для домена, которому принадлежит gMSA
    - **Граупманажедсервицеаккаунтс/Name**: имя учетной записи SAM gMSA (не включать полное доменное имя или знак доллара)
    - **Граупманажедсервицеаккаунтс/Scope**: одна запись для полного доменного имени домена и одно для NetBIOS

    Ваш ввод должен выглядеть, как в следующем примере полной спецификации учетных данных:

    ```json
    {
        "CmsPlugins": [
            "ActiveDirectory"
        ],
        "DomainJoinConfig": {
            "Sid": "S-1-5-21-702590844-1001920913-2680819671",
            "MachineAccountName": "webapp01",
            "Guid": "56d9b66c-d746-4f87-bd26-26760cfdca2e",
            "DnsTreeName": "contoso.com",
            "DnsName": "contoso.com",
            "NetBiosName": "CONTOSO"
        },
        "ActiveDirectoryConfig": {
            "GroupManagedServiceAccounts": [
                {
                    "Name": "webapp01",
                    "Scope": "contoso.com"
                },
                {
                    "Name": "webapp01",
                    "Scope": "CONTOSO"
                }
            ]
        }
    }
    ```

3. Проверьте правильность пути к файлу спецификации учетных данных для решения оркестрации. Если вы используете DOCKER, убедитесь, что команда запуска контейнера содержит `--security-opt="credentialspec=file://NAME.json"`, где "NAME. JSON" заменяется именем **Get-кредентиалспек**. Имя представляет собой имя неструктурированного файла относительно папки Кредентиалспекс в корневом каталоге DOCKER.

### <a name="check-the-firewall-configuration"></a>Проверка конфигурации брандмауэра

Если вы используете ограниченную политику брандмауэра для сети контейнера или узла, она может блокировать необходимые подключения к контроллеру домен Active Directory или DNS-серверу.

| Протокол и порт | Описание |
|-------------------|---------|
| TCP и UDP 53 | DNS |
| TCP и UDP 88 | Kerberos |
| TCP 139 | NetLogon |
| TCP и UDP 389 | LDAP |
| TCP 636 | LDAP SSL |

Может потребоваться разрешить доступ к дополнительным портам в зависимости от типа трафика, отправляемого контейнером на контроллер домена.
Полный список портов, используемых Active Directory, см. в разделе [требования к портам Active Directory и домен Active Directory Services](https://docs.microsoft.com/previous-versions/windows/it-pro/windows-server-2008-R2-and-2008/dd772723(v=ws.10)#communication-to-domain-controllers) .

### <a name="check-the-container"></a>Проверка контейнера

1. Если вы используете версию Windows до Windows Server 2019 или Windows 10, версия 1809, имя узла контейнера должно совпадать с именем gMSA. Убедитесь, что параметр `--hostname` соответствует краткому имени gMSA (без компонента домена, например "webapp01" вместо "webapp01.contoso.com").

2. Проверьте конфигурацию сети контейнера, чтобы убедиться, что контейнер может разрешить и получить доступ к контроллеру домена для домена gMSA. Неправильно настроенные DNS-серверы в контейнере являются распространенным виновником проблем с удостоверениями.

3. Убедитесь, что контейнер имеет допустимое подключение к домену, выполнив следующий командлет в контейнере (используя `docker exec` или эквивалент):

    ```powershell
    nltest /sc_verify:contoso.com
    ```

    Проверка доверия должна возвращать `NERR_SUCCESS` если gMSA доступен, а сетевое подключение позволяет контейнеру взаимодействовать с доменом. В случае сбоя Проверьте конфигурацию сети узла и контейнера. Обе должны иметь возможность обмениваться данными с контроллером домена.

4. Проверьте, может ли контейнер получить действительный билет на выдачу билета Kerberos (TGT):

    ```powershell
    klist get krbtgt
    ```

    Эта команда должна вернуть "билет на KRBTGT успешно получен" и получить список контроллеров домена, использованных для получения билета. Если вы можете получить TGT, но `nltest` из предыдущего шага завершается сбоем, это может означать, что учетная запись gMSA неправильно настроена. Дополнительные сведения см. [в разделе Проверка учетной записи gMSA](#check-the-gmsa-account) .

    Если вы не можете получить TGT в контейнере, это может означать проблемы с подключением к DNS или сетевому подключению. Убедитесь, что контейнер может разрешить контроллер домена с помощью DNS-имени домена и что контроллер домена поддерживает маршрутизацию из контейнера.

5. Убедитесь, что приложение [настроено для использования gMSA](gmsa-configure-app.md). Учетная запись пользователя в контейнере не изменяется при использовании gMSA. Вместо этого Системная учетная запись использует gMSA, когда он обращается к другим сетевым ресурсам. Это означает, что для использования удостоверения gMSA приложение должно быть запущено как сетевая служба или локальная система.

    > [!TIP]
    > Если вы запускаете `whoami` или используете другое средство для идентификации контекста текущего пользователя в контейнере, вы не увидите само имя gMSA. Это связано с тем, что вы всегда входите в контейнер от имени локального пользователя, а не удостоверения домена. GMSA используется учетной записью компьютера при каждом обращении к сетевым ресурсам, поэтому приложение должно работать как сетевая служба или локальная система.

### <a name="check-the-gmsa-account"></a>Проверка учетной записи gMSA

1. Если контейнер настроен правильно, но пользователям или другим службам не удается автоматически пройти проверку подлинности в контейнерном приложении, проверьте имена участников-служб в учетной записи gMSA. Клиенты будут размещать учетную запись gMSA по имени, в котором они достигают приложения. Это может означать, что вам потребуются дополнительные `host` имена участников-служб для gMSA, если, например, клиенты подключаются к приложению через подсистему балансировки нагрузки или другое имя DNS.

2. Убедитесь, что gMSA и узел контейнера принадлежат одному домену Active Directory. Узел контейнера не сможет получить пароль gMSA, если gMSA принадлежит другому домену.

3. Убедитесь, что в домене есть только одна учетная запись с тем же именем, что и у вашего gMSA. объекты gMSA содержат знаки доллара ($), добавленные к именам учетных записей SAM, поэтому gMSA может называться "myaccount $", а несвязанная учетная запись пользователя — "myaccount" в том же домене. Это может вызвать проблемы, если контроллер домена или приложение должны искать gMSA по имени. Можно выполнить поиск в AD для объектов с одинаковыми именами с помощью следующей команды:

    ```powershell
    # Replace "GMSANAMEHERE" with your gMSA account name (no trailing dollar sign)
    Get-ADObject -Filter 'sAMAccountName -like "GMSANAMEHERE*"'
    ```

4. Если вы включили неограниченное делегирование для учетной записи gMSA, убедитесь, что для [атрибута userAccountControl](https://support.microsoft.com/en-us/help/305144/how-to-use-useraccountcontrol-to-manipulate-user-account-properties) по-прежнему включен флаг `WORKSTATION_TRUST_ACCOUNT`. Этот флаг необходим для сетевого входа в контейнере для взаимодействия с контроллером домена, как в случае, когда приложению требуется разрешить имя в идентификатор безопасности или наоборот. Проверить правильность настройки флага можно с помощью следующих команд:

    ```powershell
    $gMSA = Get-ADServiceAccount -Identity 'yourGmsaName' -Properties UserAccountControl
    ($gMSA.UserAccountControl -band 0x1000) -eq 0x1000
    ```

    Если приведенные выше команды возвращают `False`, используйте следующую команду, чтобы добавить флаг `WORKSTATION_TRUST_ACCOUNT` в свойство UserAccountControl учетной записи gMSA. Эта команда также очистит флаги `NORMAL_ACCOUNT`, `INTERDOMAIN_TRUST_ACCOUNT`и `SERVER_TRUST_ACCOUNT` из свойства UserAccountControl.

    ```powershell
    Set-ADObject -Identity $gMSA -Replace @{ userAccountControl = ($gmsa.userAccountControl -band 0x7FFFC5FF) -bor 0x1000 }
    ```
