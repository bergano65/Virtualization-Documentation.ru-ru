---
title: Устранение неполадок с Гмсас для контейнеров Windows
description: Инструкции по устранению неполадок групповой управляемой учетной записи служб (Гмсас) для контейнеров Windows.
keywords: стыковочный узел, контейнеры, Active Directory, гмса, групповая управляемая учетная запись службы, групповая управляемые учетные записи служб, устранение неполадок, диагностика
author: Heidilohr
ms.date: 09/10/2019
ms.topic: article
ms.prod: windows-containers
ms.service: windows-containers
ms.assetid: 9e06ad3a-0783-476b-b85c-faff7234809c
ms.openlocfilehash: 00a0d9b1367da55b7669fc26a3eca303272967ab
ms.sourcegitcommit: 5d4b6823b82838cb3b574da3cd98315cdbb95ce2
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/11/2019
ms.locfileid: "10079770"
---
# <a name="troubleshoot-gmsas-for-windows-containers"></a>Устранение неполадок с Гмсас для контейнеров Windows

## <a name="known-issues"></a>Известные проблемы

### <a name="container-hostname-must-match-the-gmsa-name-for-windows-server-2016-and-windows-10-versions-1709-and-1803"></a>Имя узла в контейнере должно совпадать с именем Гмса для Windows Server 2016 и Windows 10, версии 1709 и 1803

Если вы используете Windows Server 2016 версии 1709 или 1803, имя узла вашего контейнера должно совпадать с именем учетной записи SAM в Гмса.

Если имя узла не совпадает с именем Гмса, входящий запрос проверки подлинности NTLM и трансляция Name/SID (используемая многими библиотеками, например с поставщиком роли членства ASP.NET) завершатся сбоем. Kerberos продолжает работать в обычном режиме, даже если имя HostName и Гмса не совпадают.

Это ограничение было исправлено в Windows Server 2019, где контейнер будет всегда использовать свое имя Гмса в сети независимо от назначенного имени узла.

### <a name="using-a-gmsa-with-more-than-one-container-simultaneously-leads-to-intermittent-failures-on-windows-server-2016-and-windows-10-versions-1709-and-1803"></a>Использование Гмса с более чем одним контейнером одновременно приводит к периодическим сбоям в Windows Server 2016 и Windows 10, версия 1709 и 1803

Так как все контейнеры должны использовать одно и то же имя узла, вторая проблема повлияет на версии Windows, предшествующие Windows Server 2019 и Windows 10, версия 1809. Если нескольким контейнерам назначаются одинаковые идентификаторы и имена узлов, состояние гонки может возникнуть, если два контейнера одновременно говорят на один контроллер домена. Если другой контейнер взаимодействии с одним и тем же контроллером домена, он будет отменять связь с любыми предыдущими контейнерами с помощью того же удостоверения. Это может привести к неустранимым ошибкам проверки подлинности и иногда может рассматриваться как `nltest /sc_verify:contoso.com` сбой доверия при выполнении внутри контейнера.

Мы изменили поведение в Windows Server 2019, чтобы отделить удостоверение контейнера от имени компьютера, разрешая нескольким контейнерам одновременно использовать один и тот же Гмса.

### <a name="you-cant-use-gmsas-with-hyper-v-isolated-containers-on-windows-10-versions-1703-1709-and-1803"></a>Нельзя использовать Гмсас с изолированными контейнерами Hyper-V в Windows 10 версий 1703, 1709 и 1803

Если при попытке использовать Гмса с изолированным контейнером Hyper-V в Windows 10 и Windows Server версии 1703, 1709 и 1803, Инициализация контейнера перестанет отвечать на запросы и произойдет сбой.

Эта ошибка исправлена в Windows Server 2019 и Windows 10 версии 1809. Вы также можете запускать изолированные контейнеры Hyper-V с Гмсас в Windows Server 2016 и Windows 10 версии 1607.

## <a name="general-troubleshooting-guidance"></a>Общие рекомендации по устранению неполадок

Если при работе с контейнером с помощью Гмса возникают ошибки, эти инструкции могут помочь вам определить основную причину.

### <a name="make-sure-the-host-can-use-the-gmsa"></a>Проверка того, что узел может использовать Гмса

1. Убедитесь, что узел подключен к домену и может подключиться к контроллеру домена.
2. Установите инструменты AD PowerShell из RSAT и запустите [Test-адсервицеаккаунт](https://docs.microsoft.com/powershell/module/activedirectory/test-adserviceaccount) , чтобы убедиться, что у компьютера есть доступ к извлечению гмса. Если командлет возвращает **false**, компьютер не имеет доступа к паролю гмса.

    ```powershell
    # To install the AD module on Windows Server, run Install-WindowsFeature RSAT-AD-PowerShell
    # To install the AD module on Windows 10 version 1809 or later, run Add-WindowsCapability -Online -Name 'Rsat.ActiveDirectory.DS-LDS.Tools~~~~0.0.1.0'
    # To install the AD module on older versions of Windows 10, see https://aka.ms/rsat

    Test-ADServiceAccount WebApp01
    ```

3. Если **Test-адсервицеаккаунт** возвращает **значение false**, убедитесь, что узел принадлежит группе безопасности, которая может получить доступ к паролю гмса.

    ```powershell
    # Get the current computer's group membership
    Get-ADComputer $env:computername | Get-ADPrincipalGroupMembership | Select-Object DistinguishedName

    # Get the groups allowed to retrieve the gMSA password
    # Change "WebApp01" for your own gMSA name
    (Get-ADServiceAccount WebApp01 -Properties PrincipalsAllowedToRetrieveManagedPassword).PrincipalsAllowedToRetrieveManagedPassword
    ```

4. Если ваш узел входит в группу безопасности, которой разрешено извлекать пароль Гмса, но все еще не проходит **тестирование — адсервицеаккаунт**, вам может потребоваться перезагрузить компьютер, чтобы получить новый билет, отражающий текущее участие в группах.

#### <a name="check-the-credential-spec-file"></a>Проверка файла спецификации учетных данных

1. Запустите **Get-кредентиалспек** из [модуля кредентиалспек PowerShell](https://aka.ms/credspec) , чтобы найти все спецификации учетных данных на компьютере. Спецификации учетных данных должны храниться в каталоге "Кредентиалспекс" в корневом каталоге Dock. Корневой каталог Dock можно найти, запустив **сведения о Dock-f "{{. Доккеррутдир}} "**.
2. Откройте файл Кредентиалспек и убедитесь в том, что указанные ниже поля заполнены должным образом.
    - **SID**: SID учетной записи гмса
    - **Мачинеаккаунтнаме**: имя учетной записи SAM гмса (не включать полное доменное имя или знак доллара)
    - **Днстринаме**: полное доменное имя леса Active Directory
    - **DnsName**: полное доменное имя домена, к которому относится гмса
    - **Нетбиоснаме**: NetBIOS-имя для домена, которому принадлежит гмса
    - **Граупманажедсервицеаккаунтс/имя**: имя учетной записи SAM гмса (не включать полное доменное имя или знак доллара)
    - **Граупманажедсервицеаккаунтс/Scope**: одна запись для доменного имени домена, а другая — для NetBIOS

    Введенные данные должны выглядеть так, как показано в приведенном ниже примере полной спецификации учетных данных.

    ```json
    {
        "CmsPlugins": [
            "ActiveDirectory"
        ],
        "DomainJoinConfig": {
            "Sid": "S-1-5-21-702590844-1001920913-2680819671",
            "MachineAccountName": "webapp01",
            "Guid": "56d9b66c-d746-4f87-bd26-26760cfdca2e",
            "DnsTreeName": "contoso.com",
            "DnsName": "contoso.com",
            "NetBiosName": "CONTOSO"
        },
        "ActiveDirectoryConfig": {
            "GroupManagedServiceAccounts": [
                {
                    "Name": "webapp01",
                    "Scope": "contoso.com"
                },
                {
                    "Name": "webapp01",
                    "Scope": "CONTOSO"
                }
            ]
        }
    }
    ```

3. Убедитесь, что путь к файлу спецификации учетных данных правильный для вашего решения для согласования. Если вы используете закрепление, убедитесь, что команда «контейнер выполнения» `--security-opt="credentialspec=file://NAME.json"`содержит, где "Name. JSON" заменяется именем **Get-кредентиалспек**. Имя — это имя плоского файла относительно папки Кредентиалспекс в корневом каталоге Dock.

### <a name="check-the-firewall-configuration"></a>Проверка конфигурации брандмауэра

Если вы используете ограниченную политику брандмауэра для контейнера или сети узла, она может заблокировать необходимые подключения к контроллеру домена Active Directory или DNS-серверу.

| Протокол и порт | Описание |
|-------------------|---------|
| TCP и UDP 53 | DNS |
| TCP и UDP 88 | Kerberos |
| TCP 139 | Служба |
| TCP и UDP 389 | LDAP |
| TCP 636 | LDAP SSL |

Возможно, потребуется разрешить доступ к дополнительным портам в зависимости от типа трафика, отправляемого контейнером на контроллер домена.
Полный список портов, используемых службой каталогов Active Directory, можно найти в разделе [Active Directory и требования к порту доменных служб Active Directory](https://docs.microsoft.com/previous-versions/windows/it-pro/windows-server-2008-R2-and-2008/dd772723(v=ws.10)#communication-to-domain-controllers) .

### <a name="check-the-container"></a>Проверка контейнера

1. Если вы используете версию Windows, предшествующую Windows Server 2019 или Windows 10, версия 1809, имя узла-контейнера должно совпадать с именем Гмса. Убедитесь, `--hostname` что параметр соответствует краткому имени гмса (отсутствует компонент домена, например "webapp01", а не "webapp01.contoso.com").

2. Проверьте конфигурацию сети контейнера, чтобы убедиться в том, что контейнер может разрешать и получать доступ к контроллеру домена Гмса домена. Неправильно настроенные DNS-серверы в контейнере являются типичными причинами проблем с удостоверениями.

3. Убедитесь, что контейнер имеет допустимое подключение к домену, выполнив следующий командлет в контейнере (с `docker exec` помощью или эквивалента).

    ```powershell
    nltest /sc_verify:contoso.com
    ```

    Проверка доверия должна возвращаться `NERR_SUCCESS` в том случае, если доступен гмса и сетевое подключение позволяет контейнеру взаимодействовать с доменом. Если это не удается, проверьте конфигурацию сети для узла и контейнера. Обе возможности должны поддерживать связь с контроллером домена.

4. Убедитесь, что ваше приложение [настроено на использование гмса](gmsa-configure-app.md). При использовании Гмса учетная запись пользователя в контейнере не меняется. Вместо этого Системная учетная запись использует Гмса, когда он обобщается с другими сетевыми ресурсами. Это означает, что ваше приложение должно работать как сетевая служба или локальная система, чтобы использовать удостоверение Гмса.

    > [!TIP]
    > Если вы запустили `whoami` или используете другое средство для идентификации контекста текущего пользователя в контейнере, имя гмса не отображается. Это связано с тем, что вы всегда будете входить в контейнер в качестве локального пользователя, а не с учетной записью домена. Гмса используется учетной записью компьютера при обращении к сетевым ресурсам, поэтому ваше приложение должно работать как сетевая служба или локальная система.

5. Наконец, если контейнер настроен правильно, но пользователи или другие службы не могут автоматически пройти проверку подлинности в вашем контейнерном приложении, проверьте SPN в учетной записи Гмса. Клиенты будут искать учетную запись Гмса по имени, по которому он достиг вашего приложения. Это может означать, что вам понадобятся дополнительные `host` SPN для гмса, если, например, клиенты подключаются к вашему приложению с помощью подсистемы балансировки нагрузки или другого DNS-имени.
