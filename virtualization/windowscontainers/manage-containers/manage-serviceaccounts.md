---
title: Создание Гмсас для контейнеров Windows
description: Инструкции по созданию групповых управляемых учетных записей служб (Гмсас) для контейнеров Windows.
keywords: Dock, Containers, Active Directory, гмса, групповая управляемая учетная запись службы, групповая управляемая учетные записи служб
author: rpsqrd
ms.date: 09/10/2019
ms.topic: article
ms.prod: windows-containers
ms.service: windows-containers
ms.assetid: 9e06ad3a-0783-476b-b85c-faff7234809c
ms.openlocfilehash: 9ed9029e534d56bfe1830281d0bfd3ddde0cee9e
ms.sourcegitcommit: 5d4b6823b82838cb3b574da3cd98315cdbb95ce2
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/11/2019
ms.locfileid: "10079668"
---
# <a name="create-gmsas-for-windows-containers"></a>Создание Гмсас для контейнеров Windows

Для упрощения проверки подлинности и авторизации между пользователями, компьютерами и другими сетевыми ресурсами в сетях на основе Windows обычно используется Active Directory (AD). Разработчики корпоративных приложений часто разрабатывать приложения, которые должны быть интегрированы в AD, и выполняются на серверах, подключенных к домену, чтобы использовать встроенную проверку подлинности Windows, благодаря которой пользователи и другие службы могут автоматически и прозрачно входить в приложение с удостоверениями.

Несмотря на то, что контейнеры Windows не могут быть присоединены к домену, они могут использовать удостоверения домена Active Directory для поддержки различных сценариев проверки подлинности.

Для этого можно настроить контейнер Windows для работы с [учетной записью групповой управляемой службы](https://docs.microsoft.com/windows-server/security/group-managed-service-accounts/group-managed-service-accounts-overview) (гмса), которая представляет собой специальную учетную запись службы, представленную в Windows Server 2012, разработанную для предоставления общего доступа к удостоверению нескольким компьютерам без необходимости чтобы узнать пароль.

При запуске контейнера с помощью Гмса узел-контейнер извлекает пароль Гмса из контроллера домена Active Directory и передает его экземпляру контейнера. Контейнер будет использовать учетные данные Гмса всякий раз, когда учетной записи компьютера (системе) требуется доступ к сетевым ресурсам.

В этой статье объясняется, как приступить к использованию групповых учетных записей служб Active Directory с контейнерами Windows.

## <a name="prerequisites"></a>Что вам понадобится

Для запуска контейнера Windows с учетной записью групповой управляемой службы вам понадобятся указанные ниже возможности.

- Домен Active Directory, имеющий по крайней мере один контроллер домена под управлением Windows Server 2012 или более поздней версии. Для использования Гмсас не существует требований к функциональному уровню леса или домена, но пароли Гмса могут распространяться только контроллерами домена под управлением Windows Server 2012 или более поздней версии. Дополнительные сведения можно найти в разделе [требования к службе каталогов Active Directory для гмсас](https://docs.microsoft.com/windows-server/security/group-managed-service-accounts/getting-started-with-group-managed-service-accounts#BKMK_gMSA_Req).
- Разрешение на создание учетной записи Гмса. Чтобы создать учетную запись Гмса, необходимо быть администратором домена или использовать учетную запись, делегированную разрешение на *Создание объектов msDS-граупманажедсервицеаккаунт* .
- Доступ к Интернету для загрузки модуля PowerShell Кредентиалспек. Если вы работаете в отключенной среде, вы можете [сохранить модуль](https://docs.microsoft.com/powershell/module/powershellget/save-module?view=powershell-5.1) на компьютере с доступом к Интернету и скопировать его на свой компьютер разработки или на узел контейнера.

## <a name="one-time-preparation-of-active-directory"></a>Одноразовая подготовка службы каталогов Active Directory

Если вы еще не создали Гмса в своем домене, вам потребуется создать корневой ключ службы распространения ключей (КДС). КДС отвечает за создание, поворот и освобождение пароля Гмса для авторизованных узлов. Если узлу контейнера требуется использовать Гмса для выполнения контейнера, он будет обращаться к КДС для получения текущего пароля.

Чтобы проверить, был ли уже создан корневой раздел КДС, запустите следующий командлет PowerShell в качестве администратора домена на контроллере домена или в члене домена с установленными средствами AD PowerShell.

```powershell
Get-KdsRootKey
```

Если команда возвращает идентификатор ключа, все готово и можно перейти к разделу [Создание групповой управляемой учетной записи службы](#create-a-group-managed-service-account) . В противном случае продолжите создание корневого ключа КДС.

В рабочей среде или тестовой среде с несколькими контроллерами домена выполните для создания корневого ключа КДС следующий командлет в PowerShell, как администратор домена.

```powershell
# For production environments
Add-KdsRootKey -EffectiveImmediately
```

Несмотря на то, что эта команда предполагает вступление в силу немедленно, необходимо подождать 10 часов, прежде чем будет выполнена репликация корневого ключа КДС и он будет доступен для использования на всех контроллерах домена.

Если в вашем домене только один контроллер домена, вы можете ускорить процесс, установив для ключа силу 10 часов назад.

>[!IMPORTANT]
>Не используйте этот метод в рабочей среде.

```powershell
# For single-DC test environments ONLY
Add-KdsRootKey -EffectiveTime (Get-Date).AddHours(-10)
```

## <a name="create-a-group-managed-service-account"></a>Создание групповой управляемой учетной записи службы

Каждый контейнер, использующий встроенную проверку подлинности Windows, должен иметь хотя бы один Гмса. Основной Гмса используется каждый раз, когда приложения, работающие в качестве системы или сетевые службы, находятся в сети. Имя Гмса будет служить именем контейнера в сети независимо от имени узла, назначенного контейнеру. Кроме того, контейнеры можно настроить с дополнительными Гмсас, если вы хотите запустить службу или приложение в контейнере в качестве другого удостоверения из учетной записи компьютера-контейнера.

Когда вы создаете Гмса, вы также создаете общее удостоверение, которое может использоваться одновременно на многих разных компьютерах. Доступ к паролю Гмса защищен с помощью списка управления доступом Active Directory. Для ограничения доступа к паролю рекомендуется создать группу безопасности для каждой учетной записи Гмса и добавить в группу безопасности нужные узлы контейнера.

Наконец, так как контейнеры не регистрируют имена участников-служб (SPN) автоматически, вам потребуется вручную создать для учетной записи Гмса хотя бы одно из SPN узла.

Обычно Host или HTTP-SPN регистрируются с тем же именем, что и учетная запись Гмса, но вам может потребоваться использовать другое имя службы, если клиенты обращаются к контейнерному приложению за пределами подсистемы балансировки нагрузки или DNS-именем, которое отличается от имени Гмса.

Например, если учетной записи Гмса присвоено значение "WebApp01", но ваши пользователи обращаются к сайту по адресу `mysite.contoso.com`, вы должны зарегистрировать `http/mysite.contoso.com` SPN в учетной записи гмса.

Некоторые приложения могут запрашивать дополнительные SPN для их уникальных протоколов. Например, для сервера SQL Server требуется `MSSQLSvc/hostname` имя участника-службы.

В следующей таблице перечислены обязательные атрибуты для создания Гмса.

|Свойство Гмса | Обязательное значение | Пример. |
|--------------|----------------|--------|
|ФИО | Любое действительное имя учетной записи. | `WebApp01` |
|Атрибуты | Доменное имя, добавляемое к имени учетной записи. | `WebApp01.contoso.com` |
|сервицепринЦипалнамес | Установите по крайней мере имя участника-службы узла, при необходимости добавьте другие протоколы. | `'host/WebApp01', 'host/WebApp01.contoso.com'` |
|принЦипалсалловедторетриевеманажедпассворд | Группа безопасности, содержащая узлы вашего контейнера. | `WebApp01Hosts` |

После того как вы решили имя для вашего Гмса, выполните следующие командлеты в PowerShell, чтобы создать группу безопасности и Гмса.

> [!TIP]
> Вам потребуется использовать учетную запись, которая входит в группу **администраторов домена** , или делегировано разрешение **CREATE msDS-граупманажедсервицеаккаунт** для выполнения следующих команд.
> Командлет [New-адсервицеаккаунт](https://docs.microsoft.com/powershell/module/addsadministration/new-adserviceaccount?view=win10-ps) является частью средств AD PowerShell из [средств удаленного администрирования сервера](https://aka.ms/rsat).

```powershell
# Replace 'WebApp01' and 'contoso.com' with your own gMSA and domain names, respectively

# To install the AD module on Windows Server, run Install-WindowsFeature RSAT-AD-PowerShell
# To install the AD module on Windows 10 version 1809 or later, run Add-WindowsCapability -Online -Name 'Rsat.ActiveDirectory.DS-LDS.Tools~~~~0.0.1.0'
# To install the AD module on older versions of Windows 10, see https://aka.ms/rsat

# Create the security group
New-ADGroup -Name "WebApp01 Authorized Hosts" -SamAccountName "WebApp01Hosts" -GroupScope DomainLocal

# Create the gMSA
New-ADServiceAccount -Name "WebApp01" -DnsHostName "WebApp01.contoso.com" -ServicePrincipalNames "host/WebApp01", "host/WebApp01.contoso.com" -PrincipalsAllowedToRetrieveManagedPassword "WebApp01Hosts"

# Add your container hosts to the security group
Add-ADGroupMember -Identity "WebApp01Hosts" -Members "ContainerHost01", "ContainerHost02", "ContainerHost03"
```

Мы рекомендуем создавать отдельные учетные записи Гмса для разработки, тестирования и рабочих сред.

## <a name="prepare-your-container-host"></a>Подготовка узла контейнера

Каждый узел-контейнер, на котором будет выполняться контейнер Windows с Гмса, должен быть присоединен к домену и иметь доступ к извлечению пароля Гмса.

1. Присоедините компьютер к домену Active Directory.
2. Убедитесь, что ваш узел входит в группу безопасности, управляющую доступом к паролю Гмса.
3. Перезагрузите компьютер, чтобы он получит новое членство в группе.
4. Настройте [классическое приложение Dock для Windows 10](https://docs.docker.com/docker-for-windows/install/) или [Dock для Windows Server](https://docs.docker.com/install/windows/docker-ee/).
5. Рекомендуется Убедитесь, что узел может использовать учетную запись Гмса, выполнив [Test-адсервицеаккаунт](https://docs.microsoft.com/powershell/module/activedirectory/test-adserviceaccount). Если команда возвращает **значение "ложь**", следуйте [инструкциям по устранению неполадок](gmsa-troubleshooting.md#make-sure-the-host-can-use-the-gmsa).

    ```powershell
    # To install the AD module on Windows Server, run Install-WindowsFeature RSAT-AD-PowerShell
    # To install the AD module on Windows 10 version 1809 or later, run Add-WindowsCapability -Online -Name 'Rsat.ActiveDirectory.DS-LDS.Tools~~~~0.0.1.0'
    # To install the AD module on older versions of Windows 10, see https://aka.ms/rsat

    Test-ADServiceAccount WebApp01
    ```

## <a name="create-a-credential-spec"></a>Создание спецификации учетных данных

Файл спецификации учетных данных — это документ JSON, который содержит метаданные о Гмса учетных записях, которые нужно использовать для контейнера. Сохранив конфигурацию идентификации отдельно от изображения контейнера, вы можете изменить, какой Гмса используется в контейнере, просто изменив файл спецификации учетных данных, но не будет никаких изменений в коде.

Файл спецификации учетных данных создается с помощью [модуля PowerShell кредентиалспек](https://aka.ms/credspec) на узле контейнера, присоединенном к домену.
Создав файл, вы можете скопировать его на другие узлы контейнера или в свою контейнерную Orchestrator.
Файл спецификации учетных данных не содержит никаких секретов, например пароль Гмса, так как узел контейнера извлекает Гмса от имени контейнера.

Закрепление ожидает поиска файла спецификации учетных данных в каталоге **кредентиалспекс** в каталоге данных Dock. В процессе установки по умолчанию эта папка находится на веб `C:\ProgramData\Docker\CredentialSpecs`-странице.

Чтобы создать файл спецификации учетных данных на узле контейнера, выполните указанные ниже действия.

1. Установка средств AD PowerShell для RSAT
    - Для Windows Server выполните **установку-WINDOWSFEATURE RSAT-AD-PowerShell**.
    - В Windows 10 версии 1809 или более поздней выполните командлет **Add-виндовскапабилити-Online-Name. ActiveDirectory. DS-LDS. Tools ~ ~ ~ ~ 0.0.1.0 '**.
    - Для более ранних версий Windows 10 вы <https://aka.ms/rsat>видите.
2. Чтобы установить последнюю версию [модуля PowerShell кредентиалспек](https://aka.ms/credspec), выполните следующий командлет:

    ```powershell
    Install-Module CredentialSpec
    ```

    Если у вас нет доступа к Интернету на узле контейнера, выполните `Save-Module CredentialSpec` его на подключенном к Интернету компьютере и скопируйте папку `C:\Program Files\WindowsPowerShell\Modules` модуля в другое место `$env:PSModulePath` на узле-контейнере.

3. Чтобы создать новый файл спецификации учетных данных, выполните следующий командлет:

    ```powershell
    New-CredentialSpec -AccountName WebApp01
    ```

    По умолчанию командлет создаст спецификацию CRED, используя предоставленное имя Гмса в качестве учетной записи компьютера для контейнера. Файл будет сохранен в каталоге Dock Кредентиалспекс с помощью домена Гмса и имени учетной записи для имени файла.

    Вы можете создать спецификацию учетных данных, которая включает дополнительные учетные записи Гмса, если вы используете службу или процесс в качестве дополнительного Гмса в контейнере. Для этого используйте `-AdditionalAccounts` параметр:

    ```powershell
    New-CredentialSpec -AccountName WebApp01 -AdditionalAccounts LogAgentSvc, OtherSvc
    ```

    Полный список поддерживаемых параметров можно выполнить `Get-Help New-CredentialSpec`.

4. Вы можете отобразить список всех спецификаций учетных данных и полный путь к нему с помощью следующего командлета:

    ```powershell
    Get-CredentialSpec
    ```

## <a name="next-steps"></a>Дальнейшие действия

Теперь, когда вы настроили свою учетную запись Гмса, вы можете использовать ее в следующих случаях:

- [Настройка приложений](gmsa-configure-app.md)
- [Работа с контейнерами](gmsa-run-container.md)
- [Контейнеры для оркестрации](gmsa-orchestrate-containers.md)

Если во время установки возникнут проблемы, ознакомьтесь с нашим [руководством по устранению неполадок для поиска](gmsa-troubleshooting.md) возможных решений.

## <a name="additional-resources"></a>Дополнительные ресурсы

- Дополнительные сведения о Гмсас можно найти в разделе [Общие сведения о групповой управляемой учетной записи служб](https://docs.microsoft.com/windows-server/security/group-managed-service-accounts/group-managed-service-accounts-overview).
- Видеоролик — это [Записанный ролик](https://youtu.be/cZHPz80I-3s?t=2672) , который можно посмотреть в Ignite 2016.
