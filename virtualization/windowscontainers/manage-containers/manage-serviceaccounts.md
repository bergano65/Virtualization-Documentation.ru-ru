---
title: Учетные записи служб Active Directory для контейнеров Windows
description: Учетные записи служб Active Directory для контейнеров Windows
keywords: docker, контейнеры, active directory
author: PatrickLang
ms.date: 11/04/2016
ms.topic: article
ms.prod: windows-containers
ms.service: windows-containers
ms.assetid: 9e06ad3a-0783-476b-b85c-faff7234809c
ms.openlocfilehash: d92d14fd10e07e159ff2023b4dd6ade8b11ca2e5
ms.sourcegitcommit: 4090d158dd3573ea90799de5b014c131a206b000
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/07/2018
ms.locfileid: "6121594"
---
# <a name="active-directory-service-accounts-for-windows-containers"></a>Учетные записи служб Active Directory для контейнеров Windows

Пользователям и другим службам могут потребоваться подключения с проверкой подлинности к приложениям и службам, которые защищают данные и предотвращают несанкционированное их использование. Домены Windows Active Directory (AD) имеют встроенную поддержку проверки подлинности с использованием как пароля, так и сертификата. При создании приложения или службы на узле, присоединенном к домену Windows, используется удостоверение узла по умолчанию, если запуск выполняется в качестве Local System или Network Service. В противном случае для проверки подлинности можно настроить другую учетную запись AD.

Несмотря на то что контейнеры Windows невозможно присоединить к домену, они также могут использовать удостоверения домена Active Directory аналогично устройствам, присоединенным к области. В контроллерах домена Windows Server2012 введена новая учетная запись, названная групповой управляемой учетной записью службы (gMSA), которая была разработана для совместного использования службами. При помощи групповых управляемых учетных записей служб (gMSA) сами контейнеры Windows и размещаемые в них службы можно настроить на использование определенных групповых управляемых учетных записей в качестве удостоверения домена. Любая служба, запускаемая как Local System или Network Service, будет использовать удостоверение контейнера Windows так же, как сейчас используется удостоверение узла, присоединенного к домену. В образе контейнера не хранится пароль или закрытый ключ сертификата, чтобы их нельзя было случайно обнаружить. Контейнер можно многократно развертывать для разработки, тестирования и использования в рабочих средах, при этом его не требуется перестраивать и менять хранимые пароли или сертификаты. 


# <a name="glossary--references"></a>Глоссарий и ссылки
- [Active Directory](http://social.technet.microsoft.com/wiki/contents/articles/1026.active-directory-services-overview.aspx)— служба, используемая для обнаружения, поиска и репликации данных об учетных записях пользователей, компьютеров и служб в Windows. 
  - [Доменные службы Active Directory](https://technet.microsoft.com/en-us/library/dd448614.aspx) предоставляют домены Windows Active Directory, используемые для проверки подлинности компьютеров и пользователей. 
  - Устройства _присоединены к домену_, если они являются членами домена Active Directory. Присоединенный к домену— это состояние устройства, которое не только предоставляет устройству удостоверение компьютера домена, но также активирует различные службы, присоединенные к домену.
  - [Групповые управляемые учетные записи службы](https://technet.microsoft.com/en-us/library/jj128431(v=ws.11).aspx), для обозначения которых часто используется аббревиатура gMSA,— это тип учетной записи Active Directory, которая позволяет легко защищать службы при помощи Active Directory без предоставления пароля. Несколько компьютеров или контейнеров могут использовать одну и ту же групповую управляемую учетную запись службы, если необходимо проверить подлинность соединений между службами.
- Модуль _CredentialSpec_ среды PowerShell используется для настройки групповых управляемых учетных записей служб для использования с контейнерами. Модуль скрипта и примеры шагов доступны в [windows-server-container-tools](https://github.com/Microsoft/Virtualization-Documentation/tree/live/windows-server-container-tools) в ServiceAccount.

# <a name="how-it-works"></a>Как это работает

Сейчас групповые управляемые учетные записи служб часто используются для защиты соединений между компьютерами или службами. Ниже перечислены стандартные шаги их использования.

1. Создайте групповую управляемую учетную запись службы.
2. Настройте службу на запуск с использованием групповой управляемой учетной записи службы.
3. Предоставьте присоединенному к домену узлу, на котором выполняется служба, доступ к секретам групповой управляемой учетной записи службы в Active Directory.
4. Разрешите доступ к групповой управляемой учетной записи службы для других служб, например баз данных или общих файловых ресурсов.

При запуске службы присоединенный к домену узел автоматически получает секреты групповой управляемой учетной записи службы из Active Directory и выполняет службу с использованием этой учетной записи. Так как эта служба выполняется как групповая управляемая учетная запись службы, она может получать доступ ко всем ресурсам, доступным последней.

Для контейнеров Windows процесс аналогичен.

1. Создайте групповую управляемую учетную запись службы. По умолчанию это должен сделать администратор домена или оператор учетной записи. В противном случае они могут делегировать права на создание и управление групповыми управляемыми учетными записями служб администраторам, управляющим службами, которые используют эти учетные записи. Вам потребуется по крайней мере один контроллера домена с версией Windows Server 2012 или более поздней в домене, но не требуется использовать определенный уровень функциональности домена. См. статью [Начало работы с групповой управляемой учетной записью службы](https://technet.microsoft.com/en-us/library/jj128431(v=ws.11).aspx).
2. Предоставьте присоединенному к домену узлу контейнера доступ к групповой управляемой учетной записи службы.
3. Разрешите доступ к групповой управляемой учетной записи службы для других служб, например баз данных или общих файловых ресурсов.
4. Используйте модуль CredentialSpec среды PowerShell из [windows-server-container-tools](https://github.com/Microsoft/Virtualization-Documentation/tree/live/windows-server-container-tools) для хранения настроек, необходимых для использования групповой управляемой учетной записи службы.
5. Запустите контейнер при помощи дополнительного параметра. `--security-opt "credentialspec=..."`

> [!NOTE]
> Вам может потребоваться разрешить анонимное преобразование идентификатора безопасности или имени на узле контейнера, как описано [здесь](https://docs.microsoft.com/en-us/windows/device-security/security-policy-settings/network-access-allow-anonymous-sidname-translation), так как в противном случае могут возникнуть ошибки преобразования учетных записей в идентификаторы безопасности.

Тем не менее перед изучением необходимости в разрешении анонимного преобразования идентификатора безопасности в имя убедитесь, что выполнены следующие действия.

1. Имя учетной записи gMSA должно совпадать с именем службы (например, "myapp").
2. Добавьте аргумент -h, чтобы указать имя узла, которое должен использовать контейнер при запуске. 
```
docker run --security-opt "credentialspec=file://myapp.json" -d -p 80:80 -h myapp.mydomain.local <imagename>
```
3. Имя субъекта-службы (SPN) при создании учетной записи gMSA должно совпадать с аргументом -h, который применяется при запуске контейнера. Если вы не добавили имена субъектов-служб в gMSA во время создания, их можно добавить к свойствам учетной записи после.

После запуска контейнера установленные службы, запущенные как Local System или как Network Service, будут выполняться с использованием групповой управляемой учетной записи службы. Это аналогично работе этих учетных записей на присоединенных к домену узлах, за исключением того, что вместо учетной записи компьютера используется групповая управляемая учетная запись службы. 

![Схема— учетные записи служб](media/serviceaccount_diagram.png)


# <a name="example-uses"></a>Примеры использования


## <a name="sql-connection-strings"></a>Строки подключения SQL
Если служба выполняется в контейнере как Local System или Network Service, она может использовать встроенную проверку подлинности Windows для подключения к Microsoft SQL Server.

Пример.

```
Server=sql.contoso.com;Database=MusicStore;Integrated Security=True;MultipleActiveResultSets=True;Connect Timeout=30
```

На Microsoft SQL Server создайте имя для входа с использованием домена и имени групповой управляемой учетной записи службы, после которых указан символ "$". После создания имени для входа его можно назначать пользователям в базе данных и ему можно предоставлять нужные разрешения на доступ.

Пример. 

```sql
CREATE LOGIN "DEMO\WebApplication1$"
    FROM WINDOWS
    WITH DEFAULT_DATABASE = "MusicStore"
GO

USE MusicStore
GO
CREATE USER WebApplication1 FOR LOGIN "DEMO\WebApplication1$"
GO

EXEC sp_addrolemember 'db_datareader', 'WebApplication1'
EXEC sp_addrolemember 'db_datawriter', 'WebApplication1'
```

Чтобы увидеть это в действии, посмотрите [запись демонстрации](https://youtu.be/cZHPz80I-3s?t=2672) с конференции Microsoft Ignite 2016 (сеанс «Путь к контейнеризации — преобразование рабочих нагрузок в контейнеры»).
