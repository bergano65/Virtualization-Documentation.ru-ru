---
title: Хранилище контейнеров Windows Server
description: Методы использования узла и других типов хранилища контейнерами Windows Server
keywords: контейнеры, том, хранилище, подключение, подключение с привязкой
author: patricklang
ms.openlocfilehash: 5f8ff4b25ad4a4c34ed2e28683607cfc02891e1e
ms.sourcegitcommit: 62fff5436770151a28b6fea2be3a8818564f3867
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/24/2019
ms.locfileid: "10147227"
---
# <a name="overview"></a>Обзор

<!-- Great diagram would be great! -->


## <a name="layer-storage"></a>Хранилище уровня

Это все файлы, которые встроены в контейнер. При каждом выполнении операции `docker pull` и `docker run` с контейнером результаты совпадают.


### <a name="where-layers-are-stored-and-how-to-change-it"></a>Где хранятся уровни и как их изменить

При установке по умолчанию уровни хранятся в `C:\ProgramData\docker` и распределяются между каталогами «image» и «windowsfilter». Вы можете изменить место хранения уровней, используя конфигурацию `docker-root`, как показано в документации [по подсистеме Docker в Windows](../manage-docker/configure-docker-daemon.md).

> [!NOTE]
> Для хранилища уровня поддерживается только файловая система NTFS. ReFS не поддерживается.

Вам не следует менять какие-либо файлы в каталогах уровня— они тщательно контролируются с помощью таких команд, как:

- [docker images;](https://docs.docker.com/engine/reference/commandline/images/)
- [docker rmi;](https://docs.docker.com/engine/reference/commandline/rmi/)
- [docker pull;](https://docs.docker.com/engine/reference/commandline/pull/)
- [docker load;](https://docs.docker.com/engine/reference/commandline/load/)
- [docker save.](https://docs.docker.com/engine/reference/commandline/save/)

### <a name="supported-operations-in-layer-storage"></a>Поддерживаемые операции хранилища уровня

Запущенные контейнеры могут использовать большинство операций NTFS, за исключением транзакций. К ним относятся настройка списков управления доступом, при этом все списки проверяются внутри контейнера. Если вы хотите запускать процессы как множество пользователей в контейнере, вы можете создать пользователей в `Dockerfile` с помощью `RUN net user /create ...`, настроить списки управления доступом к файлу, а затем настроить процессы для выполнения с этим пользователем с помощью [директивы Dockerfile USER](https://docs.docker.com/engine/reference/builder/#user).


## <a name="image-size"></a>Размер образа
Обычно приложения для Windows запрашивают объем свободного места на диске перед установкой или созданием новых файлов, а также для удаления временных файлов.  Для обеспечения максимальной совместимости приложений диск C: в контейнере Windows представляет виртуальное свободное пространство размером 20 ГБ.  Некоторым пользователям может потребоваться переопределить это значение по умолчанию и выбрать меньшее или большее значение. Для этого можно использовать параметр «size» в конфигурации «storage-opt».

### <a name="examples"></a>Примеры
Командная строка: `docker run --storage-opt "size=50GB" microsoft/windowsservercore:1709 cmd`

Файл конфигурации Docker
```
"storage-opts": [
    "size=50GB"
  ]
```
> Обратите внимание, что этот способ подходит для команды docker build.
В документе [Настройка docker](https://docs.microsoft.com/virtualization/windowscontainers/manage-docker/configure-docker-daemon#configure-docker-with-configuration-file) представлены дополнительные сведения об изменении файла конфигурации docker.


## <a name="persistent-volumes"></a>Постоянные тома

Постоянное хранилище можно предоставить контейнерам несколькими способами:

- привязки подключений;
- именованные тома.

В документации Docker доступен отличный обзор [использования томов](https://docs.docker.com/engine/admin/volumes/volumes/), так что сначала лучше прочитать его. Остальная часть этого документа посвящена различиям между Linux и Windows и примерам для Windows.


### <a name="bind-mounts"></a>Привязки подключений

[Привязка подключения](https://docs.docker.com/engine/admin/volumes/bind-mounts/) позволяет контейнеру использовать каталог совместно с узлом. Это полезно, если требуется место для хранения файлов на локальном компьютере, которые доступны при перезапуске контейнер, или если необходимо совместно использовать их с несколькими контейнерами. Чтобы запустить контейнер на нескольких компьютерах с доступом к тем же файлам, следует использовать именованный том или SMB-подключение.

#### <a name="permissions"></a>Разрешения

Модель разрешений, используемая для привязки подключений зависит от уровня изоляции контейнера.

Контейнеры, использующие **изоляцию Hyper-V**, в том числе контейнеры Linux в Windows Server версии 1709, используйте простую модель разрешений только для чтения или модель разрешений на чтение и запись.
Доступ к файлам на узле осуществляется с помощью учетной записи `LocalSystem`. Если вам отказано в доступе в контейнере, убедитесь, что у `LocalSystem` есть доступ к каталогу на узле.
Если используется флаг только для чтения, изменения, внесенные на томе внутри контейнера, не будут отображаться или сохраняться для каталога на узле.

Контейнеры Windows Server, использующие **изоляцию процессов**, немного отличаются, поскольку они используют идентификатор процесса в контейнере для доступа к данным (списки управления доступом учитываются).
Идентификатор процесса, выполняемого в контейнере (по умолчанию «ContainerAdministrator» в Windows Server Core и «ContainerUser» в контейнерах Nano Server) будет использоваться для доступа к файлам и каталогам на подключенном томе вместо `LocalSystem`, и ему потребуется предоставить доступ для использования данных.
Так как эти идентификаторы существуют только в контексте контейнера, а не на узле, где хранятся файлы, вам следует использовать известную группу безопасности, например `Authenticated Users`, при настройке списков управления доступом для предоставления доступа к контейнерам.

> [!WARNING]
> Не используйте привязку подключения конфиденциальных каталогов, таких как `C:\`, в недоверенных контейнерах. Это позволит ему изменить файлы на узле, к которым обычно нет доступа, и может создать брешь в системе безопасности.

Пример использования: 

- `docker run -v c:\ContainerData:c:\data:RO` доступ только для чтения;
- `docker run -v c:\ContainerData:c:\data:RW` доступ только для чтения и записи;
- `docker run -v c:\ContainerData:c:\data` доступ только для чтения и записи (по умолчанию).

#### <a name="symlinks"></a>Символические ссылки

Символические ссылки разрешаются в контейнере. При привязке подключения пути узла к контейнеру, который является символической ссылкой или содержит символическую ссылку, у контейнера не будет доступа к этим ресурсам.

#### <a name="smb-mounts"></a>SMB-подключения

В Windows Server версии 1709 доступна новая функция, «Глобальное сопоставление SMB», которая позволяет подключить общую папку SMB на узле, а затем передать каталоги из этой папки в контейнер. Контейнер не требуется настраивать с определенным сервером, общим ресурсом, именем пользователя или паролем— все данные обрабатываются на узле. Контейнер будет работать так же, как если бы он был локальным хранилищем.

##### <a name="configuration-steps"></a>Этапы настройки

1. На узле контейнера выполните глобальную карту удаленного общего доступа к SMB.
    ```
    $creds = Get-Credential
    New-SmbGlobalMapping -RemotePath \\contosofileserver\share1 -Credential $creds -LocalPath G:
    ```
    Эта команда будет использовать учетные данные для проверки подлинности на удаленном сервере SMB. Затем сопоставьте путь к удаленной общей папке с буквой диска G: (или любой другой доступной буквой диска). Контейнеры, созданные на этом узле контейнера, теперь могут сопоставить свои тома данных с путем на диске G:.

    > [!NOTE]
    > При использовании глобального сопоставления SMB для контейнеров все пользователи на узле контейнера могут получить доступ к удаленному общему доступу. Все приложения, работающие на узле контейнера, также получат доступ к сопоставленной удаленной общей папке.

2. Создайте контейнеры с томами данных, сопоставленными с глобально подключенным общим ресурсом SMB: docker run -it --name demo -v g:\ContainerData:G:\AppData1 microsoft/windowsservercore:1709 cmd.exe

    Внутри контейнера папка G:\AppData1 будет сопоставлена с каталогом «ContainerData» удаленной общей папки. Все данные, хранящиеся в глобально сопоставленной удаленной общей папке, будут доступны в приложениях внутри контейнера. Несколько контейнеров могут получить доступ к общим данным для чтения и записи с помощью одной команды.

Такая поддержка глобального сопоставления SMB является клиентской функцией SMB, которая может работать на любом совместимом SMB-сервере, в том числе:

- масштабируемый файловый сервер на базе локальных дисковых пространств (S2D) или традиционного хранилища SAN;
- файлы Azure (общий ресурс SMB);
- традиционный файловый сервер;
- сторонняя реализация протокола SMB (например: устройств NAS).

> [!NOTE]
> Глобальное сопоставление SMB не поддерживает общие папки DFS, DFSN, DFSR в Windows Server версии 1709.

### <a name="named-volumes"></a>Именованные тома

Именованные тома позволяют создать том по имени, назначить его контейнеру и повторно использовать его повторно с тем же именем. Вам не требуется отслеживать фактический путь его создания, а только имя. Подсистема Docker в Windows использует встроенный подключаемый модуль именованных томов, который может создавать тома на локальном компьютере. Если вы хотите использовать именованный тома на нескольких компьютерах, дополнительные подключаемый модуль не требуется.

Примеры:

1. `docker volume create unwound` - Создание тома с именем «unwound».
2. `docker run -v unwound:c:\data microsoft/windowsservercore` - Запуск контейнера с томом, сопоставленным с каталогом c:\data.
3. Запись некоторых файлов в каталог c:\data в контейнере, а затем остановка работы контейнера.
4. `docker run -v unwound:c:\data microsoft/windowsservercore` - Запуск нового контейнера.
5. Выполнение `dir c:\data` в новом контейнере—- файлы по-прежнему там.

> [!NOTE]
> Windows Server преобразует целевые пути (путь внутри контейнера) в «строчные», в противном случае — прописные. i. e. `-v unwound:c:\MyData`или `-v unwound:/app/MyData` в контейнерах Linux может привести к тому, что каталог будет находиться в `c:\mydata`контейнере `/app/mydata` или в контейнерах Linux, сопоставленных (и создаваемых, если она не существует).
