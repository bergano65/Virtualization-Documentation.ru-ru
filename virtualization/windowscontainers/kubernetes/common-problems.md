---
title: Устранение неполадок Kubernetes
author: gkudra-msft
ms.author: gekudray
ms.date: 11/02/2018
ms.topic: troubleshooting
ms.prod: containers
description: Решения распространенных проблем при развертывании Kubernetes и присоединении узлов Windows.
keywords: кубернетес, 1,14, Linux, компиляция
ms.openlocfilehash: 471731ec50c7c03816a956bd7aae859ad218be6d
ms.sourcegitcommit: 1ca9d7562a877c47f227f1a8e6583cb024909749
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/03/2019
ms.locfileid: "10332365"
---
# Устранение неполадок Kubernetes #
На этой странице описано несколько распространенных проблем, связанных с установкой, сетями и развертываниями Kubernetes.

> [!tip]
> Предложите свой вопрос, создав заявку в [нашем репозитории документации](https://github.com/MicrosoftDocs/Virtualization-Documentation/).

На этой странице выделяются следующие категории:
1. [Общие вопросы](#general-questions)
2. [Общие сетевые ошибки](#common-networking-errors)
3. [Общие ошибки Windows](#common-windows-errors)
4. [Распространенные основные ошибки Кубернетес](#common-kubernetes-master-errors)

## Общие вопросы ##

### Как узнать, что Start. ps1 в Windows успешно завершено? ###
Вы должны увидеть кубелет, Кубе-proxy и (если вы выбрали Фланнел как сетевое решение), фланнелд на своем узле запущенные процессы агента узла, в котором журналы отображаются в разных окнах ПОШ. Помимо этого, ваш узел Windows должен быть указан в списке "Готово" в кластере Кубернетес.

### Можно ли настроить для запуска всего этого элемента в фоновом режиме, а не ПОШ Windows? ###
Начиная с Кубернетес версии 1,11, кубелет & Кубе-proxy можно запускать как собственные [службы Windows](https://kubernetes.io/docs/getting-started-guides/windows/#kubelet-and-kube-proxy-can-now-run-as-windows-services). Вы также можете использовать альтернативные Диспетчеры служб, такие как [НССМ. exe](https://nssm.cc/) , чтобы всегда запускать эти процессы (фланнелд, кубелет & Кубе-proxy) в фоновом режиме. Ниже приведены примеры действий [на Кубернетес службах Windows](./kube-windows-services.md) .

### У меня проблемы с Кубернетес процессами в качестве служб Windows ###
Для первоначального устранения неполадок вы можете переадресовать stdout и stderr в выходной файл с помощью следующих флагов в [НССМ. exe](https://nssm.cc/) :
```
nssm set <Service Name> AppStdout C:\k\mysvc.log
nssm set <Service Name> AppStderr C:\k\mysvc.log
```
Дополнительные сведения можно найти в разделе официальные документы [об использовании НССМ](https://nssm.cc/usage) .

## Общие сетевые ошибки ##

### Подсистема балансировки нагрузки несогласованно подключены на узлах кластера ###
В Windows Кубе-proxy создает подсистему балансировки службы HNS для каждой службы Кубернетес в кластере. В конфигурации (по умолчанию) Кубе-прокси, узлы в кластерах с большим количеством (обычно 100 +) подсистем балансировки нагрузки могут работать за пределами доступных временных TCP-портов. динамический диапазон портов, который по умолчанию охватывает порты 49152 – 65535. Это связано с тем, что в каждом узле имеется большое количество портов, зарезервированных для каждого из подсистемы балансировки нагрузки (кроме DSR). Эта проблема может проявляться с ошибками в Кубе-прокси, например:
```
Policy creation failed: hcnCreateLoadBalancer failed in Win32: The specified port already exists.
```

Пользователи могут определить эту ошибку, выполнив сценарий [коллектлогс. ps1](https://github.com/microsoft/SDN/blob/master/Kubernetes/windows/debug/collectlogs.ps1) и консультации `*portrange.txt` файлов.

Кроме `CollectLogs.ps1` того, с помощью логики распределения для проверки доступности пула портов в диапазоне временных портов TCP и отчета об успешном и неудачных `reservedports.txt`попытках проверяются возможности выделения ресурсов в службе HNS. Сценарий резервирует 10 64 диапазонов (для эмуляции поведения службе HNS), что резервирование счетчиков завершает & сбои, а затем освобождает выделенные диапазоны портов. Номер успеха, меньший 10, указывает на то, что для эфемерного пула не хватает свободного места. Кроме того, в этом случае будет создаваться сокращенная сводка количества резервирований портов в `reservedports.txt`64, которые доступны для всех.

Чтобы устранить эту проблему, можно выполнить несколько действий.
1.  Для постоянного решения Кубе для балансировки нагрузки прокси-сервера должен быть установлен [режим DSR](https://techcommunity.microsoft.com/t5/Networking-Blog/Direct-Server-Return-DSR-in-a-nutshell/ba-p/693710). Режим DSR полностью реализован и доступен в новейшей версии [Windows Server Insider build 18945](https://blogs.windows.com/windowsexperience/2019/07/30/announcing-windows-server-vnext-insider-preview-build-18945/#o1bs7T2DGPFpf7HM.97) (или более поздней версии).
2. В качестве обходного пути пользователи могут также увеличивать конфигурацию Windows по умолчанию для временных портов, доступ к которым можно `netsh int ipv4 set dynamicportrange TCP <start_port> <port_count>`получить с помощью таких команд, как. *Предупреждение:* Переопределение диапазона динамических портов по умолчанию может повлиять на другие процессы и службы на узле, которые используют доступные TCP-порты из невременных диапазонов, поэтому этот диапазон следует выбирать с осторожностью.
3. Для подсистемы балансировки нагрузки с использованием пула интеллектуальных портов, которые планируется выпустить с помощью обобщенного обновления в Q1 2020, существует Улучшенная масштабируемость.

### Публикация Хостпорт не работает ###
Сейчас невозможно опубликовать порты с помощью поля Кубернетес `containers.ports.hostPort` , так как это поле не соблюдается подключаемыми модулями Windows CNI. Используйте публикацию Нодепорт, чтобы время публикации портов на узле.

### Я вижу ошибки, например "Хнскалл", не удалось найти в Win32 неправильной диск. ###
Эта ошибка может возникать при внесении настраиваемых изменений в объекты HNS или установке нового обновления Windows, которое вносит изменения в службе HNS без разрыва старых объектов HNS. Оно указывает на то, что объект HNS, который был ранее создан перед обновлением, несовместим с текущей установленной версией службе HNS.

В Windows Server 2019 (и более ранних версий) пользователи могут удалять объекты службе HNS, удаляя файл службе HNS. Data. 
```
Stop-Service HNS
rm C:\ProgramData\Microsoft\Windows\HNS\HNS.data
Start-Service HNS
```

Пользователи должны прямо удалять любые несовместимые конечные точки и сети службы HNS.
```
hnsdiag list endpoints
hnsdiag delete endpoints <id>
hnsdiag list networks 
hnsdiag delete networks <id>
Restart-Service HNS
```

Пользователи Windows Server версии 1903 могут перейти к следующему разделу реестра и удалить все сетевые платы, начиная с сетевого имени (например, `vxlan0` или `cbr0`):
```
\\Computer\HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\vmsmp\parameters\NicList
```

### Контейнеры на моем Фланнел Host-GW развертывания в Azure не могут получить доступ к Интернету ###
При развертывании Фланнел в режиме host-GW в Azure пакеты должны пройти по физическому узлу на vSwitch. Пользователи должны программировать пользовательские [маршруты](https://docs.microsoft.com/en-us/azure/virtual-network/virtual-networks-udr-overview#user-defined) типа "виртуальное устройство" для каждой подсети, назначенной узлу. Это можно сделать на портале Azure (например, в [этом](https://docs.microsoft.com/en-us/azure/virtual-network/tutorial-create-route-table-portal)разделе) или с `az` помощью службы Azure CLI. Ниже приведен пример УДР с именем "Мирауте" с помощью команд AZ для узла с IP-10.0.0.4 и соответствующей подсетью Pod 10.244.0.0/24:
```
az network route-table create --resource-group <my_resource_group> --name BridgeRoute 
az network route-table route create  --resource-group <my_resource_group> --address-prefix 10.244.0.0/24 --route-table-name BridgeRoute  --name MyRoute --next-hop-type VirtualAppliance --next-hop-ip-address 10.0.0.4 
```

>[!TIP]
> Если вы разворачиваете Кубернетес на виртуальных машинах Azure или IaaS из других поставщиков облачных служб самостоятельно, вы также можете использовать [наложение сетей](./network-topologies.md#flannel-in-vxlan-mode) .

### Не удается проверить связь с внешними ресурсами в Windows. ###
В Windows не установлены правила исходящих сообщений, запрограммированные для протокола ICMP уже сегодня. Тем не менее, TCP/UDP поддерживается. При попытке продемонстрировать подключение к ресурсам за пределами кластера, подставьте `ping <IP>` соответствующие `curl <IP>` команды.

Если вы по-прежнему столкнулись с проблемами, скорее всего, ваша сетевая конфигурация в [CNI. conf](https://github.com/Microsoft/SDN/blob/master/Kubernetes/flannel/l2bridge/cni/config/cni.conf) заслуживает некоторых дополнительных внимания. Вы всегда можете изменить этот статический файл, конфигурация будет применена ко всем вновь созданным ресурсам Кубернетес.

Почему?
Один из требований к сети Кубернетес (см. [модель кубернетес](https://kubernetes.io/docs/concepts/cluster-administration/networking/)) предназначен для того, чтобы взаимодействие с кластером происходило без внутренних NAT. Для соблюдения этого требования у нас есть [список исключений](https://github.com/Microsoft/SDN/blob/master/Kubernetes/flannel/l2bridge/cni/config/cni.conf#L20) для всех сообщений, в которых не требуется исходящий NAT. Однако это также означает, что вы должны исключить внешний IP-адрес, который вы пытаетесь запросить из список исключений. Только после этого трафик, исходящий из ваших модулей Windows, будет Снат'ед правильно, чтобы получить ответ из внешнего мира. В связи с этим список исключений в `cni.conf` этом случае должен выглядеть следующим образом:
```conf
"ExceptionList": [
  "10.244.0.0/16",  # Cluster subnet
  "10.96.0.0/12",   # Service subnet
  "10.127.130.0/24" # Management (host) subnet
]
```

### Узлу Windows не удается получить доступ к службе Нодепорт ###
Локальный доступ Нодепорт к самому узлу может завершиться сбоем. Корпорации Майкрософт известно об этом ограничении. Нодепорт Access будет работать с другими узлами или внешними клиентами.

### В течение некоторого времени конечные точки Вникс и службе HNS для контейнеров удаляются ###
Эта проблема может возникать, если `hostname-override` параметр не передается в [Кубе-proxy](https://kubernetes.io/docs/reference/command-line-tools-reference/kube-proxy/). Чтобы устранить эту проблему, пользователям необходимо передать имя узла в Кубе-proxy, как описано ниже.
```
C:\k\kube-proxy.exe --hostname-override=$(hostname)
```

### В режиме Фланнел (вкслан) после повторного присоединения к узлу не удается установить связь между ними. ###
Всякий раз, когда удаленный узел присоединяется к кластеру, Фланнелд попытается назначить узлу новую подсеть Pod. Пользователи должны удалить старые файлы конфигурации подсети Pod по следующим путям:
```powershell
Remove-Item C:\k\SourceVip.json
Remove-Item C:\k\SourceVipRequest.json
```

### После запуска Start. ps1 Фланнелд задерживается в разделе ожидание создания сети. ###
Существует множество отчетов об этой ошибке, которые изучаются. скорее всего, это проблема синхронизации при установке IP-адреса управления фланнел сети. Чтобы устранить проблему, просто запустите файл Start. ps1 или перезапустите его вручную, как описано ниже.
```
PS C:> [Environment]::SetEnvironmentVariable("NODE_NAME", "<Windows_Worker_Hostname>")
PS C:> C:\flannel\flanneld.exe --kubeconfig-file=c:\k\config --iface=<Windows_Worker_Node_IP> --ip-masq=1 --kube-subnet-mgr=1
```

Кроме того, в настоящее время есть [Цена](https://github.com/coreos/flannel/pull/1042) , которая решает эту ошибку в разделе "Рецензирование".


### Не удается запустить мой набор Windows/рун/фланнел/субнет.ЕНВ из-за отсутствия ###
Это говорит о том, что Фланнел не был запущен должным образом. Вы можете либо попытаться перезапустить фланнелд. exe, либо скопировать файлы вручную с сайта `/run/flannel/subnet.env` кубернетес `C:\run\flannel\subnet.env` на узел рабочего процесса Windows и изменить `FLANNEL_SUBNET` строку на назначенную подсеть. Например, если вы назначили 10.244.4.1/24 подсети узла:
```
FLANNEL_NETWORK=10.244.0.0/16
FLANNEL_SUBNET=10.244.4.1/24
FLANNEL_MTU=1500
FLANNEL_IPMASQ=true
```
Лучше позволить фланнелд. exe создавать этот файл.


### Связь между узлами из модуля "модуль-приложение" в Кубернетес кластере, работающем на всфере, не работает 
Так как оба всфере и Фланнел резервирует порт 4789 (порт по умолчанию для ВКСЛАН) для сетей с наложением, пакеты могут быть перехвачены. Если всфере используется для наложения сети, он должен быть настроен на использование другого порта, чтобы освободить 4789.  


### Утечки конечных точек и IP-адресов ###
Существуют две известные проблемы, которые могут привести к утечке конечных точек. 
1.  Первая [известная проблема](https://github.com/kubernetes/kubernetes/issues/68511) является проблемой в кубернетес версии 1,11. Не используйте Кубернетес версии 1.11.0-1.11.2.
2. Вторая [известная проблема](https://github.com/docker/libnetwork/issues/1950) , из-за которой могут быть обнаружены конечные точки, — это проблема параллелизма в хранилище конечных точек. Для получения исправления необходимо использовать Dock EE 18,09 или более поздней версии.

### Не удается запустить мои обыкновенные ресурсы из-за ошибок "Сеть: сбой выделения для диапазона" ###
Это означает, что используется пространство IP-адресов на вашем узле. Чтобы очистить все [потерянные конечные точки](#my-endpointsips-are-leaking), перенесите ресурсы на затронутые узлы & выполните указанные ниже команды.
```
c:\k\stop.ps1
Get-HNSEndpoint | Remove-HNSEndpoint
Remove-Item -Recurse c:\var
```

### Узел Windows не может получить доступ к службам с помощью IP-адреса служб ###
Это известное ограничение текущего сетевого стека для Windows. Тем *не менее* **, Windows, возможно,** сможет получить доступ к IP-адресу службы.

### При запуске Kubelet не удается найти ни один сетевой адаптер ###
Сетевому стеку Windows требуется виртуальный адаптер, чтобы сеть Kubernetes работала. Если следующие команды не дают результатов (в оболочке администратора), создание виртуальной сети&mdash; необходимое условие для работы Kubelet &mdash; завершилось ошибкой:

```powershell
Get-HnsNetwork | ? Name -ieq "cbr0"
Get-NetAdapter | ? Name -Like "vEthernet (Ethernet*"
```

Часто важно изменить параметр [интерфаценаме](https://github.com/Microsoft/SDN/blob/master/Kubernetes/flannel/l2bridge/start.ps1#L6) для сценария Start. ps1 в тех случаях, когда сетевой адаптер хоста не является "Ethernet". В противном случае ознакомьтесь с результатами `start-kubelet.ps1` сценария, чтобы убедиться, что при создании виртуальной сети возникли ошибки. 

### Модули pod через некоторое время перестают успешно сопоставлять запросы DNS ###
Существует известная ошибка кэширования DNS в сетевом стеке Windows Server, версия 1803 и более ранние версии, которые иногда могут привести к сбою DNS-запросов. Для решения этой проблемы можно установить для параметра "максимальное количество значений кэша TTL" значение ноль с помощью следующих разделов реестра:

```Dockerfile
FROM microsoft/windowsservercore:<your-build>
SHELL ["powershell', "-Command", "$ErrorActionPreference = 'Stop';"]
New-ItemProperty -Path 'HKLM:\SYSTEM\CurrentControlSet\Services\Dnscache\Parameters' -Name MaxCacheTtl -Value 0 -Type DWord 
New-ItemPropery -Path 'HKLM:\SYSTEM\CurrentControlSet\Services\Dnscache\Parameters' -Name MaxNegativeCacheTtl -Value 0 -Type DWord
```

### Я по-прежнему вижу проблемы. Что мне делать? ### 
Могут существовать дополнительные ограничения в сети или на узлах, предотвращающие определенные виды взаимодействия между узлами. Убедитесь, что:
  - Вы правильно настроили выбранную [топологию сети](./network-topologies.md)
  - трафик, поступающий от модулей pod, разрешен;
  - HTTP-трафик разрешен, если вы развертываете веб-службы;
  - Пакеты с разными протоколами (IE ICMP и TCP/UDP) не отбрасываются

>[!TIP]
> Дополнительные ресурсы для самостоятельной справки также можно [найти](https://techcommunity.microsoft.com/t5/Networking-Blog/Troubleshooting-Kubernetes-Networking-on-Windows-Part-1/ba-p/508648)в руководстве по устранению неполадок Кубернетес для Windows.

## Общие ошибки Windows ##

### Мои модули Kubernetes остаются в состоянии "ContainerCreating" ###
Эта проблема может быть вызвана множеством причин, однако самая распространенная из них— неправильная настройка образа "Пауза". Это высокоуровневый признак следующей проблемы.


### При развертывании контейнеры Docker продолжают перезапускаться ###
Убедитесь, что образ "Пауза" совместим с вашей версией ОС. В [инструкциях](./deploying-resources.md) предполагается, что ОС и контейнеры имеют версию 1803. Если у вас установлена более поздняя версия Windows, например сборка для участников программы предварительной оценки, необходимо настроить образы. Сведения об образах см. в [репозитории Docker](https://hub.docker.com/u/microsoft/) корпорации Майкрософт. Независимо от этого, файл Dockerfile образа "Пауза" и образец службы будут ожидать, что образ помечен как `:latest`.


## Распространенные основные ошибки Кубернетес ##
Отладка главного узла Kubernetes делятся на три основных категории (в порядке вероятности):

  - что-то не так с системой контейнеров Kubernetes;
  - что-то не так с выполнением `kubelet`;
  - что-то не так с системой.

Выполните `kubectl get pods -n kube-system` для просмотра модулей pod, созданных Kubernetes. Это может дать определенные сведения о том, в каких из них возникли сбои или какие модули не запускаются. Затем выполните `docker ps -a`, чтобы просмотреть все необработанные контейнеры, поддерживающие эти модули. Наконец, выполните `docker logs [ID]` для контейнеров, которые могут быть причиной проблемы, чтобы просмотреть необработанные выходные данные процессов.


### Не удается подключиться к API-серверу по адресу  `https://[address]:[port]` ###
Чаще эта ошибка указывает на проблемы с сертификатом. Убедитесь, что файл конфигурации создан корректно, что IP-адреса в нем соответствуют адресу узла и что вы скопировали его в каталог, подключенный API-сервером.

Если вы выйдете [по нашим инструкциям](./creating-a-linux-master.md), лучше всего найти это в следующих случаях:   
* `~/kube/kubelet/`
* `$HOME/.kube/config`
*  `/etc/kubernetes/admin.conf`

 в противном случае ознакомьтесь с файлом манифеста сервера API, чтобы проверить точки монтирования.
