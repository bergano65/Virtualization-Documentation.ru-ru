



# Сетевые подключения контейнеров

**Это предварительное содержимое. Возможны изменения.**

В отношении сетевых подключений контейнеры Windows функционируют аналогично виртуальным машинам. В каждом контейнере имеется виртуальный сетевой адаптер, подключенный к виртуальному коммутатору, по которому перенаправляется входящий и исходящий трафик. Доступно два типа конфигурации сети.

- **Режим преобразования сетевых адресов.** Каждый контейнер подключен к внутреннему виртуальному коммутатору и получает внутренний IP-адрес. Конфигурация NAT преобразует этот внутренний адрес во внешний адрес узла контейнера.

- **Прозрачный режим.** Каждый контейнер подключен к внешнему виртуальному коммутатору и получает IP-адрес от DHCP-сервера.

В этом документе подробно рассматриваются преимущества и конфигурация каждого из этих режимов.

## Режим преобразования сетевых адресов (NAT)

**Преобразование сетевых адресов.** Эта конфигурация состоит из внутреннего сетевого коммутатора типа NAT и службы WinNat. В этой конфигурации узел контейнера имеет "внешний" IP-адрес, который доступен по сети. Всем контейнерам назначается "внутренний" адрес, который недоступен по сети. Чтобы контейнер был доступен в этой конфигурации, внешний порт узла сопоставляется с внутренним портом контейнера. Эти сопоставления хранятся в таблице сопоставления портов NAT. Контейнер доступен через IP-адрес и внешний порт узла, который перенаправляет трафик на внутренний IP-адрес и порт контейнера. Преимущество NAT состоит в том, что узел контейнера может масштабироваться до сотен контейнеров, используя при этом только один доступный извне IP-адрес. Кроме того, NAT позволяет нескольким контейнерам размещать приложения, для которых требуются одинаковые порты связи.

### Конфигурация узла

Чтобы настроить узел контейнера на преобразование сетевых адресов (NAT), выполните следующие действия.

Создайте виртуальный коммутатор типа NAT и настройте его на использование внутренней подсети. Дополнительные сведения о команде **New-VMSwitch** см. в разделе [Справка по New-VMSwitch](https://technet.microsoft.com/en-us/library/hh848455.aspx).

```powershell
New-VMSwitch -Name "NAT" -SwitchType NAT -NATSubnetAddress "172.16.0.0/12"
```
Создание объекта преобразования сетевых адресов (NAT). Этот объект отвечает за преобразование адресов NAT. Дополнительные сведения о команде **New-NetNat** см. в разделе [Справка по New-NetNat](https://technet.microsoft.com/en-us/library/dn283361.aspx)

```powershell
New-NetNat -Name NAT -InternalIPInterfaceAddressPrefix "172.16.0.0/12" 
```

### Конфигурация контейнера

При создании контейнера Windows для этого контейнера можно будет выбрать виртуальный коммутатор. Когда контейнер будет подключен к виртуальному коммутатору, настроенному на использование NAT, он получит преобразованный адрес.

В этом примере создается контейнер, подключенный к виртуальному коммутатору с поддержкой NAT.

```powershell
New-Container -Name DemoNAT -ContainerImageName WindowsServerCore -SwitchName "NAT"
```

После запуска контейнера в нем можно просмотреть его IP-адрес.

```powershell
[DemoNAT]: PS C:\> ipconfig

Windows IP Configuration
Ethernet adapter vEthernet (Virtual Switch-527ED2FB-D56D-4852-AD7B-E83732A032F5-0):
   Connection-specific DNS Suffix  . : contoso.com
   Link-local IPv6 Address . . . . . : fe80::384e:a23d:3c4b:a227%16
   IPv4 Address. . . . . . . . . . . : 172.16.0.2
   Subnet Mask . . . . . . . . . . . : 255.240.0.0
   Default Gateway . . . . . . . . . : 172.16.0.1
```

Дополнительные сведения о запуске контейнера Windows и подключении к нему см. в разделе [Управление контейнерами](./manage_containers.md).

### Сопоставление портов

Чтобы получить доступ к приложениям внутри контейнера с поддержкой NAT, между контейнером и узлом контейнера должны быть созданы сопоставления портов. Чтобы создать такое сопоставление, необходим IP-адрес контейнера, "внутренний" порт контейнера и "внешний" порт узла.

В этом примере создается сопоставление порта **80** узла с портом **80** контейнера с IP-адресом **172.16.0.2**.

```powershell
Add-NetNatStaticMapping -NatName "Nat" -Protocol TCP -ExternalIPAddress 0.0.0.0 -InternalIPAddress 172.16.0.2 -InternalPort 80 -ExternalPort 80
```

В этом примере создается сопоставление порта **82** контейнера с портом **80** контейнера с IP-адресом **172.16.0.3**.

```powershell
Add-NetNatStaticMapping -NatName "Nat" -Protocol TCP -ExternalIPAddress 0.0.0.0 -InternalIPAddress 172.16.0.3 -InternalPort 80 -ExternalPort 82
```
> Для каждого внешнего порта потребуются соответствующие правила брандмауэра. Они могут быть созданы с помощью команды `New-NetFirewallRule`. Дополнительные сведения см. в разделе [Справка по New-NetFirewallRule](https://technet.microsoft.com/en-us/library/jj554908.aspx).

После создания сопоставления портов доступ к приложению контейнеров может осуществляться через IP-адрес узла контейнера (физического или виртуального) и предоставленный внешний порт. Например, на следующей схеме показана конфигурация NAT с запросом, направленным на внешний порт **82** узла контейнера. На основании сопоставления портов этот запрос возвратит приложение, размещаемое в контейнере 2.

![](./media/nat1.png)

Просмотр запроса из веб-браузера.

![](./media/portmapping.png)

## Режим прозрачного сетевого подключения

**Прозрачное сетевое подключение.** Эта конфигурация состоит из внешнего сетевого коммутатора. В этой конфигурации каждый контейнер получает IP-адрес от DHCP-сервера и доступен по этому IP-адресу. В этом случае таблица сопоставления порта не поддерживается.

### Конфигурация узла

Для настройки системы контейнеров, в которой контейнеры могут получать IP-адрес от DHCP-сервера, создайте виртуальный коммутатор, подключенный к физическому или виртуальному сетевому адаптеру.

В следующем примере создается виртуальный коммутатор с именем DHCP, который использует сетевой адаптер под именем Ethernet.

```powershell
New-VMSwitch -Name DHCP -NetAdapterName Ethernet
```

Если узел контейнера представляет собой виртуальную машину, необходимо включить MacAddressSpoofing на сетевом адаптере, используемом вместе с коммутатором контейнера. В следующем примере это действие выполняется на виртуальной машине под именем `DemoVm`.

```powershell
Get-VMNetworkAdapter -VMName DemoVM | Set-VMNetworkAdapter -MacAddressSpoofing On
```
Внешний виртуальный коммутатор теперь может быть подключен к какому-либо контейнеру, который затем сможет получать IP-адрес от DHCP-сервера. В этой конфигурации приложения, размещенные внутри контейнера, будут доступны по IP-адресу, назначенному для контейнера.

## Конфигурация Docker

При запуске управляющей программы Docker можно выбрать сетевой мост. При работе Docker в Windows это будет внешний коммутатор или виртуальный коммутатор NAT. В следующем примере осуществляется запуск управляющей программы Docker, задающей виртуальный коммутатор с именем `Virtual Switch`.

```powershell
Docker daemon -D -b “Virtual Switch” -H 0.0.0.0:2375
```

Если при развертывании узла контейнера Docker использует сценарии из конфигурации быстрого запуска контейнера Windows, то создается внутренний виртуальный коммутатор типа NAT, а также создается служба Docker, предварительно настроенная на использование этого коммутатора. Чтобы изменить виртуальный коммутатор, который использует служба Docker, следует остановить эту службу, изменить файл конфигурации и запустить службу повторно.

Чтобы остановить службу, воспользуйтесь следующей командой PowerShell.

```powershell
Stop-Service docker
```

Путь к файлу конфигурации — `c:\programdata\docker\runDockerDaemon.cmd`. Измените следующую строку, заменив `Virtual Switch` именем виртуального коммутатора, который должен использоваться службой Docker.

```powershell
docker daemon -D -b “New Switch Name"
```
Затем запустите эту службу.

```powershell
Start-Service docker
```

## Управление сетевыми адаптерами

Независимо от конфигурации сети (NAT или прозрачное подключение), для управления сетевым адаптером контейнера и соединениями виртуального коммутатора можно использовать команды PowerShell.

Управление сетевым адаптером контейнеров

- Add-ContainerNetworkAdapter — добавляет сетевой адаптер в контейнер.
- Set-ContainerNetworkAdapter изменяет сетевой адаптер контейнера.
- Remove-ContainerNetworkAdapter удаляет сетевой адаптер контейнера.
- Get-ContainerNetworkAdapter возвращает данные о сетевом адаптере контейнера.

Управление подключением между сетевым адаптером контейнеров и виртуальным коммутатором.

- Connect-ContainerNetworkAdapter — подключает контейнер к виртуальному коммутатору.
- Disconnect-ContainerNetworkAdapter отключает контейнер от виртуального коммутатора.

Подробные сведения о каждой из этих команд см. в разделе [Справка по PowerShell для контейнеров](https://technet.microsoft.com/en-us/library/mt433069.aspx).






<!--HONumber=Feb16_HO4-->


