---
title: "Сетевые подключения контейнеров Windows"
description: "Настройка сетевого взаимодействия для контейнеров Windows."
keywords: "docker, контейнеры"
author: jmesser81
manager: timlt
ms.date: 05/02/2016
ms.topic: article
ms.prod: windows-containers
ms.service: windows-containers
ms.assetid: 538871ba-d02e-47d3-a3bf-25cda4a40965
translationtype: Human Translation
ms.sourcegitcommit: c412171773e9c66569eab2252b5adfc187eedafd
ms.openlocfilehash: eb7d2c25d929cb51abfad17c26a89105f6574a48

---

# Сетевые подключения контейнеров

В отношении сетевых подключений контейнеры Windows функционируют аналогично виртуальным машинам. В каждом контейнере имеется виртуальный сетевой адаптер, подключенный к виртуальному коммутатору, по которому перенаправляется входящий и исходящий трафик. Чтобы обеспечить изоляцию между контейнерами на одном узле, для каждого контейнера Windows Server и Hyper-V создается секция сети, куда устанавливается сетевой адаптер этого контейнера. Для подключения к виртуальному коммутатору контейнеры Windows Server используют виртуальный сетевой адаптер узла. Для подключения к виртуальному коммутатору контейнеры Hyper-V используют сетевой адаптер синтетической виртуальной машины (не предоставляется служебной виртуальной машине).

Контейнеры Windows поддерживают четыре разных сетевых драйвера или режима: *nat*, *transparent*, *l2bridge* и *l2tunnel*. В зависимости от физической сетевой инфраструктуры и от того, должна ли сеть быть одно- или многоузловой, необходимо выбрать сетевой режим, который наилучшим образом соответствует вашим потребностям. 

По умолчанию при первом запуске службы Docker подсистема Docker создает сеть NAT. По умолчанию созданный внутренний префикс IP-адреса имеет значение 172.16.0.0/12. 

> Примечание. Если IP-адрес узла контейнера находится в том же префиксе, необходимо будет изменить внутренний префикс IP-адреса NAT, как описано ниже.

Конечные точки контейнера будут подключены к этой сети по умолчанию, и им будут назначены IP-адреса из внутреннего префикса. В Windows сейчас поддерживается только одна сеть NAT (хотя с помощью ожидающего [запроса на включение внесенных изменений](https://github.com/docker/docker/pull/25097) можно обойти это ограничение). 

Дополнительные сети, использующие другой драйвер (например, transparent или l2bridge), можно создавать в том же узле контейнера. В следующей таблице показано, как сетевое подключение предоставляется для внутренних (контейнер — контейнер) и внешних подключений каждого режима.

- **Преобразование сетевых адресов** — каждый контейнер получает IP-адрес из внутреннего частного префикса IP-адреса (например, 172.16.0.0/12). Перенаправление и сопоставление портов из узла контейнера в конечные точки контейнера поддерживается

- **Прозрачный режим** — каждая конечная точка контейнера подключена напрямую к физической сети. IP-адреса из физической сети могут назначаться статически или динамически с помощью внешнего DHCP-сервера.

- **Режим моста L2** — каждая конечная точка контейнера будет находиться в той же IP-подсети, что и узел контейнера. IP-адреса должны назначаться статически из того же префикса, что и узел контейнера. Все конечные точки контейнера на узле будут иметь одинаковый MAC-адрес из-за преобразования адресов второго уровня.

- **Туннельный режим L2** - _ — этот режим должен использоваться только в Microsoft Cloud Stack_.

> Сведения о подключении конечных точек контейнера к дополнительной виртуальной сети со стеком Microsoft SDN см. в статье [Подключение контейнеров к виртуальной сети](location).

## С одним узлом

|  | Контейнер — контейнер | Контейнер — внешние |
| :---: | :---------------     |  :---                |
| nat | Подключение с мостом через виртуальный коммутатор Hyper-V | маршрутизация через WinNAT с применением преобразования адресов | 
| transparent | Подключение с мостом через виртуальный коммутатор Hyper-V | прямой доступ к физической сети | 
| l2bridge | Подключение с мостом через виртуальный коммутатор Hyper-V|  доступ к физической сети с преобразованием MAC-адресов|  



## С несколькими узлами

|  | Контейнер — контейнер | Контейнер — внешние |
| :---: | :----       | :---------- |
| nat | должен ссылаться на IP-адрес и порт узла внешнего контейнера; маршрутизация через WinNAT с применением преобразования адресов | должен ссылаться на внешний узел; маршрутизация через WinNAT с применением преобразования адресов | 
| transparent | должен ссылаться на конечную точку IP-адреса контейнера напрямую | прямой доступ к физической сети | 
| l2bridge | должен ссылаться на конечную точку IP-адреса контейнера напрямую| доступ к физической сети с преобразованием MAC-адресов| 


## Создание сети 

### (По умолчанию.) Сеть NAT

Подсистема Docker Windows создает сеть NAT по умолчанию с префиксом IP-адреса 172.16.0.0/12. Сейчас допустима только одна сеть NAT в узле контейнера Windows. Если пользователь хочет создать сеть NAT с конкретным префиксом IP-адреса, он может выполнить одно из двух следующих действий, изменив параметры в файле конфигурации Docker daemon.json (расположен в папке "C:\ProgramData\Docker\config\daemon.json"; создайте его, если он еще не существует).
 1. Использовать параметр _"fixed-cidr": "< IP-префикс > / Mask"_, который создает сеть NAT по умолчанию с указанными префиксом IP-адреса и маской.
 2. Использовать параметр _"bridge": "none"_, который не создает сеть по умолчанию; пользователь может создать пользовательскую сеть с любым драйвером с помощью команды *docker network create -d<driver>*.

Перед использованием любого из этих вариантов настройки необходимо предварительно остановить службу Docker и удалить все существующие сети NAT.

```none
PS C:\> Stop-Service docker
PS C:\> Get-ContainerNetwork | Remove-ContainerNetwork

...Edit the daemon.json file...

PS C:\> Start-Service docker
```

Если пользователь добавил параметр "fixed-cidr" в файл daemon.json, подсистема Docker создаст пользовательскую сеть NAT с указанным префиксом IP-адреса и маской. Если вместо этого пользователь добавил параметр "bridge:none", сеть придется создавать вручную.

```none
# Create a user-defined nat network
C:\> docker network create -d nat --subnet=192.168.1.0/24 --gateway=192.168.1.1 MyNatNetwork
```

По умолчанию конечные точки контейнера будут подключены к сети NAT, выбранной по умолчанию. Если сеть NAT по умолчанию не создана (так как в файле daemon.json указан параметр "bridge:none") или требуется доступ к другой пользовательской сети, пользователи могут указать параметр *--network* для команды "run" Docker.

```none
# Connect new container to the MyNatNetwork
C:\> docker run -it --network=MyNatNetwork <image> <cmd>
```

#### Сопоставление портов

Чтобы получить доступ к приложениям, выполняющимся внутри контейнера, подключенного к сети NAT, между узлом контейнера и конечной точкой контейнера должны быть созданы сопоставления портов. Эти сопоставления должны быть указаны в момент СОЗДАНИЯ контейнера или тогда, когда контейнер находится в ОСТАНОВЛЕННОМ состоянии.

```none
# Creates a static mapping between port TCP:80 of the container host and TCP:80 of the container
C:\> docker run -it -p 80:80 <image> <cmd>

# Create a static mapping between port 8082 of the container host and port 80 of the container.
C:\> docker run -it -p 8082:80 windowsservercore cmd
```

Динамическое сопоставление портов можно выполнять с помощью параметра -p или команды EXPOSE с параметром -P в Dockerfile. На узле контейнера выбирается случайный временный порт, который можно проверить при выполнении команды Docker ps.

```none
C:\> docker run -itd -p 80 windowsservercore cmd

# Network services running on port TCP:80 in this container can be accessed externally on port TCP:14824
C:\> docker ps
CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS                   NAMES
bbf72109b1fc        windowsservercore   "cmd"               6 seconds ago       Up 2 seconds        *0.0.0.0:14824->80/tcp*   drunk_stonebraker

# Container image specified EXPOSE 80 in Dockerfile - publish this port mapping
C:\> docker network 
```
> Начиная с WS2016 TP5 и сборок Windows для участников программы предварительной оценки (версий старше 14300), правило брандмауэра автоматически создается для всех сопоставлений портов NAT. Оно является глобальным по отношению к узлу контейнера и не ограничивается конкретным контейнером конечной точки или сетевым адаптером.

Реализация Windows NAT (WinNAT) имеет несколько недостатков, которые рассматриваются в этой публикации блога [WinNAT capabilities and limitations](https://blogs.technet.microsoft.com/virtualization/2016/05/25/windows-nat-winnat-capabilities-and-limitations/) (Возможности и ограничения WinNAT). 
 1. Поддерживается только одна сеть NAT (один внутренний префикс IP-адреса) на каждый узел контейнера.
 2. Конечные точки контейнера доступны только из узла контейнера, использующего внутренний IP-адрес и порт.

Дополнительные сети можно создавать с помощью других драйверов. 

> Имена всех сетевых драйверов Docker состоят из строчных букв.

### Прозрачная сеть

Для использования режима прозрачного сетевого взаимодействия создайте сеть контейнера с именем драйвера "transparent". 

```none
C:\> docker network create -d transparent MyTransparentNetwork
```

Если узел контейнера виртуализирован и вы хотите использовать DHCP для назначения IP-адресов, необходимо включить MACAddressSpoofing на сетевом адаптере виртуальных машин. В противном случае узел Hyper-V будет блокировать сетевой трафик от контейнеров к виртуальной машине с несколькими MAC-адресами.

```none
PS C:\> Get-VMNetworkAdapter -VMName ContainerHostVM | Set-VMNetworkAdapter -MacAddressSpoofing On
```

> Чтобы создать несколько прозрачных сетей, необходимо указать, к какому сетевому адаптеру (виртуальному) должен быть привязан внешний виртуальный коммутатор Hyper-V (создаваемый автоматически).

Чтобы привязать сеть, подключенную через виртуальный коммутатор Hyper-V, к конкретному сетевому интерфейсу, используйте параметр *-o com.docker.network.windowsshim.interface=<Interface>*.

```none
# Create a transparent network which is attached to the "Ethernet 2" network interface
C:\> docker network create -d transparent -o com.docker.network.windowsshim.interface="Ethernet 2" TransparentNet2
```

Значением *com.docker.network.windowsshim.interface* является *Name* (Имя) адаптера из: 
```none
Get-NetAdapter
```

IP-адреса для конечных точек контейнера, подключенных к прозрачной сети, можно назначить статически или динамически с внешнего DHCP-сервера.

При статическом назначении IP-адресов необходимо сначала убедиться, что при создании сети указаны параметры *--subnet* и *--gateway*. IP-адрес подсети и шлюза должен совпадать с IP-адресом, указанным в параметрах сети для контейнера узла, т. е. физической сети.

```none
# Create a transparent network corresponding to the physical network with IP prefix 10.123.174.0/23
C:\> docker network create -d transparent --subnet=10.123.174.0/23 --gateway=10.123.174.1 TransparentNet3
```
Укажите IP-адрес для команды "run" Docker с помощью параметра *--ip*.

```none
C:\> docker run -it --network=TransparentNet3 --ip 10.123.174.105 <image> <cmd>
```

> Убедитесь, что этот IP-адрес не назначен другому сетевому устройству в физической сети.

Поскольку конечные точки контейнера имеют прямой доступ к физической сети, нет необходимости указывать сопоставления портов.

### Мост второго уровня 

Для использования сетевого режима моста L2 создайте сеть контейнера с именем драйвера "l2bridge". Необходимо опять же указать подсеть и шлюз, соответствующие физической сети.

```none
C:\> docker network create -d l2bridge --subnet=192.168.1.0/24 --gateway=192.168.1.1 MyBridgeNetwork
```

В сетях l2bridge поддерживается только статическое назначение IP-адресов. 

> При использовании сети l2bridge в структуре SDN поддерживается только динамическое назначение IP-адресов. Дополнительные сведения см. в статье [Подключение контейнеров к виртуальной сети](location).

## Другие операции и конфигурации

### Перечисление доступных сетей

```none
# list container networks
C:\> docker network ls

NETWORK ID          NAME                DRIVER              SCOPE
0a297065f06a        nat                 nat                 local
d42516aa0250        none                null                local
```

### Удаление сети

Используйте команду `docker network rm`, чтобы удалить сеть контейнера.

```none
C:\> docker network rm "<network name>"
```

Это приведет к очистке виртуальных коммутаторов Hyper-V, используемых сетью контейнера, а также всех созданных преобразований сетевых адресов (экземпляров WinNAT — NetNat).

### Анализ сети 

Чтобы узнать, какие контейнеры подключены к определенной сети и какие IP-адреса связаны с этими конечными точками контейнера, можно выполнить приведенную ниже команду.

```none
C:\> docker network inspect <network name>
```

### Несколько сетей контейнера

На одном узле контейнера можно создать несколько сетей контейнера со следующими оговорками:
* Для каждого узла контейнера можно создать только одну сеть NAT.
* Каждая из нескольких сетей, использующих внешний коммутатор vSwitch для взаимодействия (например, прозрачный режим, мост L2, прозрачный режим L2), должна использовать свой собственный сетевой адаптер.

### Выбор сетей

При создании контейнера Windows можно указать сеть, к которой будет подключен сетевой адаптер контейнера. Если сеть не указана, используется сеть NAT по умолчанию.

Чтобы подключить контейнер к сети NAT, отличной от применяемой по умолчанию, используйте параметр --network для команды "run" Docker.

```none
C:\> docker run -it --network=MyTransparentNet windowsservercore cmd
```

### Статический IP-адрес

```none
C:\> docker run -it --network=MyTransparentNet --ip=10.80.123.32 windowsservercore cmd
```

Назначение статических IP-адресов выполняется непосредственно на сетевом адаптере контейнера и должно осуществляться, только когда контейнер находится в ОСТАНОВЛЕННОМ состоянии. "Горячее добавление" сетевых адаптеров контейнера или изменений в сетевой стек не поддерживается во время выполнения контейнера.


## Особенности и рекомендации

### Брандмауэр

Для узла контейнера требуется создать определенные правила брандмауэра, чтобы разрешить ICMP (проверка связи) и DHCP. Протоколы ICMP и DHCP нужны контейнерам Windows Server для проверки связи между двумя контейнерами на одном узле, а также для получения динамически назначаемых IP-адресов через DHCP. В TP5 эти правила создаются с помощью сценария Install-ContainerHost.ps1. В более поздних версиях они будут создаваться автоматически. Все правила брандмауэра, соответствующие правилам перенаправления портов NAT, будут создаваться автоматически и очищаться после остановки контейнера.

### Неподдерживаемые функции

Сейчас через Docker CLI нельзя выполнить приведенные ниже сетевые функции:
 * Связывание контейнера (например, --link)
 * Разрешение IP-адресов для контейнеров на основании имен или служб. _Эта возможность скоро будет добавлена с выходом обновления для обслуживания._
 * Драйвер наложенной сети по умолчанию.

Сейчас в Windows Docker не поддерживаются следующие параметры сети:
 * --add-host
 * --dns
 * --dns-opt
 * --dns-search
 * -h, --hostname
 * --net-alias
 * --aux-address
 * --internal
 * --ip-range

 > В Windows Server 2016 Technical Preview 5 и последних сборках Windows Insider Preview (WIP) известна ошибка, из-за которой при обновлении до новой сборки создается повторяющаяся (т. е. "потерянная") сеть контейнера и vSwitch. Чтобы обойти эту проблему, выполните следующий сценарий.
```none
$KeyPath = "HKLM:\SYSTEM\CurrentControlSet\Services\vmsmp\parameters\SwitchList"
$keys = get-childitem $KeyPath
foreach($key in $keys)
{
   if ($key.GetValue("FriendlyName") -eq 'nat')
   {
      $newKeyPath = $KeyPath+"\"+$key.PSChildName
      Remove-Item -Path $newKeyPath -Recurse
   }
}
remove-netnat -Confirm:$false
Get-ContainerNetwork | Remove-ContainerNetwork
Get-VmSwitch -Name nat | Remove-VmSwitch # Note: failure is expected
Stop-Service docker
Set-Service docker -StartupType Disabled
```
> Перезагрузите узел, а затем выполните оставшиеся действия.
```none
Get-NetNat | Remove-NetNat -Confirm $false
Set-Service docker -StartupType automatic
Start-Service docker 
```



<!--HONumber=Aug16_HO3-->


