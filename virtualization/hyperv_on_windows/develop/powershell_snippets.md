---
title: &779290078 Фрагменты кода PowerShell
description: Фрагменты кода PowerShell
keywords: windows 10, hyper-v
author: scooley
manager: timlt
ms.date: 05/02/2016
ms.topic: article
ms.prod: &381223808 windows-10-hyperv
ms.service: windows-10-hyperv
ms.assetid: dc33c703-c5bc-434e-893b-0c0976b7cb88
---

# Фрагменты кода PowerShell

PowerShell — это прекрасное средство автоматизации, управления и написания сценариев для Hyper-V.  Из этой статьи вы узнаете о некоторых замечательных возможностях PowerShell.

Все сценарии и фрагменты кода следует запускать от имени администратора из учетной записи администратора Hyper-V.

Если вы не уверены, есть ли у вас необходимые разрешения, введите команду `Get-VM`. Если она выполняется без ошибок, приступайте к работе.


## Средства PowerShell Direct

Все сценарии и фрагменты кода в этом разделе основаны на следующем:

**Требования**:
*  PowerShell Direct. Windows 10 в качестве гостевой операционной системы и системы узла.

**Общие переменные**:  
`$VMName` — строка с именем виртуальной машины. Список доступных виртуальных машин можно отобразить с помощью команды `Get-VM`.  
`$cred` — учетные данные для гостевой ОС. Могут быть заполнены с помощью команды `$cred = Get-Credential`.

### Проверка загрузки гостевой операционной системы

Диспетчер Hyper-V не позволяет определить состояние загрузки гостевой ОС.

Ниже приведены два представления одних и тех же функциональных возможностей: первое в виде фрагмента кода, второе в виде функции PowerShell.

Фрагмент кода:
``` PowerShell
if((Invoke-Command -VMName $VMName -Credential $cred {"Test"}) -ne "Test"){Write-Host "Not Booted"} else {Write-Host "Booted"}
```

Function:
``` PowerShell
function waitForPSDirect([string]$VMName, $cred){
   Write-Output "[$($VMName)]:: Waiting for PowerShell Direct (using $($cred.username))"
   while ((Invoke-Command -VMName $VMName -Credential $cred {"Test"} -ea SilentlyContinue) -ne "Test") {Sleep -Seconds 1}}
```

**Результат**  
Вывод понятного сообщения и блокировка до успешного подключения к виртуальной машине.  
Выполняется без уведомления.

### Блокировка сценария до подключения гостевой ОС к сети

С помощью PowerShell Direct можно подключиться к сеансу PowerShell в виртуальной машине до получения IP-адреса.

``` PowerShell
# Wait for DHCP
while ((Get-NetIPAddress | ? AddressFamily -eq IPv4 | ? IPAddress -ne 127.0.0.1).SuffixOrigin -ne "Dhcp") {sleep -Milliseconds 10}
```

** Результат **
Блокировка до получения аренды DHCP. Так как этот сценарий не стремится получить определенный IP-адрес или адрес подсети, он работает независимо от конфигурации сети.  
Выполняется без уведомления.

## Управление учетными данными с помощью PowerShell

Для выполнения сценариев Hyper-V часто требуется обработка учетных данных для одной или нескольких виртуальных машин и узла Hyper-V.

При работе с PowerShell Direct или стандартном удаленном взаимодействии PowerShell для этого есть несколько способов:

1. Первый (и самый простой) способ — использовать одинаковые учетные данные пользователя на узле и гостевой машине или локальном и удаленном узлах.  
  Это довольно просто, если вы входите в систему с помощью учетной записи Майкрософт или работаете в среде домена.  
  В этом случае просто выполните команду `Invoke-Command -VMName "test" {get-process}`.

2. Разрешить PowerShell запрашивать учетные данные.  
  Если учетные данные не совпадают, каждый раз будет появляться запрос на их ввод, чтобы вы могли указать необходимые учетные данные для виртуальной машины.

3. Хранить учетные данные в переменной для повторного использования.
  Можно выполнить такую простую команду:
  ``` PowerShell
  $localCred = Get-Credential
  ```
  А затем такую:
  ``` PowerShell
  Invoke-Command -VMName "test" -Credential $localCred  {get-process} 
  ```
  В этом случае запрос на ввод учетных данных появляется только один раз при запуске сценария или сеанса PowerShell.

4. Записать учетные данные в коде сценария **Не используйте этот способ с реальными рабочими нагрузками или системами.**
> Предупреждение. _Не используйте в рабочей системе. Не используйте с реальными паролями._

  Можно создать объект PSCredential вручную с помощью кода, например:
  ``` PowerShell
  $localCred = New-Object -typename System.Management.Automation.PSCredential -argumentlist "Administrator", (ConvertTo-SecureString "P@ssw0rd" -AsPlainText -Force) 
  ```
  Этот способ крайне небезопасен, но может быть полезен для тестирования. В этом случае сеанс запускается без запроса на ввод пароля.







<!--HONumber=May16_HO1-->


