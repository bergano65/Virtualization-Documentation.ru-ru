# Управление Windows с помощью PowerShell Direct

PowerShell Direct позволяет удаленно управлять виртуальной машиной Windows 10 или Windows Server Technical Preview с узла Hyper-V под управлением соответствующих операционных систем. С помощью PowerShell Direct можно управлять виртуальной машиной средствами PowerShell независимо от конфигурации сети и параметров удаленного управления на узле Hyper-V или виртуальной машине. Это позволяет администраторам Hyper-V автоматизировать управление и настройку виртуальных машин с помощью сценариев.

Запустить PowerShell Direct можно двумя способами:
* Интерактивный сеанс: [в этом разделе](vmsession.md#create-and-exit-an-interactive-powershell-session) можно узнать, как создать и завершить сеанс PowerShell Direct с помощью командлетов PSSession.
* Выполнение набора команд или сценария: [в этом разделе](vmsession.md#run-a-script-or-command-with-invoke-command) можно узнать, как выполнить сценарий или команду с помощью командлета Invoke-Command.


## Требования

**Требования к операционной системе:**
* Windows 10, Windows Server Technical Preview или более поздняя версия на узле.
* Windows 10, Windows Server Technical Preview или более поздняя версия на виртуальной машине.

Если вы управляете виртуальными машинами более ранних версий, используйте программу "Подключение к виртуальной машине" или [настройте для этой машины виртуальную сеть](http://technet.microsoft.com/library/cc816585.aspx).

Чтобы создать сеанс PowerShell Direct на виртуальной машине:
* Виртуальная машина должна работать на узле локально и быть загружена.
* Необходимо войти в учетную запись администратора Hyper-V на хост-компьютере.
* Необходимо указать действительные учетные данные пользователя для виртуальной машины.

## Создание и завершение интерактивного сеанса PowerShell

1. На узле Hyper-V откройте Windows PowerShell от имени администратора.

3. Выполните одну из указанных ниже команд, чтобы создать сеанс, используя имя или GUID виртуальной машины:
``` PowerShell
Enter-PSSession -VMName <VMName>
Enter-PSSession -VMGUID <VMGUID>
```

4. Выполните все необходимые команды. Эти команды выполняются на виртуальной машине, в которой был создан сеанс.
5. После завершения работы выполните следующую команду, чтобы закрыть сеанс:
``` PowerShell
Exit-PSSession 
```

> Примечание. Если вы не можете подключиться к сеансу, убедитесь, что используете учетные данные для подключаемой виртуальной машины, а не для узла Hyper-V.

Дополнительные сведения об этих командлетах см. в разделах [Enter-PSSession](http://technet.microsoft.com/library/hh849707.aspx) и [Exit-PSSession](http://technet.microsoft.com/library/hh849743.aspx).

## Запуск сценария или команды с помощью командлета Invoke-Command

Выполнить предварительно определенный набор команд на виртуальной машине можно с помощью командлета [Invoke-Command](http://technet.microsoft.com/library/hh849719.aspx). Ниже приведен пример использования командлета Invoke-Command, где PSTest — это имя виртуальной машины, а сценарий, который требуется запустить,(foo.ps1) находится в папке сценария (script) на диске C:

 ``` PowerShell
 Invoke-Command -VMName PSTest -FilePath C:\script\foo.ps1 
 ```

Чтобы выполнить одну команду, используйте параметр **-ScriptBlock**:

 ``` PowerShell
 Invoke-Command -VMName PSTest -ScriptBlock { cmdlet } 
 ```

## Диагностика

В PowerShell Direct используется небольшой набор сообщений о распространенных ошибках. Ниже приведены наиболее распространенные ошибки, возможные причины и средства диагностики.

### Ошибка: "Возможно, удаленный сеанс был завершен"

Сообщение об ошибке:
```
An error has occured which Windows PowerShell cannot handle.  A remote session might have ended. 
```

Возможные причины:
* Виртуальная машина отключена.
* Гостевая операционная система не поддерживает PowerShell Direct (см. [требования](#Requirements)).
* Оболочка PowerShell еще не доступна на гостевой виртуальной машине.
    * Загрузка операционной системы не завершена.
    * Правильная загрузка операционной системы невозможна.
    * Во время загрузки требуется ввод данных пользователем.
* Не удается проверить учетные данные для гостевой виртуальной машины.

С помощью командлета [Get-VM](http://technet.microsoft.com/library/hh848479.aspx) можно проверить, есть ли у используемых учетных данных роль администратора Hyper-V, а также просмотреть, какие виртуальные машины запущены локально и загружены.

## Примеры

См. примеры на веб-сайте [GitHub](https://github.com/Microsoft/Virtualization-Documentation/search?l=powershell&q=-VMName+OR+-VMGuid&type=Code&utf8=%E2%9C%93).

Большое число примеров использования PowerShell Direct в рабочей среде, а также советы и рекомендации по написанию сценариев Hyper-V с помощью PowerShell см. в статье [Фрагменты кода PowerShell Direct](../develop/powershell_snippets.md).



