---
title: Вложенная виртуализация
description: Вложенная виртуализация
keywords: windows 10, hyper-v
author: theodthompson
manager: timlt
ms.date: 05/02/2016
ms.topic: article
ms.prod: windows-10-hyperv
ms.service: windows-10-hyperv
ms.assetid: 68c65445-ce13-40c9-b516-57ded76c1b15
---

# Вложенная виртуализация

Вложенная виртуализация позволяет запускать узлы Hyper-V в виртуализированной среде. Другими словами, с помощью вложенной виртуализации можно виртуализировать сам узел Hyper-V. К примерам вложенной виртуализации относятся запуск лаборатории Hyper-V в виртуализированной среде и предоставление служб виртуализации другим пользователям без использования отдельных устройств. Технология контейнеров Windows использует вложенную виртуализацию при запуске контейнеров Hyper-V на виртуализированном узле контейнеров. В этом документе подробно описываются требования к программному обеспечению и оборудованию, действия по настройке и приводятся сведения об устранении неполадок.

> Вложенная виртуализация находится в предварительной версии, и ее не следует использовать в рабочей среде.

## Предварительные требования

- Сборка программы предварительной оценки Windows (Windows Server 2016, Nano Server или Windows 10) версии 10565 или более поздней версии.
- На обеих низкоуровневых оболочках (родительской и дочерней) должны быть запущены одинаковые сборки Windows (10565 или более поздней версии).
- Минимум 4 ГБ ОЗУ.
- Процессор Intel с технологией Intel VT-x.

## Настройка вложенной виртуализации

Сначала создайте виртуальную машину под управлением ОС той же сборки, что и на вашем узле. **Не включайте виртуальную машину**. Дополнительные сведения см. в статье [Создание виртуальной машины](../quick_start/walkthrough_create_vm.md).

После создания виртуальной машины выполните следующую команду в родительской низкоуровневой оболочке. Эта команда включает вложенную виртуализацию на виртуальной машине.

```none
Set-VMProcessor -VMName <virtual machine> -ExposeVirtualizationExtensions $true -Count 2
```

При запуске вложенного узла Hyper-V необходимо отключить динамическую память на виртуальной машине. Это можно сделать в свойствах виртуальной машины или с помощью следующей команды PowerShell.

```none
Set-VMMemory <virtual machine> -DynamicMemoryEnabled $false
```

Чтобы вложенные виртуальные машины получили IP-адреса, должен быть включен спуфинг MAC-адресов. Это можно сделать с помощью следующей команды PowerShell.

```none
Get-VMNetworkAdapter -VMName <virtual machine> | Set-VMNetworkAdapter -MacAddressSpoofing On
```

Выполнив эти действия, можно запустить виртуальную машину и установить Hyper-V. Дополнительные сведения об установке Hyper-V см. в разделе [Установка Hyper-V]( https://msdn.microsoft.com/en-us/virtualization/hyperv_on_windows/quick_start/walkthrough_install).

## VPN-устройства

При необходимости для включения и настройки вложенной виртуализации можно использовать следующий сценарий. Для скачивания и запуска сценария используйте следующие команды.
  
```none
# download script
Invoke-WebRequest https://raw.githubusercontent.com/Microsoft/Virtualization-Documentation/master/hyperv-tools/Nested/Enable-NestedVm.ps1 -OutFile .\Enable-NestedVm.ps1 

# run script
.\Enable-NestedVm.ps1 -VmName "DemoVM"
```

## Известные проблемы

- Узлы, на которых включена функция Device Guard, не могут предоставить расширения виртуализации гостевым виртуальным машинам.
- Узлы, на которых включено средство обеспечения безопасности на основе виртуализации, не могут предоставить расширения виртуализации гостевым виртуальным машинам. Для использования вложенной виртуализации необходимо сначала отключить VBS.
- При использовании пустого пароля подключение к виртуальной машине может быть утеряно. Измените пароль, и проблема будет решена.
- После включения вложенной виртуализации на виртуальной машине указанные ниже функции становятся с ней несовместимы.  
  * Изменение размера рабочей памяти.
  * Применение контрольной точки к запущенной виртуальной машине.
  * Виртуальную машину, в которой размещены другие виртуальные машины, нельзя перенести динамически.
  * Сохранение и восстановление не будут работать.

## Часто задаваемые вопросы и устранение неполадок

Что делать, если виртуальная машина не запускается?

1. Убедитесь, что динамическая память отключена.
2. Запустите [следующий сценарий PowerShell](https://raw.githubusercontent.com/Microsoft/Virtualization-Documentation/master/hyperv-tools/Nested/Get-NestedVirtStatus.ps1) с повышенными привилегиями на компьютере узла.
  
## Отзыв

Сообщить о дополнительных проблемах можно с помощью средств обратной связи приложения Windows, на [форумах по виртуализации](https://social.technet.microsoft.com/Forums/windowsserver/En-us/home?forum=winserverhyperv) или с помощью [GitHub](https://github.com/Microsoft/Virtualization-Documentation).



<!--HONumber=Jun16_HO2-->


