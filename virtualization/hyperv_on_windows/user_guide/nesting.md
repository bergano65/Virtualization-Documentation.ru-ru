---
title: "Вложенная виртуализация"
description: "Вложенная виртуализация"
keywords: windows 10, hyper-v
author: theodthompson
manager: timlt
ms.date: 06/20/2016
ms.topic: article
ms.prod: windows-10-hyperv
ms.service: windows-10-hyperv
ms.assetid: 68c65445-ce13-40c9-b516-57ded76c1b15
ms.sourcegitcommit: ef18b63c454b3c12a7067d3604ba142d55403226
ms.openlocfilehash: 2d1679ffe4876ddd4eefe1b457098e8797899492

---

# Запуск Hyper-V в виртуальной машине со вложенной виртуализацией

Вложенная виртуализация — это компонент, который позволяет запускать Hyper-V в виртуальной машине Hyper-V. Другими словами, с помощью вложенной виртуализации можно виртуализировать сам узел Hyper-V. К вариантам использования вложенной виртуализации можно отнести запуск контейнера Hyper-V на виртуализированном узле контейнеров, настройку лаборатории Hyper-V в виртуализированной среде или тестирование сценариев для нескольких компьютеров без необходимости использования дополнительного оборудования. В этом документе подробно описываются требования к программному обеспечению и оборудованию, действия по настройке и приводятся сведения об устранении неполадок.

## Необходимые компоненты

- Узел Hyper-V под управлением сборки Windows из программы предварительной оценки (Windows Server 2016 или Windows 10) под номером 10565 или более поздней версии.
- На обеих низкоуровневых оболочках (родительской и дочерней) должны быть запущены одинаковые сборки Windows (10565 или более поздней версии).
- Процессор Intel с технологией Intel VT-x и EPT.

## Настройка вложенной виртуализации

Сначала создайте виртуальную машину. **Не включайте ее**. Дополнительные сведения см. в статье [Создание виртуальной машины](../quick_start/walkthrough_create_vm.md).

После создания виртуальной машины выполните следующую команду на физическом узле Hyper-V. В виртуальной машине будет включена вложенная виртуализация.

```none
Set-VMProcessor -VMName <VMName> -ExposeVirtualizationExtensions $true
```
При запуске вложенного узла Hyper-V необходимо отключить динамическую память на виртуальной машине. Это можно сделать в свойствах виртуальной машины или с помощью следующей команды PowerShell.
```none
Set-VMMemory -VMName <VMName> -DynamicMemoryEnabled $false
```

Выполнив эти действия, можно запустить виртуальную машину и установить Hyper-V. Дополнительные сведения об установке Hyper-V см. в разделе [Установка Hyper-V]( https://msdn.microsoft.com/en-us/virtualization/hyperv_on_windows/quick_start/walkthrough_install).

## Параметры сетей
Существуют два параметра для сетей со вложенными виртуальными машинами: спуфинг MAC-адресов и режим NAT.

### Спуфинг MAC-адресов
Чтобы сетевые пакеты перенаправлялись через два виртуальных коммутатора, необходимо включить спуфинг MAC-адресов на первом уровне виртуального коммутатора. Это можно сделать с помощью следующей команды PowerShell.

```none
Get-VMNetworkAdapter -VMName <VMName> | Set-VMNetworkAdapter -MacAddressSpoofing On
```
### Преобразование сетевых адресов
Второй параметр связан с преобразованием сетевых адресов (NAT). Этот подход рекомендуется для случаев, когда спуфинг MAC-адресов невозможен, например в общедоступной облачной среде.

Сначала необходимо создать виртуальный коммутатор NAT в виртуальной машине узла ("средняя" виртуальная машина). Обратите внимание, что IP-адреса приведены только в качестве примера и будут разниться в зависимости от сред:
```none
new-vmswitch -name VmNAT -SwitchType Internal
New-NetNat –Name LocalNAT –InternalIPInterfaceAddressPrefix “192.168.100.0/24”
```
Далее назначьте IP-адрес для сетевого адаптера:
```none
get-netadapter "vEthernet (VmNat)" | New-NetIPAddress -IPAddress 192.168.100.1 -AddressFamily IPv4 -PrefixLength 24
```
Каждая вложенная виртуальная машина должна иметь назначенный IP-адрес и шлюз. Обратите внимание, что IP-адрес шлюза должен указывать на адаптер NAT из предыдущего действия. Можно также назначить DNS-сервер:
```none
get-netadapter "Ethernet" | New-NetIPAddress -IPAddress 192.168.100.2 -DefaultGateway 192.168.100.1 -AddressFamily IPv4 -PrefixLength 24
Netsh interface ip add dnsserver “Ethernet” address=<my DNS server>
```


## Известные проблемы

- Узлы, на которых включена функция Device Guard, не могут предоставить расширения виртуализации гостевым виртуальным машинам.
- Виртуальные машины с включенным средством обеспечения безопасности на основе виртуализации (VBS) не могут одновременно быть вложенными. Для использования вложенной виртуализации необходимо сначала отключить VBS.
- После включения вложенной виртуализации на виртуальной машине указанные ниже функции становятся с ней несовместимы.  
  * Изменение размера памяти для среды выполнения и динамическая память
  * Контрольные точки
  * Виртуальная машина с включенным Hyper-V не поддерживает динамическую миграцию.

## Часто задаваемые вопросы и устранение неполадок

Что делать, если виртуальная машина не запускается?

1. Убедитесь, что динамическая память отключена.
2. Убедитесь, что у вас есть совместимый процессор Intel.
3. Запустите [следующий сценарий PowerShell](https://raw.githubusercontent.com/Microsoft/Virtualization-Documentation/master/hyperv-tools/Nested/Get-NestedVirtStatus.ps1) с повышенными привилегиями на компьютере узла.

## Отзыв

Сообщить о дополнительных проблемах можно с помощью средств обратной связи приложения Windows, на [форумах по виртуализации](https://social.technet.microsoft.com/Forums/windowsserver/En-us/home?forum=winserverhyperv) или с помощью [GitHub](https://github.com/Microsoft/Virtualization-Documentation).



<!--HONumber=Jun16_HO3-->


