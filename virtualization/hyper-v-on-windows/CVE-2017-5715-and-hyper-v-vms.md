# <a name="protecting-guest-virtual-machines-from-cve-2017-5715-branch-target-injection"></a>Защита гостевых виртуальных машин от уязвимости CVE-2017-5715 (внедрение ответвления цели)

На этой странице приведены дополнительные сведения о защите виртуальных машин на узлах Hyper-V от уязвимости CVE-2017-5715 (внедрение ответвления цели).  Общие инструкции по Windows Server см. [на этой странице](https://support.microsoft.com/help/4072698/windows-server-guidance-to-protect-against-the-speculative-execution).

Для обеспечения защиты виртуальных машин необходимо выполнить следующее действия.

1. Обновите операционную систему узла.
2. Убедитесь, что на узле виртуализации установлено встроенное ПО, которое содержит обновления для защиты от CVE-2017-5715.
3. Убедитесь, что платформа Hyper-V предоставляет новые возможности процессора гостевым виртуальным машинам Hyper-V.
4. Обновите гостевую операционную систему при необходимости. 
5. Выполните холодную перезагрузку гостевых виртуальных машин.

## <a name="update-the-host-operating-system"></a>Обновление операционной системы узла

Установить обновления операционной системы Windows на узле виртуализации. Сведения о том, как включить это обновление, см. в [статье базы знаний Майкрософт 4072699](https://support.microsoft.com/help/4072699).

## <a name="ensure-the-virtualization-host-has-been-updated-to-firmware-which-contains-updates-for-cve-2017-5715"></a>Убедитесь, что на узле виртуализации установлено встроенное ПО, которое содержит обновления для защиты от CVE-2017-5715

Обновления встроенного ПО от изготовителя оборудования могут содержать новые возможности процессора, которые можно использовать для защиты от уязвимости CVE-2017-5715 ([IBRS, STIBP, IBPB](https://newsroom.intel.com/wp-content/uploads/sites/11/2018/01/Intel-Analysis-of-Speculative-Execution-Side-Channels.pdf)).  После подтверждения обновления встроенного ПО узла виртуализации низкоуровневая оболочка может предоставить эти дополнительные возможности гостевым виртуальным машинам после выполнения следующих действий.

## <a name="ensure-hyper-v-is-configured-to-expose-new-processor-capabilities-to-guest-virtual-machines"></a>Убедитесь, что платформа Hyper-V предоставляет новые возможности процессора гостевым виртуальным машинам Hyper-V

Убедитесь, что Hyper-V настроен на предоставление новых возможностей процессора в гостевых виртуальных машинах.  Эта конфигурация зависит от [версии VM](https://docs.microsoft.com/windows-server/virtualization/hyper-v/deploy/upgrade-virtual-machine-version-in-hyper-v-on-windows-or-windows-server) гостевых виртуальных машин. 

Если версия VM всех виртуальных машин на узле — 8.0 или более поздняя, настройка не требуется.  Эти виртуальные машины смогут обнаружить новые возможности процессора после холодной перезагрузки.

Если версия каких-либо виртуальных машин меньше 8.0, необходимо настроить определенное значение реестра в операционной системе узла.  Таким образом платформа Hyper-V предоставит новые возможности процессора гостевым виртуальным машинам с более ранними версиями VM.

Значение реестра равно `MinVmVersionForCpuBasedMitigations` в разделе `HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Virtualization`.  В этом значении следует указать минимальную версию VM, которой требуется доступ к возможностям обновленного встроенного ПО в формате "основной_номер.дополнительный_номер".  Чтобы предоставить встроенного ПО всем виртуальны машинам на узле (т. е. версиям 1.0 и более поздним версиям), выполните следующую команду на узле: 

```
reg add "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Virtualization" /v MinVmVersionForCpuBasedMitigations /t REG_SZ /d "1.0" /f
```
*Примечание. Виртуальная машина версии 8,0 была представлена в Windows Server 2016 и юбилейном обновлении Windows 10.  Для узлов, работающих под Windows Server 2012 R2 и ниже, необходимо задать значение реестра.*

*Предупреждение. Динамическая миграция между узлами с обновленным встроенным по и узлами без обновленного встроенного по не будет выполнена.  Дополнительные сведения см. в разделе часто задаваемых вопросов в нижней части этого документа.*

## <a name="optional-configure-_pre-skylake_-intel-systems-to-use-retpoline"></a>*Необязательно*: Настройка _предварительно Skylake_ систем Intel для использования Retpoline

*Предупреждение. Настройка виртуальных машин на пред-Skylake узлах Intel для Retpoline будет блокировать динамическую миграцию на более новые узлы (т. е. Skylake и более).*

По умолчанию виртуальные машины, работающие на пред-Skylake системах, не могут использовать retpoline.  Чтобы разрешить этим системам использовать retpoline на основе защиты, задайте для параметра `RetsPredictedFromRsbOnly` в разделе `HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Virtualization` значение `1`. 

```
reg add "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Virtualization" /v RetsPredictedFromRsbOnly /t REG_DWORD /d 1 /f
```

Чтобы отменить эту конфигурацию (т. е. запретить виртуальным машинам использовать retpoline), задайте для `RetsPredictedFromRsbOnly` значение `0`.

## <a name="update-the-guest-operating-system"></a>Обновление гостевой операционной системы

Для завершения настройки средств защиты от уязвимости CVE-2017-5715 на этих виртуальных машинах необходимо обновить и настроить гостевую операционную систему, чтобы воспользоваться преимуществами новых возможностей.  Для операционных систем Майкрософт во время обновления следуйте инструкциям, приведенным в [этой статье](https://support.microsoft.com/help/4072698/windows-server-guidance-to-protect-against-the-speculative-execution).

*Примечание. обновление операционной системы на виртуальной машине может выполняться в любой момент в этом процессе.  Это может произойти перед обновлением микропрограммы узла или после холодной загрузки гостевой виртуальной машины.*

## <a name="perform-a-cold-boot-of-the-guest"></a>Холодная перезагрузка гостевой виртуальной машины

После выполнения первых трех действий необходимо выполнить холодную перезагрузку виртуальных машин, чтобы они могли обнаружить новые возможности процессора.  Это означает, что необходимо полностью отключить работающие виртуальные машины перед их повторным запуском.  Перезагрузки из гостевой операционной системы недостаточно.

## <a name="frequently-asked-questions"></a>Вопросы и ответы

### <a name="how-does-this-impact-live-migration"></a>Как это влияет на динамическую миграцию?

Динамическая миграция виртуальной машины с новыми возможностями процессора завершится ошибкой при переходе на узлы Hyper-V без обновленного встроенное ПО.  Чтобы реализовать динамическую миграцию на узле без обновленного встроенного ПО, остановите предоставление новых возможностей процессора этой гостевой виртуальной машине.  Самый простой способ это сделать — изменить `MinVmVersionForCpuBasedMitigations` до версии VM, которая больше версии, необходимой для переноса, и выполнить холодную перезагрузку виртуальной машины.

Миграция виртуальных машин без новых возможностей процессора будет выполнена успешно при переходе на узлы Hyper-V с обновленным встроенным ПО.  Однако чтобы эти гостевые системы обнаружили обновленные возможности встроенного ПО, необходима холодная перезагрузка.

Виртуальные машины, настроенные для использования Retpoline на пред-Skylake системах Intel, не смогут перейти на новые семейства процессоров (т. е. Skylake и более поздние версии).

### <a name="what-about-live-migration-of-version-50-virtual-machines-between-windows-server-2012r2-and-windows-server-2016"></a>Как насчет динамической миграции виртуальных машин версии 5.0 между Windows Server 2012 R2 и Windows Server 2016?
Для успешного выполнения этого сценария необходимо настроить значение реестра и в Windows Server 2012 R2, и в Windows Server 2016.  После перехода на Windows Server 2016 версия виртуальной машины останется равной 5.0, таким образом раздел реестра должен предоставлять новые возможности процессора виртуальной машине.  

### <a name="does-this-guidance-apply-to-virtual-machines-running-on-vmware"></a>Эти инструкции применяются к виртуальным машинам, работающим на VMWare?
Нет, эти инструкции относятся к виртуальным машинам, работающим на узлах Hyper-V.

### <a name="does-this-guidance-apply-to-hyper-v-on-windows-10"></a>Эти инструкции применяются к Hyper-V в Windows 10?
Да, те же действия относятся к виртуальным машинам, работающими под управлением Windows Server и клиента Windows.

### <a name="do-i-need-to-install-the-firmware-updates-before-performing-a-cold-boot-of-the-virtual-machines"></a>Требуется ли установить обновления встроенного ПО перед выполнением холодной перезагрузки виртуальных машин?
Да, необходимо обновить встроенное ПО и операционную систему узла перед холодной перезагрузки виртуальных машин.

### <a name="what-can-i-do-if-my-oem-does-not-yet-provide-an-updated-firmware"></a>Что можно сделать, если поставщик оборудования еще не предоставил обновленное встроенное ПО?
См. раздел [Альтернативные средства защиты узлов Hyper-V под управлением Windows Server 2016 от уязвимостей спекулятивного выполнения бокового канала](https://docs.microsoft.com/virtualization/hyper-v-on-windows/CVE-2017-5715-and-hyper-v-hosts)

### <a name="how-do-i-check-the-vm-version-for-my-virtual-machines"></a>Как проверить версию VM моих виртуальных машин?
Выполните следующие команды PowerShell на узле Hyper-V:
``` PowerShell
Get-VM * | Format-Table Name, Version  
```

### <a name="do-i-need-to-do-something-different-to-protect-virtual-machines-running-under-processor-compatibility-mode"></a>Нужно ли сделать что-то еще для защиты виртуальных машин, работающих в режиме совместимости процессора?
Нет.  После выполнения инструкций на этой странице новые возможности процессора также предоставляться виртуальным машинам, которые работают в режиме совместимости процессора.

### <a name="what-if-only-half-of-the-machines-in-my-cluster-have-received-a-firmware-update"></a>Что делать, если только часть компьютеров в моем кластере получили обновление встроенного ПО?
Это повлияет на динамическую миграцию в кластере.  Виртуальные машины с новыми возможностями процессора невозможно перенести динамически на узлы без обновленного встроенного ПО.  

### <a name="how-can-i-validate-that-the-guest-virtual-machine-has-access-to-the-new-processor-features"></a>Как убедиться, что у гостевой виртуальной машины есть доступ к новым возможностям процессора?
Используйте модуль или сценарий PowerShell "speculation control".  Подробные инструкции см. [на этой странице](https://support.microsoft.com/help/4072698/windows-server-guidance-to-protect-against-the-speculative-execution).

