---
title: Настройка вложенных виртуальных машин связываться напрямую по ресурсов в Azure виртуальной сети
description: Вложенная виртуализация
keywords: Windows 10, hyper-v, Azure
author: mrajess
ms.date: 12/10/2018
ms.topic: article
ms.prod: windows-10-hyperv
ms.service: windows-10-hyperv
ms.assetid: 1ecb85a6-d938-4c30-a29b-d18bd007ba08
ms.openlocfilehash: 18ab4d1d87c22f70fe09aae5222a7d125ac9c974
ms.sourcegitcommit: 914e0dd1168daf1d2b0f22bd011035016cc08baf
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/23/2019
ms.locfileid: "9099392"
---
# <a name="configure-nested-vms-to-communicate-with-resources-in-an-azure-virtual-network"></a>Настройка вложенных виртуальных машин для связи с ресурсами Azure виртуальной сети

Исходный рекомендации о развертывании и настройке вложенных виртуальных машин Azure требуются доступ этих виртуальных машин через коммутатор NAT. Это предоставляет некоторые ограничения:

1. Вложенные виртуальные машины не имеют доступа к локальным ресурсам или в Azure виртуальной сети.
2. Локальных ресурсов или ресурсов в Azure доступны только вложенных виртуальных машин через NAT, это означает, что несколько гостевые ОС не могут совместно использовать тот же порт.

В этом документе поможет выполнить развертывание, при котором мы делаем использовать службы RRAS, маршруты определенных пользователей, подсети, предназначенный для исходящего трафика NAT, чтобы разрешить доступ к Интернету гостя и «с плавающей запятой» адресное пространство, чтобы разрешить вложенных виртуальных машин работают и взаимодействовать как любой другой виртуальной машины развертывать непосредственно на подсоединена в Azure.

Перед запуском см в этом руководстве:

1. Читать [руководство предоставленной здесь](https://docs.microsoft.com/en-us/azure/virtual-machines/windows/nested-virtualization) о вложенной виртуализации.
2. Эта статья всего до реализации.

## <a name="high-level-overview-of-what-were-doing-and-why"></a>Наши высокого уровня Обзор и преимущества
* Мы создадим вложенности поддержкой Машины, которая содержит две сетевые карты. 
* Один сетевой Адаптер будет использоваться для предоставления доступа к Интернету через NAT и других Сетевых наших вложенных виртуальных машин будет использоваться для маршрутизации трафика из наших внутренний коммутатор на внешние ресурсы низкоуровневой оболочки. Каждый Сетевых необходимо в другом домене маршрутизации, то есть в другой подсети.
* Это означает, что нам потребуется виртуальная сеть с с минимальным три подсети. Одному для NAT, для маршрутизации локальной сети и который не используется, но зарезервирована «» для наших вложенных виртуальных машин. Мы используем для подсетей в данном документе, называются, «NAT», «Hyper-V-LAN» и «Ghosted».
* Размер этих подсетей не по своему усмотрению, но существуют некоторые аспекты. Размер подсетей «Ghosted» определяет, сколько IP-адресов для своих вложенных виртуальных машинах. Кроме того, размер подсетей «NAT» и «Hyper-V-LAN» определяет, сколько IP-адресов для низкоуровневые оболочки. Таким образом с технической точки зрения может сделать здесь очень маленьким подсетей, если планируется только от наличия одной или двух низкоуровневые оболочки.
* Фон: Вложенные виртуальные машины будут не предоставляются для DHCP из подсоединена, их узла подключенном к, даже если вы настроите внутренний или внешний коммутатор. 
  * Это означает, что на узел Hyper-V необходимо предоставить DHCP.
* На узел Hyper-V не учитывать назначенная аренду подсоединена, поэтому чтобы не допустить ситуаций, в котором узла назначает IP-адрес уже существовать нам необходимо выделить блок IP-адресов для использования с узла Hyper-V. Это позволит нам во избежание повторяющихся сценарий IP-адрес.
  * Блок IP-адреса, мы будет соответствовать подсеть в пределах одного подсоединена, Hyper-V.
  * Причина, что мы хотим использовать это в соответствии с существующей подсети — обрабатывать объявления BGP назад по ExpressRoute. Если мы просто иерархическую структуру диапазон IP-адресов узла Hyper-V для использования, а затем нам нужно создать ряд статических маршрутов, чтобы клиенты могли с локальным размещением для связи с вложенных виртуальных машин. Это означает, что это не жестких требований, так как можно составляют диапазона IP-адресов для вложенных виртуальных машин и затем создать все маршруты, необходимые для направления их на узле Hyper-V для этого диапазона.
* Создайте внутренний коммутатор в Hyper-V и затем мы присвоит только что созданный интерфейс IP-адреса в диапазоне, которые мы резервируем для DHCP. Этот IP-адрес будет шлюз по умолчанию для наших вложенных виртуальных машин и можно использовать для маршрута между внутренний коммутатор и сетевой Адаптер узла, подключенном к нашей подсоединена.
* Мы установим роль Маршрутизация и удаленный доступ на узле, который будет превратить наших узла в маршрутизатор.  Это необходимо разрешить обмен данными между ресурсами внешней по отношению к узлу и наши вложенных виртуальных машин.
* Мы сообщим другими ресурсами, как получить доступ к этим вложенных виртуальных машин. Этом требуются, что мы создаем таблицу маршрутизации пользователем, которое содержит статический маршрут для диапазона IP-адресов, в котором вложенных виртуальных машин. Это статический маршрут будет указывать на IP-адрес для Hyper-V.
* Затем поместите этот UDR подсети шлюза таким образом, чтобы клиенты, поступающие от локальных знать, как связаться с нашей вложенных виртуальных машин.
* Этот UDR будет поместить в другой подсети в Azure, что требует наличия подключения к вложенных виртуальных машин.
* Для нескольких узлов Hyper-V необходимо создать дополнительные «с плавающей запятой» подсети и добавьте числу статических маршрутов UDR.
* При списании узлом Hyper-V можно будет delete/переназначения наших «с плавающей запятой» подсети и удалить этот статический маршрут из наших UDR или если это последнее узла Hyper-V, UDR полностью удалить.

## <a name="creating-the-host"></a>Создание узла

Я будет задерживаться на все значения конфигурации, зависит от личных предпочтений, например виртуальной Машины имя, группа ресурсов и т. д..

1. Перейдите к portal.azure.com
2. Щелкните «Создать ресурс» в верхнем левом углу
3. Выберите «Окно виртуальной Машине Server 2016» в столбце популярных
4. На вкладке «Основные» не забудьте выбрать размер виртуальной Машины, который способен вложенной виртуализации
5. Перейти на вкладку «Сеть»
6. Создание новой виртуальной сети со следующими параметрами
    * Подсоединена адресное пространство: 10.0.0.0/22
    * Подсеть 1
        * Имя: NAT
        * Адресное пространство: 10.0.0.0/24
    * Подсеть 2
        * Имя: Hyper-V-локальной сети
        * Адресное пространство: 10.0.1.0/24
    * Подсети 3
        * Имя: синхронизирован.
        * Адресное пространство: 10.0.2.0/24
    * Подсети 4
        * Имя:-Виртуальных машинах Azure
        * Адресное пространство: 10.0.3.0/24
7. Убедитесь, что вы выбрали подсети NAT для виртуальной Машины
8. Перейдите в раздел «Просмотр + создать» и выберите команду «Создать»

## <a name="create-the-second-network-interface"></a>Создание второй сетевой интерфейс
1. После виртуальной Машины завершения подготовки перейдите к нему на портале Azure
2. Остановка виртуальной Машины
3. Один раз остановленной перейти к «Сеть» в разделе параметров
4. «Подключить сетевой интерфейс»
5. «Создать сетевой интерфейс»
6. Присвоим ему имя (не имеет значения, что продуктам, но следует помнить его)
7. Выберите «Hyper-V-LAN» для подсети
8. Убедитесь, что выбран той же группе ресурсов, узле находится в
9. «Создать»
10. Это будет переходу обратно на предыдущем экране, обязательно выберите только что созданный сетевой интерфейс и нажмите кнопку «ОК»
11. Вернитесь в области «Обзор» и снова запустите виртуальные Машины после завершения предыдущего действия
12. Перейдите к второй сетевой Адаптер, мы только что создали, его можно найти в группе ресурсов, ранее выбранным
13. Перейдите на «IP-адрес конфигурации» и «IP-адрес перенаправления» переключатель «Включено», а затем сохраните изменение

## <a name="setting-up-hyper-v"></a>Настройка Hyper-V
1. Пульта ДУ в узле
2. Откройте командную строку PowerShell
3. Выполните следующую команду `Install-WindowsFeature -Name Hyper-V -IncludeManagementTools -Restart`
4. Это приведет к перезапуску узла
5. Подключиться к узлу для продолжения настройки

## <a name="creating-our-virtual-switch"></a>Создание наших виртуального коммутатора

1. Откройте PowerShell в режиме администратора.
2. Создание внутреннего коммутатора: `New-VMSwitch -Name "NestedSwitch" -SwitchType Internal`
3. Назначение только что созданный интерфейс IP-адрес: `New-NetIPAddress –IPAddress 10.0.2.1 -PrefixLength 24 -InterfaceAlias "vEthernet (NestedSwitch)"`

## <a name="install-and-configure-dhcp"></a>Установка и настройка DHCP

*Многие люди пропущены этого компонента, если они сначала пытаются получить рабочий вложенную виртуализацию. В отличие от в локальной где вашего гостевые виртуальные машины будут получать DHCP из сети, к которой находится ваш хост, вложенных виртуальных машин в Azure необходимо предоставить DHCP через они будут выполняться виртуальных машин. Или если необходимо статически назначение IP-адреса для каждой вложенной виртуальная машина, который не является масштабируемым.*

1. Установите роль DHCP: `Install-WindowsFeature DHCP -IncludeManagementTools`
2. Создание области DHCP: `Add-DhcpServerV4Scope -Name "Nested VMs" -StartRange 10.0.2.2 -EndRange 10.0.2.254 -SubnetMask 255.255.255.0`
3. Настройте параметры DNS и шлюз по умолчанию для области: `Set-DhcpServerV4OptionValue -DnsServer 168.63.129.16 -Router 10.0.2.1`
    * Не забудьте ввода допустимые DNS-сервера, если вы хотите, чтобы разрешения имен для работы. В этом случае я использую [рекурсивный Azure DNS](https://docs.microsoft.com/en-us/azure/virtual-network/virtual-networks-name-resolution-for-vms-and-role-instances).

## <a name="installing-remote-access"></a>Установка удаленного доступа

1. Откройте диспетчер сервера и выберите «Добавить роли и компоненты».
2. Выберите «Далее» до «Роли сервера».
3. Проверьте «Удаленный доступ» и нажмите кнопку «Далее» до «Службы ролей».
4. Проверьте «Маршрутизации», выберите «Добавить компоненты», а затем выберите «Далее», а затем «установить». Завершите работу мастера и дождитесь завершения установки.

## <a name="configuring-remote-access"></a>Настройка удаленного доступа

1. Откройте диспетчер сервера и выберите «Инструменты», а затем выберите «Маршрутизация и удаленный доступ».
2. В правой части панели управления Маршрутизация и удаленный доступ будет отображается значок рядом с его именем своего серверов, это щелкните правой кнопкой мыши и выберите «Настройка и включение Маршрутизация и удаленный доступ».
3. В мастере выберите «Далее», наличие Радиальный кнопку «Настраиваемая конфигурация» и нажмите кнопку «Далее».
4. Проверьте «NAT» и «Маршрутизации локальной сети» и затем выберите пункт «Далее» и нажмите «Готово». Если его появится запрос, чтобы запустить службу это сделать.
5. Теперь перейдите к узлу «IPv4» и разверните узел «NAT» становится доступен.
6. Щелкните правой кнопкой мыши «NAT», выберите «Создать интерфейс...» и выберите «Ethernet», это должен быть вашего первого сетевой Адаптер с IP-адреса «10.0.0.4»
7. Теперь нам необходимо создать некоторые статические маршруты принудительно трафика локальной сети, второй сетевого адаптера. Для этого перейдите к узлу «Статические маршруты» в разделе «IPv4».
8. После есть мы создадим следующие маршрутов.
    * Маршрут 1
        * Интерфейс: Ethernet
        * Назначение: 10.0.0.0
        * Маска сети: 255.255.255.0
        * Шлюз: 10.0.0.1
        * Метрики: 256
        * Примечание: Мы вставьте его здесь разрешить основной сетевой Адаптер для ответа на трафик, предназначенный для его собственный интерфейсом. Если у нас нет это здесь следующий маршрут приведет к трафика для сетевого Адаптера 1, чтобы перейти из сетевого Адаптера 2. Это создаст асимметричного маршрута. 10.0.0.1 — IP-адрес подсети NAT назначаемое Azure. Azure использует первый доступных IP-адресов в диапазоне в качестве шлюза по умолчанию. Поэтому если вы использовали 192.168.0.0/24 для подсети NAT, шлюз будет иметь 192.168.0.1. В маршрутизации конкретные маршруты будут заменяет wins, то есть этот маршрут ниже маршрута.

    * Маршрут 2
        * Интерфейс: Ethernet 2
        * Назначение: 10.0.0.0
        * Сетевая маска: 255.255.252.0
        * Шлюз: 10.0.1.1
        * Метрики: 256
        * Примечание: Это catch, которые все маршрутизации для трафика, предназначенные для наших подсоединена Azure. Он будет принудительно трафика второго сетевого адаптера. Вам потребуется добавить дополнительные маршруты для других диапазонов, вы хотите, чтобы ваш вложенных виртуальных машин для доступа к. Поэтому, если вы в локальной сети — 172.16.0.0/22, а затем вы можете иметь другое маршрут для отправки этого трафика второй сетевой Адаптер наших низкоуровневой оболочки.

## <a name="creating-a-route-table-within-azure"></a>Создание таблицу маршрутизации в Azure

См. в [этой статье](https://docs.microsoft.com/en-us/azure/virtual-network/tutorial-create-route-table-portal) более подробно о чтения на создание и управление ими маршруты в Azure.

1. Перейдите к https://portal.azure.com.
2. В верхнем левом углу выберите «Создать ресурс».
3. В поле поиска введите «Таблицу маршрутизации» и введите проверки нажатия.
4. Наилучших результатов будет таблицу маршрутизации, выберите этот параметр и затем выберите «Создать»
5. Имя в таблицу маршрутизации, в моем случае я с именем его «Маршруты для вложенные-виртуальные машины».
6. Убедитесь, что выбран той же подписки, в котором узлы Hyper-V.
7. Создайте новую группу ресурсов или выберите существующий и убедитесь, что область, созданные в таблицу маршрутизации в той же области, который располагается на узле Hyper-V в.
8. Выберите «Создать».

## <a name="configuring-the-route-table"></a>Настройка в таблицу маршрутизации

1. Перейдите в таблицу маршрутизации, мы только что создали. Это можно сделать, выполнив поиск имени в таблицу маршрутизации на панели поиска в центре верхней части портала.
2. После выбора в таблицу маршрутизации перейдите в раздел «Маршруты» из в колонке "".
3. Выберите «Добавить».
4. Задайте имя вашего маршрута, I пошло с «Nested-виртуальные машины».
5. Для адреса префикс ввода диапазона IP-адресов для наших «с плавающей запятой» подсети. В этом случае он будет 10.0.2.0/24.
6. Для «Следующего прыжка тип» выберите «Виртуального устройства», а затем введите IP-адресов адреса для Hyper-V размещается второй сетевой Адаптер, который может быть 10.0.1.4 и нажмите кнопку «ОК».
7. Теперь из в колонке выберите «Подсетей», это будет непосредственно под «Маршруты».
8. Выберите «Связать», выберите наших подсоединена «Nested-развлечений» и нажмите кнопку «Azure — виртуальных машин» подсети и нажмите кнопку «ОК».
9. Выполните эти же действия для подсети, наши узла Hyper-V находится на также как и в случае других подсетей, которым требуется доступ к вложенных виртуальных машин. При подключении 

# <a name="end-state-configuration-reference"></a>Справочник по конфигурации конечного состояния
Среда в этом руководстве ниже конфигураций. Этот раздел представляет inteded для использования в качестве ссылки.

1. Сведения о Azure виртуальной сети.
    * Конфигурации подсоединена высокого уровня.
        * Имя: Вложенные удовольствие
        * Адресное пространство: 10.0.0.0/22
        * Примечание: Это будет состоять из четырех подсетей. Кроме того эти диапазоны не заданы открыв панель инструментов. Вы можете решить среду, однако требуется. 

    * Первый подсети высокого уровня конфигурации.
        * Имя: NAT
        * Адресное пространство: 10.0.0.0/24
        * Примечание: Это где наши Hyper-V размещается основного сетевого Адаптера находится. Это будет использоваться для обработки исходящего трафика NAT для вложенных виртуальных машин. Он будет шлюза к Интернету для вашего вложенных виртуальных машин.

    * Второй подсети высокого уровня конфигурации.
        * Имя: Hyper-V-локальной сети
        * Адресное пространство: 10.0.1.0/24
        * Примечание: Наши Hyper-V на узле будет второй сетевой Адаптер, который будет использоваться для обработки маршрутизацию между вложенных виртуальных машин и не Интернет-ресурсы, внешней по отношению к узлу Hyper-V.

    * Третий подсети высокого уровня конфигурации.
        * Имя: синхронизирован.
        * Адресное пространство: 10.0.2.0/24
        * Примечание: Это будет «с плавающей запятой» подсети. Адресное пространство будет обрабатываться наших вложенных виртуальных машин и существует для обработки объявлений маршрутов вернуться к локальным. Фактически не виртуальные машины будут развернуты в подсети.

    * Четвертый подсети высокого уровня конфигурации.
        * Имя:-Виртуальных машинах Azure
        * Адресное пространство: 10.0.3.0/24
        * Примечание: Подсети, содержащего виртуальные машины Azure.

1. Наши узла Hyper-V имеет ниже Сетевых конфигураций.
    * Основной сетевой КАРТЫ 
        * IP-адрес: 10.0.0.4
        * Маска подсети: 255.255.255.0
        * Основной шлюз: 10.0.0.1
        * DNS-сервер: Настроен для DHCP
        * Включена пересылка IP-адрес: нет

    * Вспомогательные сетевого Адаптера
        * IP-адрес: 10.0.1.4
        * Маска подсети: 255.255.255.0
        * Основной шлюз: пустой
        * DNS-сервер: Настроен для DHCP
        * Включена пересылка IP-адрес: Да

    * Hyper-V создания сетевых КАРТ для внутреннего виртуального коммутатора
        * IP-адрес: 10.0.2.1
        * Маска подсети: 255.255.255.0
        * Основной шлюз: пустой

3. Наши таблицу маршрутизации будет иметь одно правило.
    * Правило 1
        * Имя: Вложенные ВМ
        * Назначение: 10.0.2.0/24
        * Следующего перехода: Виртуальные устройства - 10.0.1.4

## <a name="conclusion"></a>Заключение

Теперь можно будет развернуть виртуальной машины (даже 32-разрядных виртуальной Машины!) в узел Hyper-V и сделать его доступным от локальных и в Azure.
