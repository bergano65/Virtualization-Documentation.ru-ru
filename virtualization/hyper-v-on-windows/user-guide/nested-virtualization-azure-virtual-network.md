---
title: Настройка вложенных виртуальных машин для взаимодействия непосредственно с ресурсами в виртуальной сети Azure
description: Вложенная виртуализация
keywords: Windows 10, Hyper-v, Azure
author: mrajess
ms.date: 12/10/2018
ms.topic: article
ms.prod: windows-10-hyperv
ms.service: windows-10-hyperv
ms.assetid: 1ecb85a6-d938-4c30-a29b-d18bd007ba08
ms.openlocfilehash: efd180c458457da1cea6b379e21ba3a37083d15a
ms.sourcegitcommit: 1ca9d7562a877c47f227f1a8e6583cb024909749
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/04/2019
ms.locfileid: "74910964"
---
# <a name="configure-nested-vms-to-communicate-with-resources-in-an-azure-virtual-network"></a>Настройка вложенных виртуальных машин для взаимодействия с ресурсами в виртуальной сети Azure

Исходным руководством по развертыванию и настройке вложенных виртуальных машин в Azure требуется доступ к этим виртуальным машинам через коммутатор NAT. Это предоставляет ряд ограничений.

1. Вложенные виртуальные машины не могут получить доступ к ресурсам в локальной среде или в виртуальной сети Azure.
2. Локальные ресурсы или ресурсы в Azure могут обращаться только к вложенным виртуальным машинам через NAT, что означает, что несколько гостей не могут совместно использовать один и тот же порт.

В этом документе рассматривается развертывание, в котором мы используем использование RRAS, определяемые пользователем маршруты, подсеть, выделенная для исходящего трафика NAT, чтобы разрешить гостевой доступ к Интернету, а также "плавающее" адресное пространство, разрешающее поведение вложенных виртуальных машин и взаимодействие с ними как с любой другой виртуальной машиной. развертывается непосредственно в виртуальной сети в Azure.

Перед началом этого руководство выполните следующие действия.

1. Ознакомьтесь с [предоставленными здесь инструкциями](https://docs.microsoft.com/azure/virtual-machines/windows/nested-virtualization) по вложенной виртуализации.
2. Прочтите всю статью до реализации.

## <a name="high-level-overview-of-what-were-doing-and-why"></a>Высокоуровневый обзор того, что мы делаем и почему
* Мы создадим виртуальную машину с поддержкой вложенности с двумя сетевыми картами. 
* Одна сетевая карта будет использоваться для предоставления вложенным виртуальным машинам доступа к Интернету через NAT, а другая сетевая карта будет использоваться для маршрутизации трафика от внутреннего коммутатора к ресурсам, внешним по отношению к гипервизору. Каждая сетевая карта должна находиться в другом домене маршрутизации, то есть в другой подсети.
* Это означает, что нам потребуется виртуальная сеть с как минимум тремя подсетями. Один для NAT, один для маршрутизации по локальной сети, а другой — не используется, но является "зарезервированным" для вложенных виртуальных машин. Для подсетей в этом документе используются имена, "NAT", "Hyper-V-LAN" и "фантомные".
* Размер этих подсетей задается по собственному усмотрению, но есть некоторые соображения. Размер "фантомных" подсетей определяет количество IP-адресов для вложенных виртуальных машин. Кроме того, размер подсетей "NAT" и "Hyper-V-LAN" определяет количество IP-адресов для низкоуровневых оболочек. Так что вы могли бы делать в действительности небольшие подсети, если бы вы планировали только одну или две низкоуровневые оболочки.
* Фоновый режим. во вложенных виртуальных машинах не будут получены DHCP из виртуальной сети, к которой подключен узел, даже если настроен внутренний или внешний коммутатор. 
  * Это означает, что узел Hyper-V должен предоставлять DHCP.
* Узел Hyper-V не имеет информации о назначенных в данный момент арендх в виртуальной сети, поэтому во избежание ситуации, когда узел назначает уже имеющийся IP-адрес, необходимо выделить блок IP-адресов, который будет использоваться только этим узлом. Это позволит нам избежать дублирования сценария IP.
  * Выбранный блок IP-адресов будет соответствовать подсети в той же виртуальной сети, в которой находится ваша система
  * Причина, по которой это должно соответствовать существующей подсети, заключается в обработке объявлений BGP обратно через ExpressRoute. Если мы только что создали диапазон IP-адресов для узла Hyper-V, нам пришлось бы создать ряд статических маршрутов, чтобы разрешить клиентам в локальной системе взаимодействовать с вложенными виртуальными машинами. Это означает, что это не является жестким требованием, так как можно сделать диапазон IP-адресов для вложенных виртуальных машин, а затем создать все маршруты, необходимые для направления клиентов на узел Hyper-V для этого диапазона.
* Мы создадим внутренний коммутатор в Hyper-V, и затем создадим созданный интерфейс IP-адрес в диапазоне, заданном для DHCP. Этот IP-адрес станет шлюзом по умолчанию для наших вложенных виртуальных машин и будет использоваться для маршрутизации между внутренним коммутатором и сетевым адаптером узла, подключенного к нашей виртуальной сети.
* На узле будет установлена роль маршрутизации и удаленного доступа, которая преобразует наш узел в маршрутизатор.  Это необходимо, чтобы обеспечить взаимодействие между ресурсами, внешними по отношению к узлу, и нашим вложенным виртуальным машинам.
* Мы будем сообщать другим ресурсам о том, как получить доступ к этим вложенным виртуальным машинам. Это требует создания определяемой пользователем таблицы маршрутов, содержащей статический маршрут для диапазона IP-адресов, в котором находятся вложенные виртуальные машины. Этот статический маршрут указывает на IP-адрес, который будет указывать на этот маршрутизатор.
* Затем этот UDR будет помещен в подсеть шлюза, чтобы клиенты, поступающие из локальной среды, узнают, как достигать наших вложенных виртуальных машин.
* Кроме того, этот UDR будет помещен в любую другую подсеть в Azure, которая требует подключения к вложенным виртуальным машинам.
* Для нескольких узлов Hyper-V вы создадите дополнительные "плавающие" подсети и добавите в UDR дополнительный статический маршрут.
* При списании узла Hyper-V будет удалена и переназначена наша "Плавающая" подсеть, а также удален статический маршрут от нашего UDR, или если это последний узел Hyper-V, удалите UDR.

## <a name="creating-the-host"></a>Создание основного приложения

Я буду заключать все значения конфигурации, которые являются личными предпочтениями, такими как имя виртуальной машины, Группа ресурсов и т. д.

1. Перейдите по адресу portal.azure.com
2. Щелкните "создать ресурс" в верхнем левом углу.
3. Выберите "Windows Server 2016 VM" из популярного столбца
4. На вкладке "основы" обязательно выберите размер виртуальной машины, который может быть вложен в виртуализацию.
5. Переход на вкладку "Сетевые подключения"
6. Создайте новую виртуальную сеть со следующей конфигурацией.
    * Адресное пространство виртуальной сети: 10.0.0.0/22
    * Подсеть 1
        * Имя: NAT
        * Адресное пространство: 10.0.0.0/24.
    * Подсеть 2
        * Имя: Hyper-V-LAN
        * Адресное пространство: 10.0.1.0/24.
    * Подсеть 3
        * Имя: фантомная копия
        * Адресное пространство: 10.0.2.0/24.
    * Подсеть 4
        * Имя: Azure-VMS
        * Адресное пространство: 10.0.3.0/24.
7. Убедитесь, что выбрана подсеть NAT для виртуальной машины.
8. Перейдите к разделу "Проверка и создание" и выберите "создать".

## <a name="create-the-second-network-interface"></a>Создание второго сетевого интерфейса
1. После завершения подготовки виртуальной машины перейдите на нее на портале Azure.
2. Остановка виртуальной машины
3. После остановки перейдите в раздел "сети" в разделе "Параметры".
4. "Подключение сетевого интерфейса"
5. "Создать сетевой интерфейс"
6. Присвойте ему имя (не имеет значения, что вы назначите имя, но обязательно запомните его).
7. Выберите "Hyper-V-LAN" для подсети
8. Убедитесь, что выбрана та же группа ресурсов, в которой находится ваш узел.
9. Создания
10. Это приведет к переходу на предыдущий экран, выберите только что созданный сетевой интерфейс и нажмите кнопку "ОК".
11. Вернитесь в область "Обзор" и снова запустите виртуальную машину после завершения предыдущего действия.
12. Перейдите ко второй только что созданной сетевой карте. ее можно найти в выбранной ранее группе ресурсов.
13. Перейдите в раздел "конфигурации IP" и переключайте IP-пересылку в состояние "включено" и сохраните изменения.

## <a name="setting-up-hyper-v"></a>Настройка Hyper-V
1. Удаленное размещение в узле
2. Открытие командной строки PowerShell с повышенными привилегиями
3. Выполните команду `Install-WindowsFeature -Name Hyper-V -IncludeManagementTools -Restart`.
4. Это приведет к перезапуску узла
5. Повторно подключитесь к узлу, чтобы продолжить установку.

## <a name="creating-our-virtual-switch"></a>Создание виртуального коммутатора

1. Откройте PowerShell в административном режиме.
2. Создание внутреннего коммутатора: `New-VMSwitch -Name "NestedSwitch" -SwitchType Internal`
3. Назначить только что созданному интерфейсу IP-адрес: `New-NetIPAddress –IPAddress 10.0.2.1 -PrefixLength 24 -InterfaceAlias "vEthernet (NestedSwitch)"`

## <a name="install-and-configure-dhcp"></a>Установка и настройка DHCP

*Многие люди пропустили этот компонент при первой попытке приступить к работе вложенной виртуализации. В отличие от локальной среды, в которой Гостевые виртуальные машины будут получать DHCP от сети, в которой находится ваш узел, во вложенных виртуальных машинах в Azure необходимо предоставить DHCP через узел, на котором они выполняются. Это также необходимо для статического назначения IP-адреса каждой вложенной виртуальной машине, которая не масштабируется.*

1. Установка роли DHCP: `Install-WindowsFeature DHCP -IncludeManagementTools`
2. Создайте область DHCP: `Add-DhcpServerV4Scope -Name "Nested VMs" -StartRange 10.0.2.2 -EndRange 10.0.2.254 -SubnetMask 255.255.255.0`
3. Настройте параметры DNS и шлюза по умолчанию для области: `Set-DhcpServerV4OptionValue -DnsServer 168.63.129.16 -Router 10.0.2.1`
    * Если разрешение имен должно работать, обязательно введите допустимый DNS-сервер. В этом случае я использую [рекурсивный DNS-сервер Azure](https://docs.microsoft.com/azure/virtual-network/virtual-networks-name-resolution-for-vms-and-role-instances).

## <a name="installing-remote-access"></a>Установка удаленного доступа

1. Откройте диспетчер сервера и выберите "Добавить роли и компоненты".
2. Нажмите кнопку "Далее", пока не получите "роли сервера".
3. Установите флажок "удаленный доступ" и нажмите кнопку "Далее", пока не появится пункт "службы ролей".
4. Установите флажок "Маршрутизация", выберите "Добавить компоненты", а затем нажмите кнопку "Далее", а затем — "установить". Завершите работу мастера и дождитесь завершения установки.

## <a name="configuring-remote-access"></a>Настройка удаленного доступа

1. Откройте диспетчер сервера и выберите "Инструменты", а затем выберите "Маршрутизация и удаленный доступ".
2. В левой части панели управления маршрутизацией и удаленным доступом вы увидите значок с именем сервера рядом с ним, щелкните его правой кнопкой мыши и выберите пункт "настроить и включить маршрутизацию и удаленный доступ".
3. В мастере нажмите кнопку "Далее", установите флажок радиально для кнопки "Настраиваемая конфигурация", а затем нажмите кнопку "Далее".
4. Проверьте "NAT" и "Маршрутизация по локальной сети", а затем нажмите кнопку "Далее", а затем "Готово". Если будет предложено запустить службу, сделайте это.
5. Теперь перейдите к узлу "IPv4" и разверните его, чтобы узел "NAT" стал доступным.
6. Щелкните правой кнопкой мыши "NAT" и выберите "новый интерфейс..." и выберите "Ethernet", это должна быть первая сетевая карта с IP-адресом "10.0.0.4"
7. Теперь необходимо создать статические маршруты, чтобы принудительно настроить сетевой трафик для второй сетевой карты. Для этого перейдите к узлу "статические маршруты" в разделе "IPv4".
8. После этого создадим следующие маршруты.
    * Маршрут 1
        * Интерфейс: Ethernet
        * Назначение: 10.0.0.0
        * Маска сети: 255.255.255.0
        * Шлюз: 10.0.0.1
        * Метрика: 256
        * Примечание. мы помещаем это сюда, чтобы разрешить основному сетевому адаптеру отвечать на трафик, предназначенный для его собственного интерфейса. Если мы не сделали этого, следующий маршрут приведет к тому, что для сетевого адаптера 1 будет выдаваться сетевой адаптер 2. При этом создается асимметричный маршрут. 10.0.0.1 — это IP-адрес, назначенный Azure подсети NAT. Azure использует первый доступный IP-адрес в диапазоне в качестве шлюза по умолчанию. Поэтому, если для подсети NAT использовался протокол 192.168.0.0/24, шлюз будет иметь значение 192.168.0.1. При маршрутизации более конкретного маршрута WINS означает, что этот маршрут будет перенаправлены ниже.

    * Маршрут 2
        * Интерфейс: Ethernet 2
        * Назначение: 10.0.0.0
        * Маска сети: 255.255.252.0
        * Шлюз: 10.0.1.1
        * Метрика: 256
        * Примечание. это перехватывать все маршруты для трафика, предназначенного для виртуальной сети Azure. Это приведет к принудительному трафику второй сетевой карты. Вам потребуется добавить дополнительные маршруты для других диапазонов, к которым будут обращаться ваши вложенные виртуальные машины. Поэтому, если вы используете локальную сеть 172.16.0.0/22, вам нужно получить другой маршрут для отправки этого трафика с второй сетевой карты гипервизора.

## <a name="creating-a-route-table-within-azure"></a>Создание таблицы маршрутов в Azure

Более подробные сведения о создании маршрутов и управлении ими в Azure см. в [этой статье](https://docs.microsoft.com/azure/virtual-network/tutorial-create-route-table-portal) .

1. Перейдите к https://portal.azure.com.
2. В верхнем левом углу выберите "создать ресурс".
3. В поле поиска введите "Таблица маршрутов" и нажмите клавишу ВВОД.
4. Верхний результат будет таблицей маршрутов, выберите это, а затем нажмите кнопку "создать".
5. Назовите таблицу маршрутов, в моем случае я назвал ее «Routes-for-Nested-VMS».
6. Убедитесь, что выбрана та же подписка, в которой находятся узлы Hyper-V.
7. Создайте новую группу ресурсов или выберите существующую, и убедитесь, что область, в которой создается таблица маршрутов, находится в том же регионе, в котором находится узел Hyper-V.
8. Нажмите кнопку "Создать".

## <a name="configuring-the-route-table"></a>Настройка таблицы маршрутов

1. Перейдите к только что созданной таблице маршрутов. Это можно сделать, выполнив поиск по имени таблицы маршрутов на панели поиска в верхнем центре портала.
2. После выбора таблицы маршрутов в колонке перейдите к «Routes» (маршруты).
3. Выберите "Добавить".
4. Присвойте имя маршруту, а затем — "Nested-VMS" (вложенные виртуальные машины).
5. В поле префикс адреса введите диапазон IP-адресов для "плавающей" подсети. В этом случае это будет 10.0.2.0/24.
6. В поле "тип следующего прыжка" выберите "виртуальный модуль", а затем введите IP-адрес узла Hyper-V вторая сетевая карта, которая будет 10.0.1.4, а затем нажмите кнопку "ОК".
7. Теперь в колонке выберите "подсети". это будет сразу ниже "маршруты".
8. Выберите "сопоставить", затем выберите нашу "вложенную" виртуальную сеть, а затем выберите подсеть "Azure-VMS" и нажмите кнопку "ОК".
9. Выполните этот же процесс для подсети, в которой находится наш узел Hyper-V, а также для других подсетей, которым требуется доступ к вложенным виртуальным машинам. Если подключение установлено 

# <a name="end-state-configuration-reference"></a>Ссылка на конфигурацию конечного состояния
Среда в этом разделе содержит приведенные ниже конфигурации. Этот раздел интедед использовать в качестве ссылки.

1. Сведения о виртуальной сети Azure.
    * Конфигурация высокого уровня виртуальной сети.
        * Имя: "вложенное — веселое"
        * Адресное пространство: 10.0.0.0/22
        * Примечание. это будет состоять из четырех подсетей. Кроме того, эти диапазоны не задаются в камень. Вы можете обращаться к вашей среде, но вам это нужно. 

    * Конфигурация верхнего уровня в первой подсети.
        * Имя: NAT
        * Адресное пространство: 10.0.0.0/24.
        * Примечание. здесь размещается основной сетевой адаптер Hyper-V. Он будет использоваться для управления исходящим NAT для вложенных виртуальных машин. Это будет шлюз к Интернету для вложенных виртуальных машин.

    * Вторая конфигурация высокого уровня подсети.
        * Имя: Hyper-V-LAN
        * Адресное пространство: 10.0.1.0/24.
        * Примечание. наш узел Hyper-V будет иметь вторую сетевую карту, которая будет использоваться для управления маршрутизацией между вложенными виртуальными машинами и ресурсами, не являющимися Интернетом, внешними по отношению к узлу Hyper-V.

    * Конфигурация верхнего уровня в третьем подсети.
        * Имя: фантомная копия
        * Адресное пространство: 10.0.2.0/24.
        * Примечание. это будет "Плавающая" подсеть. Адресное пространство будет использоваться вложенными виртуальными машинами и существует для обработки объявлений маршрутов обратно в локальную среду. В этой подсети фактически не будут развернуты виртуальные машины.

    * Высокоуровневая конфигурация четвертой подсети.
        * Имя: Azure-VMS
        * Адресное пространство: 10.0.3.0/24.
        * Примечание. подсеть, содержащая виртуальные машины Azure.

1. У нашего узла Hyper-V есть следующие конфигурации сетевых адаптеров.
    * Основной сетевой адаптер 
        * IP-адрес: 10.0.0.4
        * Маска подсети: 255.255.255.0
        * Шлюз по умолчанию: 10.0.0.1
        * DNS: настроено для DHCP
        * IP-пересылка включена: нет

    * Дополнительный сетевой адаптер
        * IP-адрес: 10.0.1.4
        * Маска подсети: 255.255.255.0
        * Шлюз по умолчанию: пустой
        * DNS: настроено для DHCP
        * IP-пересылка включена: Да

    * Hyper-V создал сетевой адаптер для внутреннего виртуального коммутатора
        * IP-адрес: 10.0.2.1
        * Маска подсети: 255.255.255.0
        * Шлюз по умолчанию: пустой

3. Таблица маршрутов будет иметь одно правило.
    * Правило 1
        * Имя: вложенные виртуальные машины.
        * Назначение: 10.0.2.0/24.
        * Следующий прыжок: виртуальное устройство — 10.0.1.4

## <a name="conclusion"></a>Заключение

Теперь вы можете развернуть виртуальную машину (даже 32-разрядную ВИРТУАЛЬную машину!) на узле Hyper-V и предоставить к ней доступ из локальной среды и в Azure.
