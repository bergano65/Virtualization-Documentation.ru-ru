---
title: Настройка вложенных виртуальных машин для непосредственного взаимодействия с ресурсами в виртуальной сети Azure
description: Вложенная виртуализация
keywords: Windows 10, Hyper-v и Azure
author: mrajess
ms.date: 12/10/2018
ms.topic: article
ms.prod: windows-10-hyperv
ms.service: windows-10-hyperv
ms.assetid: 1ecb85a6-d938-4c30-a29b-d18bd007ba08
ms.openlocfilehash: efd180c458457da1cea6b379e21ba3a37083d15a
ms.sourcegitcommit: c4a3f88d1663dd19336bfd4ede0368cb18550ac7
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/31/2019
ms.locfileid: "9883267"
---
# <a name="configure-nested-vms-to-communicate-with-resources-in-an-azure-virtual-network"></a>Настройка вложенных виртуальных машин для связи с ресурсами в виртуальной сети Azure

Исходное руководство по развертыванию и настройке вложенных виртуальных машин в Azure требуется для доступа к этим виртуальным машинам через коммутатор NAT. Это предоставляет ряд ограничений:

1. Вложенные виртуальные машины не могут получить доступ к локальным ресурсам или в виртуальной сети Azure.
2. Локальные ресурсы и ресурсы в Azure могут получать доступ к вложенным виртуальным машинам только через NAT, что означает, что несколько гостей не могут использовать один и тот же порт.

В этом документе будет рассмотрено развертывание, в результате чего мы будем использовать службу RRAS, пользовательские маршруты, подсеть, выделенную для исходящего NAT, чтобы разрешить гостевой доступ к Интернету, а также плавающее адресное пространство, позволяющее работать с вложенными компьютерами и взаимодействовать как любую другую виртуальную машину. Развертывание прямо в виртуальную сеть в Azure.

Перед началом этого руководства сделайте следующее:

1. Ознакомьтесь с рекомендациями, изложенными в [этой статье](https://docs.microsoft.com/azure/virtual-machines/windows/nested-virtualization) , для вложенной виртуализации.
2. Перед реализацией прочтите эту статью целиком.

## <a name="high-level-overview-of-what-were-doing-and-why"></a>Высокоуровневый обзор того, что мы делаем и почему
* Мы создадим виртуальную машину с возможностью вложения с двумя адаптерами. 
* Одна сетевая плата будет использоваться для предоставления вложенных виртуальных машин через Интернет через NAT, и другая сетевая плата будет использоваться для маршрутизации трафика с внутреннего коммутатора на ресурсы, внешние для гипервизора. Каждая сетевая плата должна находиться в другом домене маршрутизации, что означает другую подсеть.
* Это значит, что нам понадобится виртуальная сеть, сопоставленная с минимальными тремя подсетями. Один для NAT, для сетевой маршрутизации и для одной из них, но является зарезервированным для вложенных виртуальных машин. Для подсетей в этом документе используются названия "NAT", "Hyper-V-LAN" и "Ghost".
* Размер этих подсетей по своему усмотрению, но есть некоторые соображения. Размер подсетей с фантомными сведениями определяет, сколько IP для них вы хотите использовать для вложенных виртуальных машин. Кроме того, размер подсетей "NAT" и "Hyper-V-LAN" определяет количество IP-адресов, которые вы хотите использовать для гипервизоров. Таким образом, если вы планируете использовать один или два гипервизора, вы можете делать это очень маленькие подсети.
* Фон: вложенные виртуальные машины не будут получать DHCP из виртуальной сети, к которой они подключены, даже если вы настроили внутренний или внешний коммутатор. 
  * Это означает, что узел Hyper-V должен предоставлять DHCP.
* Узел Hyper-V не знает о назначенных в настоящее время арендх в виртуальной сети, поэтому в целях предотвращения ситуации, когда узел назначает IP-адрес уже есть, необходимо выделить блок IP-адресов, который будет использоваться только ведущим узлом. Это позволит нам избежать дублирования сценария IP.
  * Блок IP-адресов, который мы выбираем, соответствует подсети в той же виртуальной среде, в которой находится ваша система.
  * Причина, по которой этот вариант должен соответствовать существующей подсети, — обработка объявлений BGP обратно в ExpressRoute. Если мы соработали диапазон IP-адресов для узла Hyper-V, вам пришлось создать ряд статических маршрутов, чтобы клиенты могли взаимодействовать с вложенными виртуальными машинами в локальной системе. Это означает, что это не является обязательным требованием, так как вы можете сделать диапазон IP-адресов для вложенных виртуальных машин, а затем создать все маршруты, необходимые для направления клиентов на узел Hyper-V для этого диапазона.
* Мы создадим внутренний коммутатор в Hyper-V, и затем назначаете созданный интерфейс IP-адресом в диапазоне, который мы задали для DHCP. Этот IP-адрес станет шлюзом по умолчанию для вложенных виртуальных машин и использован для маршрутизации между внутренним коммутатором и сетевым адаптером узла, подключенного к нашей виртуальной сети.
* Мы установим на узле роль маршрутизации и удаленного доступа, которая будет превратить наш узел в маршрутизатор.  Это необходимо для того, чтобы обеспечить связь между ресурсами, находящегося вне хоста, и нашими вложенными виртуальными машинами.
* Мы будем сообщать другим ресурсам о том, как получить доступ к этим вложенным виртуальным машинам. Это необходимо для того, чтобы создать таблицу маршрутов, определенную пользователем, которая включает статический маршрут для диапазона IP-адресов, в котором находятся вложенные виртуальные машины. Этот статический маршрут будет указывать на IP-адрес для Hyper-V.
* Затем вы сможете поместить этот УДР в подсеть шлюза, чтобы клиенты, поступающие из локальной сети, знали, как достичь наших вложенных виртуальных машин.
* Вы также можете поместить этот УДР в любую другую подсеть в Azure, для которой требуется подключение к вложенным виртуальным машинам.
* Для нескольких узлов Hyper-V вы можете создать дополнительные "перемещаемые" подсети и добавить к УДР дополнительный статический маршрут.
* После списания узла Hyper-V вы удаляете и перенаправляете эту "плавающую" подсеть, а также удаляете статический маршрут из нашего УДР или, если это последний узел Hyper-V, удалите УДР вообще.

## <a name="creating-the-host"></a>Создание узла

Будут вычислены все значения конфигурации, которые настроены в соответствии с личными предпочтениями, такими как имя ВМ, Группа ресурсов и т. д.

1. Переход к portal.azure.com
2. Щелкните "создать ресурс" в верхнем левом углу
3. Выберите "Windows Server 2016 VM" из популярного столбца
4. На вкладке "основные" не забудьте выбрать размер виртуальной машины, поддерживающей вложенную виртуализацию.
5. Переход на вкладку "сеть"
6. Создать виртуальную сеть со следующей конфигурацией
    * Адресное пространство VNet: 10.0.0.0/22
    * Подсеть 1
        * Name (имя): NAT
        * Адресное пространство: 10.0.0.0/24
    * Подсеть 2
        * Name (имя): Hyper-V-LAN
        * Адресное пространство: 10.0.1.0/24
    * Подсеть 3
        * Name (имя): Ghost
        * Адресное пространство: 10.0.2.0/24
    * Подсеть 4
        * Name (имя): Azure — VMS
        * Адресное пространство: 10.0.3.0/24
7. Убедитесь в том, что вы выбрали подсеть NAT для виртуальной машины.
8. Перейдите к разделу "Проверка + создание" и выберите "создать"

## <a name="create-the-second-network-interface"></a>Создание второго сетевого интерфейса
1. После завершения подготовки к просмотру виртуальной машины в портале Azure
2. Остановка виртуальной машины
3. После остановки перейдите в раздел "сеть" в разделе "Параметры"
4. "Присоединиться к сетевому интерфейсу"
5. "Создать сетевой интерфейс"
6. Присвойте ему имя (не имеет значения, которому вы присвоены имя, но не забудьте его)
7. Выберите "Hyper-V-LAN" для подсети
8. Убедитесь в том, что вы выбрали ту же группу ресурсов, в которой находится ваш узел.
9. Заново
10. Откроется предыдущий экран, убедитесь, что выбран только что созданный сетевой интерфейс, и нажмите кнопку ОК.
11. Вернитесь в область "Обзор" и снова запустите VM после завершения предыдущего действия.
12. Перейдите на вторую сетевую карту, которую вы только что создали, вы можете найти ее в выбранной ранее группе ресурсов.
13. Перейдите в раздел "IP-конфигурации" и установите переключатель "IP-датаграммы" в положение "включено", а затем сохраните изменения.

## <a name="setting-up-hyper-v"></a>Настройка Hyper-V
1. Удаленный на своем узле
2. Открытие запроса PowerShell с повышенными привилегиями
3. Выполните следующую команду: `Install-WindowsFeature -Name Hyper-V -IncludeManagementTools -Restart`
4. Узел будет перезапущен
5. Переподключение к узлу для продолжения оставшейся части настройки

## <a name="creating-our-virtual-switch"></a>Создание виртуального коммутатора

1. Откройте PowerShell в режиме администратора.
2. Создайте внутренний коммутатор: `New-VMSwitch -Name "NestedSwitch" -SwitchType Internal`
3. Назначить только что созданному интерфейсу IP-адрес: `New-NetIPAddress –IPAddress 10.0.2.1 -PrefixLength 24 -InterfaceAlias "vEthernet (NestedSwitch)"`

## <a name="install-and-configure-dhcp"></a>Установка и настройка DHCP

*Многие люди пропустили этот компонент при первой попытке установить вложенную виртуализацию. В некоторых случаях, когда гостевые ВМ будут получать DHCP из сети, в которой находится ваш узел, вложенные виртуальные машины в Azure должны предоставлять DHCP через узел, на котором они запущены. Вам или вам нужно статически назначить IP-адрес для всех вложенных виртуальных машин, которые не масштабируются.*

1. Установите роль DHCP: `Install-WindowsFeature DHCP -IncludeManagementTools`
2. Создайте область DHCP. `Add-DhcpServerV4Scope -Name "Nested VMs" -StartRange 10.0.2.2 -EndRange 10.0.2.254 -SubnetMask 255.255.255.0`
3. Настройте параметры шлюза DNS и адрес по умолчанию для области. `Set-DhcpServerV4OptionValue -DnsServer 168.63.129.16 -Router 10.0.2.1`
    * Если вы хотите, чтобы разрешение имен работало, убедитесь, что правильно введен DNS-сервер. В этом случае я использую [рекурсивный DNS-сервер Azure](https://docs.microsoft.com/azure/virtual-network/virtual-networks-name-resolution-for-vms-and-role-instances).

## <a name="installing-remote-access"></a>Установка удаленного доступа

1. Откройте Диспетчер серверов и выберите "Добавить роли и компоненты".
2. Нажмите "Далее", пока не получите "роли сервера".
3. Установите флажок "удаленный доступ" и нажмите кнопку "Далее", пока не появится значение "службы ролей".
4. Установите флажок "Маршрутизация", нажмите кнопку "добавить возможности", а затем нажмите "Далее", а затем "установить". Завершите работу мастера и дождитесь завершения установки.

## <a name="configuring-remote-access"></a>Настройка удаленного доступа

1. Откройте Диспетчер серверов и выберите пункт "Инструменты", а затем — "Маршрутизация и удаленный доступ".
2. В левой части панели управления "Маршрутизация и удаленный доступ" вы увидите значок с именем сервера рядом с ним, щелкните его правой кнопкой мыши и выберите пункт "настроить и включить маршрутизацию и удаленный доступ".
3. В окне мастера нажмите кнопку "Далее", установите флажок "радиальная Настройка", а затем нажмите "Далее".
4. Проверьте "NAT" и "маршрутизация ЛВС", а затем нажмите "Далее", а затем "Готово". Если появится запрос на запуск службы, сделайте это.
5. Теперь перейдите к узлу "IPv4" и разверните его, чтобы сделать узел "NAT" доступным.
6. Щелкните правой кнопкой мыши "NAT" и выберите "создать интерфейс..." и выберите "Ethernet", это первая сетевая карта с IP-адресом "10.0.0.4"
7. Теперь необходимо создать статические маршруты, чтобы принудительно настроить сетевой трафик для второй NIC. Для этого перейдите на узел "статические маршруты" в разделе "IPv4".
8. После этого мы создадим следующие маршруты.
    * Маршрут 1
        * Интерфейс: Ethernet
        * Назначение: 10.0.0.0
        * Маска сети: 255.255.255.0
        * Шлюз: 10.0.0.1
        * Метрическая система мер: 256
        * Примечание. Мы разместите этот здесь, чтобы разрешить основному сетевому адаптеру отвечать на трафик, направленный на его собственный интерфейс. Если это не так, следующий маршрут может привести к тому, что для сетевого адаптера 1 будет выступающий NIC 2. Это создаст асимметричный маршрут. 10.0.0.1 — это IP-адрес, назначаемый службой Azure подсети NAT. Azure использует первый доступный IP-адрес в диапазоне как шлюз по умолчанию. Таким образом, если вы использовали для подсети NAT протокол 192.168.0.0/24, шлюз будет иметь значение 192.168.0.1. Находящуюся в маршруте более конкретный маршрут WINS, это означает, что этот маршрут будет передаваться под этим маршрутом.

    * Маршрут 2
        * Интерфейс: Ethernet 2
        * Назначение: 10.0.0.0
        * Маска сети: 255.255.252.0
        * Gateway: 10.0.1.1
        * Метрическая система мер: 256
        * Примечание. Этот маршрут catch all для трафика, предназначенный для виртуальной сети Azure. Это приведет к принудительному трафику второй NIC. Вам потребуется добавить дополнительные маршруты для других диапазонов, к которым вы хотите предоставить доступ к вложенным виртуальным машинам. Таким образом, если вы используете локальную сеть 172.16.0.0/22, вы хотите использовать другой маршрут для отправки этого трафика на второй NIC нашего гипервизора.

## <a name="creating-a-route-table-within-azure"></a>Создание таблицы маршрутов в Azure

Ознакомьтесь с [этой статьей](https://docs.microsoft.com/azure/virtual-network/tutorial-create-route-table-portal) , в которой подробно описан процесс создания и управления маршрутами в Azure.

1. Перейдите к https://portal.azure.com.
2. В левом верхнем углу выберите "создать ресурс".
3. В поле поиска введите "маршрутная таблица" и нажмите клавишу ВВОД.
4. В верхней части будет указана таблица маршрутов, выберите ее и нажмите кнопку "создать".
5. Присвойте имя таблице маршрутов, в случае я назвал ее "маршруты — вложенные виртуальные машины".
6. Убедитесь, что вы выбрали ту же подписку, в которой находятся ваши узлы Hyper-V.
7. Создайте новую группу ресурсов или выберите существующую, и убедитесь в том, что область, в которой создана таблица маршрутов, находится в той же области, в которой находится ваш узел Hyper-V.
8. Нажмите кнопку "создать".

## <a name="configuring-the-route-table"></a>Настройка таблицы маршрутов

1. Перейдите к таблице маршрутов, которую мы только что создали. Это можно сделать, выполнив поиск по имени таблицы маршрутов на панели поиска в верхней части портала.
2. После того как вы выберете таблицу маршрутов, перейдите на вкладку "маршруты" в колонке.
3. Нажмите кнопку "Добавить".
4. Присвойте имя маршруту, а затем — "вложенные виртуальные машины".
5. Для ввода префикса адреса — диапазон IP-адресов для "плавающей" подсети. В этом случае будет использоваться 10.0.2.0/24.
6. В поле "тип следующего прыжка" выберите "виртуальный управляющий элемент", а затем введите IP-адрес второго сетевого адаптера Hyper-V (10.0.1.4) и нажмите кнопку "ОК".
7. Теперь в блейд-приложении выберите "подсети", и это будет сразу под надписью "маршруты".
8. Выберите "связать", затем выберите "вложенное" виртуальное подключение и выберите подсеть "Azure-VMS" и нажмите кнопку "ОК".
9. Сделайте тот же процесс для подсети, на котором находится наш узел Hyper-V, так и для других подсетей, которым требуется доступ к вложенным виртуальным машинам. Если подключение установлено 

# <a name="end-state-configuration-reference"></a>Справочник по конфигурации конечного состояния
Ниже перечислены конфигурации среды в этом руководстве. Этот раздел интедед использовать в качестве ссылки.

1. Сведения о виртуальной сети Azure.
    * Конфигурация высшего уровня VNet.
        * Name (имя): вложенные развлечения
        * Адресное пространство: 10.0.0.0/22
        * Примечание. это будет состоять из четырех подсетей. Кроме того, эти диапазоны не задаются в камень. Вы можете решить свою среду, но вам нужно. 

    * Настройка верхнего уровня для первой подсети.
        * Name (имя): NAT
        * Адресное пространство: 10.0.0.0/24
        * Примечание. в этой статье описывается, где располагается основная сетевая плата для Hyper-V. Это будет использоваться для обработки исходящего NAT для вложенных виртуальных машин. Это будет шлюз к Интернету для вложенных виртуальных машин.

    * Вторая конфигурация высокого уровня подсети.
        * Name (имя): Hyper-V-LAN
        * Адресное пространство: 10.0.1.0/24
        * Примечание. у нашего узла Hyper-V есть вторая сетевая карта, которая будет использоваться для обработки маршрутизации между вложенными виртуальными машинами и неинтернет-ресурсами, внешними по отношению к узлу Hyper-V.

    * Третья Конфигурация высокого уровня подсети.
        * Name (имя): Ghost
        * Адресное пространство: 10.0.2.0/24
        * Примечание. это будет "Плавающая" подсеть. Адресное пространство будет использоваться вложенными виртуальными машинами и существует для обработки объявлений маршрутов обратно на локальный. В этой подсети фактически не будут развертываться виртуальные компьютеры.

    * Конфигурация верхнего уровня в четвертой подсети.
        * Name (имя): Azure — VMS
        * Адресное пространство: 10.0.3.0/24
        * Примечание: подсеть, содержащая виртуальные машины Azure.

1. На нашем узле Hyper-V имеются указанные ниже конфигурации сетевых адаптеров.
    * Основная сетевая карта 
        * IP-адрес: 10.0.0.4
        * Маска подсети: 255.255.255.0
        * Шлюз по умолчанию: 10.0.0.1
        * DNS: настроено для DHCP
        * Переадресация IP включена: нет

    * Дополнительная сетевая плата
        * IP-адрес: 10.0.1.4
        * Маска подсети: 255.255.255.0
        * Шлюз по умолчанию: пустой
        * DNS: настроено для DHCP
        * Переадресация IP включена: Да

    * Служба Hyper-V создала NIC для внутреннего виртуального коммутатора
        * IP-адрес: 10.0.2.1
        * Маска подсети: 255.255.255.0
        * Шлюз по умолчанию: пустой

3. Наша таблица маршрутов будет иметь одно правило.
    * Правило 1
        * Имя: вложенные виртуальные машины
        * Destination (назначение): 10.0.2.0/24
        * Следующий прыжок: виртуальное устройство — 10.0.1.4

## <a name="conclusion"></a>Заключение

Теперь вы можете развернуть виртуальную машину (даже с 32-битным ВМ!) на узле Hyper-V и получить доступ к нему из локальной среды и в Azure.
