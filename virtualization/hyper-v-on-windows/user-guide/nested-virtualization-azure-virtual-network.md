---
title: Настройка вложенных виртуальных машин связываться напрямую по ресурсов в Azure виртуальной сети
description: Вложенная виртуализация
keywords: Windows 10, hyper-v, Azure
author: mrajess
ms.date: 12/10/2018
ms.topic: article
ms.prod: windows-10-hyperv
ms.service: windows-10-hyperv
ms.assetid: 1ecb85a6-d938-4c30-a29b-d18bd007ba08
ms.openlocfilehash: c39a2e5639d013a0aba15150117b7ab18ea32f97
ms.sourcegitcommit: 1aef193cf56dd0870139b5b8f901a8d9808ebdcd
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/11/2019
ms.locfileid: "9001660"
---
# <a name="configure-nested-vms-to-communicate-with-resources-in-an-azure-virtual-network"></a>Настройка вложенных виртуальных машин для связи с ресурсами Azure виртуальной сети

Исходный рекомендации о развертывании и настройке вложенных виртуальных машин Azure требуются доступ этих виртуальных машин через коммутатор NAT. Это предоставляет некоторые ограничения:

1. Вложенные виртуальные машины не имеют доступа к локальным ресурсам или в Azure виртуальной сети.
2. Локальных ресурсов или ресурсов в Azure доступны только вложенных виртуальных машин через NAT, это означает, что несколько гостевые ОС не могут совместно использовать тот же порт.

В этом документе поможет выполнить развертывание, при котором мы используются RRAS, некоторые маршрутов определенного пользователя и «с плавающей запятой» адресное пространство разрешить вложенных виртуальных машин работают и взаимодействовать как всех других виртуальных машин, развернутых непосредственно на подсоединена в Azure.

Перед запуском см в этом руководстве:

1. Читать [руководство предоставленной здесь](https://docs.microsoft.com/en-us/azure/virtual-machines/windows/nested-virtualization) о вложенной виртуализации, создание виртуальных машин вложенности поддержкой и установите роль Hyper-V в этих виртуальных машин. Не продолжайте после установки роли Hyper-V.
2. Эта статья всего до реализации.

В этом руководстве предоставляет следующие допущения о целевой среде:

1. Мы работают в [топология звезды](https://docs.microsoft.com/en-us/azure/architecture/reference-architectures/hybrid-networking/hub-spoke), с помощью наших концентратор, подключенный к ExpressRoute.
1. Нашей сети резервный назначается адресном пространстве 10.0.0.0/23, который прямую из системы на два /24 подсети.
    * 10.0.0.0/24 — подсети, где находится наших узла Hyper-V.
    * 10.0.1.0/24 — это будет «с плавающей запятой» подсети. Этого адресного пространства будет обрабатываться наших вложенных виртуальных машин и существует для обработки объявлений маршрутов вернуться к локальным.
    * Резервный подсоединена искусно называется «Звезда».

1. Наши диапазона IP-адресов сетей hub не имеет значения, но знать, что она называется «Hub».
1. Наши Hyper-V, назначается адрес 10.0.0.4/24.
1. У нас есть DNS-сервера в 10.0.0.10/24, это не является обязательным, но допущение наших пошагового руководства.

## <a name="high-level-overview-of-what-were-doing-and-why"></a>Высокий уровень Обзор нам делать и преимущества

* Фон: Вложенные виртуальные машины будут не предоставляются для DHCP из подсоединена, их узла подключенном к, даже если вы настроите внутренний или внешний коммутатор. 
  * Это означает, что на узел Hyper-V необходимо предоставить DHCP.
* Мы будет выделять блок IP-адреса для использования только с узла Hyper-V.  На узел Hyper-V не учитывать назначенная аренду подсоединена, поэтому чтобы не допустить ситуаций, в котором узла назначает IP-адрес уже существовать нам необходимо выделить блок IP-адресов для использования с узла Hyper-V. Это позволит нам во избежание повторяющихся сценарий IP-адрес.
  * Блок IP-адреса, мы будет соответствовать подсеть в пределах подсоединена, находящийся на узле Hyper-V.
  * Причина, что мы хотим использовать это в соответствии с существующей подсети — обрабатывать объявления BGP назад по ExpressRoute. Если мы просто иерархическую структуру диапазон IP-адресов узла Hyper-V для использования, а затем нам нужно создать ряд статических маршрутов, чтобы клиенты могли с локальным размещением для связи с вложенных виртуальных машин. Это означает, что это не жестких требований, так как можно составляют диапазона IP-адресов для вложенных виртуальных машин и затем создать все маршруты, необходимые для направления их на узле Hyper-V для этого диапазона.
* Создайте внутренний коммутатор в Hyper-V и затем мы присвоит только что созданный интерфейс IP-адреса в диапазоне, которые мы резервируем для DHCP. Этот IP-адрес будет шлюз по умолчанию для наших вложенных виртуальных машин и можно использовать для маршрута между внутренний коммутатор и сетевой Адаптер узла, подключенном к нашей подсоединена.
* Мы установим роль Маршрутизация и удаленный доступ на узле, который будет превратить наших узла в маршрутизатор.  Это необходимо разрешить обмен данными между ресурсами внешней по отношению к узлу и наши вложенных виртуальных машин.
* Мы сообщим другими ресурсами, как получить доступ к этим вложенных виртуальных машин. Этом требуются, что мы создаем таблицу маршрутизации пользователем, которое содержит статический маршрут для диапазона IP-адресов, в котором вложенных виртуальных машин. Это статический маршрут будет указывать на IP-адрес для Hyper-V.
* Затем поместите этот UDR подсети шлюза таким образом, чтобы клиенты, поступающие от локальных знать, как связаться с нашей вложенных виртуальных машин.
* Этот UDR будет поместить в другой подсети в Azure, что требует наличия подключения к вложенных виртуальных машин.
* Для нескольких узлов Hyper-V необходимо создать дополнительные «с плавающей запятой» подсети и добавьте числу статических маршрутов UDR.
* При списании узлом Hyper-V можно будет delete/переназначения наших «с плавающей запятой» подсети и удалить этот статический маршрут из наших UDR или если это последнее узла Hyper-V, UDR полностью удалить.

## <a name="creating-our-virtual-switch"></a>Создание наших виртуального коммутатора

1. Откройте PowerShell в режиме администратора.
2. Создание внутреннего коммутатора: `New-VMSwitch -Name "NestedSwitch" -SwitchType Internal`
3. Назначение только что созданный интерфейс IP-адрес: `New-NetIPAddress –IPAddress 10.0.1.1 -PrefixLength 24 -InterfaceAlias "vEthernet (NestedSwitch)"`

## <a name="install-and-configure-dhcp"></a>Установка и настройка DHCP

*Многие люди пропущены этого компонента, если они сначала пытаются получить рабочий вложенную виртуализацию. В отличие от в локальной где вашего гостевые виртуальные машины будут получать DHCP из сети, к которой находится ваш хост, вложенных виртуальных машин в Azure необходимо предоставить DHCP через они будут выполняться виртуальных машин. Или если необходимо статически назначение IP-адреса для каждой вложенной виртуальная машина, который не является масштабируемым.*

1. Установите роль DHCP: `Install-WindowsFeature DHCP -IncludeManagementTools`
2. Создание области DHCP: `Add-DhcpServerV4Scope -Name "Nested VMs" -StartRange 10.0.1.2 -EndRange 10.0.1.254 -SubnetMask 255.255.255.0`
3. Настройте параметры DNS и шлюз по умолчанию для области: `Set-DhcpServerV4OptionValue -DnsServer 10.0.0.10 -Router 10.0.1.1`
    * Не забудьте ввода допустимые DNS-сервера. В этом случае пришлось у сервера в сети 10.0.0.0/24, которая обслуживает DNS для Windows.

## <a name="installing-remote-access"></a>Установка удаленного доступа

* Откройте диспетчер сервера и выберите «Добавить роли и компоненты».
* Выберите «Далее» до «Роли сервера».
* Проверьте «Удаленный доступ» и нажмите кнопку «Далее» до «Службы ролей».
* Проверьте «Маршрутизации», выберите «Добавить компоненты», а затем выберите «Далее», а затем «установить». Завершите работу мастера и дождитесь завершения установки.

## <a name="configuring-remote-access"></a>Настройка удаленного доступа

* Откройте диспетчер сервера и выберите «Инструменты», а затем выберите «Маршрутизация и удаленный доступ».
* В правой части панели управления Маршрутизация и удаленный доступ будет отображается значок рядом с его именем своего серверов, это щелкните правой кнопкой мыши и выберите «Настройка и включение Маршрутизация и удаленный доступ».
* В мастере выберите «Далее», наличие Радиальный кнопку «Настраиваемая конфигурация» и нажмите кнопку «Далее».
* Проверьте «NAT» и «Маршрутизации локальной сети» и затем выберите пункт «Далее» и нажмите «Готово». Если его появится запрос, чтобы запустить службу это сделать.
* Теперь перейдите к узлу «IPv4» и разверните узел «NAT» становится доступен.
* «NAT» щелкните правой кнопкой мыши, выберите «… новый интерфейс», и вы увидите с тремя вариантами. 
* Два из этих параметров, для виртуального коммутатора Hyper-V, вы должны увидеть параметр «Ethernet», выберите этот параметр. Иными словами выберите интерфейс, который подключен непосредственно к вашей подсоединена Azure.

## <a name="creating-a-route-table-within-azure"></a>Создание таблицу маршрутизации в Azure

См. в [этой статье](https://docs.microsoft.com/en-us/azure/virtual-network/tutorial-create-route-table-portal) более подробно о чтения на создание и управление ими маршруты в Azure.

* Перейдите к https://portal.azure.com.
* В верхнем левом углу выберите «Создать ресурс».
* В поле поиска введите «Таблицу маршрутизации» и введите проверки нажатия.
* Наилучших результатов будет таблицу маршрутизации, выберите этот параметр и затем выберите «Создать»
* Имя в таблицу маршрутизации, в моем случае я с именем его «Маршруты для вложенные-виртуальные машины».
* Убедитесь, что выбран той же подписки, в котором узлы Hyper-V.
* Создайте новую группу ресурсов или выберите существующий и убедитесь, что область, созданные в таблицу маршрутизации в той же области, который располагается на узле Hyper-V в.
* Выберите «Создать».

## <a name="configuring-the-route-table"></a>Настройка в таблицу маршрутизации

* Перейдите в таблицу маршрутизации, мы только что создали. Это можно сделать, выполнив поиск имени в таблицу маршрутизации на панели поиска в центре верхней части портала.
* После выбора в таблицу маршрутизации перейдите в раздел «Маршруты» из в колонке "".
* Выберите «Добавить».
* Задайте имя вашего маршрута, I пошло с «Nested-виртуальные машины».
* Для адреса префикс ввода диапазона IP-адресов для наших «с плавающей запятой» подсети. В этом случае он будет 10.0.1.0/24.
* Для «Следующего прыжка типа» выберите «Виртуального устройства», а затем введите IP-адрес для узла Hyper-V, который может быть 10.0.0.4 и нажмите кнопку «ОК».
* Теперь из в колонке выберите «Подсетей», это будет непосредственно под «Маршруты».
* Выберите «Связать», выберите нашей виртуальной сети «Hub» и нажмите кнопку «GatewaySubnet» и нажмите кнопку «ОК».
* Выполните эти же действия для подсети, наши узла Hyper-V находится на также как и в случае других подсетей, которым требуется доступ к вложенных виртуальных машин.

## <a name="conclusion"></a>Заключение

Теперь можно будет развернуть виртуальной машины (даже 32-разрядных виртуальной Машины!) в узел Hyper-V и сделать его доступным от локальных и в Azure.
