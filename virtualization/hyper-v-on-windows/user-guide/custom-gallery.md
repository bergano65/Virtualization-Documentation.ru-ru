---
title: Создание пользовательской коллекции виртуальных машин
description: Добавляйте собственные записи в коллекцию виртуальных машин в Windows 10 Creators Update и более поздних версиях.
keywords: windows 10, hyper-v, быстрое создание, виртуальная машина, коллекция
ms.author: scooley
ms.date: 05/04/2018
ms.topic: article
ms.prod: windows-10-hyperv
ms.service: windows-10-hyperv
ms.assetid: d9238389-7028-4015-8140-27253b156f37
ms.openlocfilehash: c7a6462b331f469148eb4cf5a0a2740c9929fa29
ms.sourcegitcommit: 0deb653de8a14b32a1cfe3e1d73e5d3f31bbe83b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/26/2019
ms.locfileid: "9576805"
---
# <a name="create-a-custom-virtual-machine-gallery"></a>Создание пользовательской коллекции виртуальных машин

> Windows 10 Fall Creators Update и более поздние версии.

В выпуске Fall Creators Update в средство быстрого создания была добавлена коллекция виртуальных машин.

![Быстрое создание коллекции виртуальных машин с помощью пользовательских образов](media/vmgallery.png)

Помимо набора образов, предоставленных корпорацией Майкрософт и ее партнерами, в коллекции могут отображаться ваши собственные образы.

В этой статье рассматриваются следующие действия:

* создание виртуальных машин, совместимых с коллекцией;
* создание нового источника коллекции;
* добавление пользовательского источника коллекции в коллекцию.

## <a name="gallery-architecture"></a>Архитектура коллекции

Коллекция виртуальных машин— это графическое представление набора источников виртуальных машин, определенных в реестре Windows.  Каждый источник виртуальной машины представляет собой путь (локальный путь или универсальный код ресурса) к файлу JSON с виртуальными машинами в виде элементов списка.

Список виртуальных машин в коллекции полностью включает в себя содержимое первого источника, затем следует содержимое второго источника и так далее, пока не будут перечислены все доступные виртуальные машины.  Этот список формируется динамически при каждом запуске коллекции.

![архитектура коллекции](media/vmgallery-architecture.png)

Раздел реестра: `Computer\HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Virtualization`

Имя значения: `GalleryLocations`

Тип: `REG_MULTI_SZ`

## <a name="create-gallery-compatible-virtual-machines"></a>Создание виртуальных машин, совместимых с коллекцией

Виртуальные машины в коллекции могут быть образами дисков (.iso) или виртуальными жесткими дисками (.vhdx).

Виртуальные машины на основе виртуального жесткого диска имеют определенные требования к конфигурации:

1. Создаются с поддержкой встроенного ПО UEFI. При использовании Hyper-V создается виртуальная машина 2-го поколения.
1. Емкость виртуального жесткого диска должна быть не менее 20ГБ. Следует помнить, что это максимальный размер.  Hyper-V не будет занимать место, не используемое виртуальной машиной.

### <a name="testing-a-new-vm-image"></a>Проверка нового образа виртуальной машины

Коллекция виртуальных машин создает виртуальные машины с помощью того же механизма, что и при установке из локального источника установки.

Чтобы проверить, будет ли образ виртуальной машины загружаться и работать, сделайте следующее:

1. Откройте коллекцию виртуальных машин (функция "Быстрое создание" в Hyper-V) и выберите **Локальный источник установки**.
  ![Кнопка для использования локального источника установки](media/use-local-source.png)
1. Выберите **Изменить источник установки**.
  ![Кнопка для использования локального источника установки](media/change-source.png)
1. Выберите формат, который будет использоваться в коллекции: .iso или .vhdx.
1. Если используется образ Linux, отключите параметр "Безопасная загрузка".
  ![Кнопка для использования локального источника установки](media/toggle-secure-boot.png)
1. Создайте виртуальную машину.  Если виртуальная машина загружается без ошибок, ее можно добавить в коллекцию.

## <a name="build-a-new-gallery-source"></a>Создание нового источника коллекции

Следующий шаг — создание нового источника коллекции.  Это файл JSON, в котором перечислены виртуальные машины и содержатся все дополнительные сведения, отображаемые в коллекции.

Текстовые сведения:

![Отмеченные места расположения текста в коллекции](media/gallery-text.png)

* **Имя**: обязательно. Это имя, отображаемое в левом столбце и в верхней части представления виртуальной машины.
* **Издатель**: обязательно.
* **Описание**: обязательно. Список строк с описанием виртуальной машины.
* **Версия**: обязательно
* Последнее изменение: по умолчанию указывается понедельник, 1 января 0001г.

  Требуемый формат: гггг-мм-ддTчч:мм:ссZ

  Следующая команда PowerShell помещает текущую дату в правильном формате в буфер обмена:

  ``` PowerShell
  Get-Date -UFormat "%Y-%m-%dT%TZ" | clip.exe
  ```

* Локаль: по умолчанию значение остается пустым.

Изображения:

![Отмеченные места расположения изображений в коллекции](media/gallery-pictures.png)

* **Логотип**: обязательно
* Символ
* Эскиз

И, наконец, виртуальная машина (в формате .iso или .vhdx).

Чтобы создать хэши паролей, можно использовать следующую команду powershell:

  ``` PowerShell
  Get-FileHash -Path .\TMLogo.jpg -Algorithm SHA256
  ```

В следующем шаблоне JSON присутствуют начальные элементы и схема коллекции.  При редактировании в VSCode будет автоматически предоставлена функция IntelliSense.

[!code-json[main](../../../hyperv-tools/vmgallery/vm-gallery-template.json)]

## <a name="connect-your-gallery-to-the-vm-gallery-ui"></a>Подключение коллекции к пользовательскому интерфейсу коллекции виртуальных машин

Добавить пользовательский источник коллекции в коллекцию виртуальных машин проще всего через редактор реестра.

1. Откройте файл **regedit.exe**
1. Перейдите к `Computer\HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Virtualization\`
1. Найдите элемент `GalleryLocations`.

    Если он уже существует, откройте меню **Изменить** и **измените** его.

    Если он еще не существует, откройте меню **Изменить** и перейдите к пункту **Создать** > **Мультистроковый параметр**

1. Добавьте коллекцию в раздел реестра `GalleryLocations`.

    ![Раздел реестра коллекций с новым элементом](media/new-gallery-uri.png)

## <a name="troubleshooting"></a>Поиск и устранение неисправностей

### <a name="check-for-errors-loading-gallery"></a>Проверка наличия ошибок при загрузке коллекции

Коллекция виртуальных машин не предоставляет отчеты об ошибках в средстве просмотра событий Windows.  Для проверки наличия ошибок сделайте следующее:

1. Откройте средство просмотра событий
1. Перейдите в раздел **Журналы Windows** -> **Приложение**
1. Найдите события от Source VMCreate.

## <a name="resources"></a>Ресурсы

На GitHub ([ссылка](https://github.com/MicrosoftDocs/Virtualization-Documentation/tree/live/hyperv-tools/vmgallery)) есть ряд сценариев и вспомогательных средств для коллекций.

Ознакомьтесь с примером записи коллекции [здесь](https://go.microsoft.com/fwlink/?linkid=851584).  Это файл JSON, определяющий встроенную коллекцию.
