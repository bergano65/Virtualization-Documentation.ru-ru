---
title: "Вложенная виртуализация"
description: "Вложенная виртуализация"
keywords: windows10, hyper-v
author: theodthompson
ms.date: 06/20/2016
ms.topic: article
ms.prod: windows-10-hyperv
ms.service: windows-10-hyperv
ms.assetid: 68c65445-ce13-40c9-b516-57ded76c1b15
ms.openlocfilehash: 6f3cc3edb42a063abed33c7783e4a8bf13324cda
ms.sourcegitcommit: 456485f36ed2d412cd708aed671d5a917b934bbe
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/08/2017
---
# <a name="run-hyper-v-in-a-virtual-machine-with-nested-virtualization"></a>Запуск Hyper-V в виртуальной машине со вложенной виртуализацией

Вложенная виртуализация— это компонент, который позволяет запускать Hyper-V в виртуальной машине Hyper-V. Другими словами, с помощью вложенной виртуализации можно виртуализировать сам узел Hyper-V. К вариантам использования вложенной виртуализации можно отнести запуск контейнера Hyper-V на виртуализированном узле контейнеров, настройку лаборатории Hyper-V в виртуализированной среде или тестирование сценариев для нескольких компьютеров без необходимости использования дополнительного оборудования. В этом документе подробно описываются требования к программному обеспечению и оборудованию, действия по настройке и ограничения. 

## <a name="prerequisites"></a>Необходимые компоненты

- Узел Hyper-V под управлением Windows Server2016 или Windows10 с юбилейным обновлением.
- Виртуальная машина Hyper-V под управлением Windows Server2016 или Windows10 с юбилейным обновлением.
- Виртуальная машина Hyper-V с версией конфигурации8.0 или более высокой.
- Процессор Intel с технологиями VT-x и EPT.

## <a name="configure-nested-virtualization"></a>Настройка вложенной виртуализации

1. Создание виртуальной машины. Необходимые версии ОС и виртуальных машин см. в предварительных требованиях выше.
2. Пока виртуальная машина находится в отключенном состоянии, запустите следующую команду на физическом узле Hyper-V. В виртуальной машине будет включена вложенная виртуализация.

```
Set-VMProcessor -VMName <VMName> -ExposeVirtualizationExtensions $true
```
3. запустите ее.
4. Установите Hyper-V в виртуальной машине так же, как на физическом сервере. Дополнительные сведения об установке Hyper-V см. в разделе [Установка Hyper-V](../quick-start/enable-hyper-v.md).

## <a name="disable-nested-virtualization"></a>Отключение вложенной виртуализации
Вы можете отключить вложенную виртуализацию в остановленной виртуальной машине следующей командой PowerShell:
```
Set-VMProcessor -VMName <VMName> -ExposeVirtualizationExtensions $false
```

## <a name="dynamic-memory-and-runtime-memory-resize"></a>Изменение размера динамической памяти и памяти для среды выполнения
При запуске Hyper-V в виртуальной машине в ней должна быть отключена настройка памяти. Это означает, что даже если динамическая память включена, ее объем не будет изменяться. Для виртуальных машин без динамической памяти все попытки изменить объем памяти включенной машины завершатся сбоем. 

Обратите внимание, что само включение вложенной виртуализации не повлияет на изменение размера динамической памяти или памяти для среды выполнения. Несовместимость происходит, только если Hyper-V выполняется в виртуальной машине.

## <a name="networking-options"></a>Параметры сетей
Существуют два параметра для сетей со вложенными виртуальными машинами: спуфинг MAC-адресов и режим NAT.

### <a name="mac-address-spoofing"></a>Спуфинг MAC-адресов
Чтобы сетевые пакеты перенаправлялись через два виртуальных коммутатора, необходимо включить спуфинг MAC-адресов на первом уровне виртуального коммутатора. Это можно сделать с помощью следующей команды PowerShell.

```
Get-VMNetworkAdapter -VMName <VMName> | Set-VMNetworkAdapter -MacAddressSpoofing On
```
### <a name="network-address-translation"></a>Преобразование сетевых адресов
Второй параметр связан с преобразованием сетевых адресов (NAT). Этот подход рекомендуется для случаев, когда спуфинг MAC-адресов невозможен, например в общедоступной облачной среде.

Сначала необходимо создать виртуальный коммутатор NAT в виртуальной машине узла ("средняя" виртуальная машина). Обратите внимание, что IP-адреса приведены только в качестве примера и будут разниться в зависимости от сред:
```
New-VMSwitch -Name VmNAT -SwitchType Internal
New-NetNat –Name LocalNAT –InternalIPInterfaceAddressPrefix “192.168.100.0/24”
```
Далее назначьте IP-адрес для сетевого адаптера:
```
Get-NetAdapter "vEthernet (VmNat)" | New-NetIPAddress -IPAddress 192.168.100.1 -AddressFamily IPv4 -PrefixLength 24
```
Каждая вложенная виртуальная машина должна иметь назначенный IP-адрес и шлюз. Обратите внимание, что IP-адрес шлюза должен указывать на адаптер NAT из предыдущего действия. Можно также назначить DNS-сервер:
```
Get-NetAdapter "Ethernet" | New-NetIPAddress -IPAddress 192.168.100.2 -DefaultGateway 192.168.100.1 -AddressFamily IPv4 -PrefixLength 24
Netsh interface ip add dnsserver “Ethernet” address=<my DNS server>
```

## <a name="3rd-party-virtualization-apps"></a>Сторонние приложения виртуализации
Приложения виртуализации, отличные от Hyper-V, не поддерживаются в виртуальных машинах Hyper-V и скорее всего приведут к сбою. Сюда входит любое программное обеспечение, требующее расширений виртуализации оборудования.
